<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WARISHAYDAY - ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° Hay Day</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600&family=IBM+Plex+Sans+Thai:wght@300;400;500;600&family=Mali:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600&family=Taviraj:wght@300;400;500;600&family=Trirong:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #28a745;
            --secondary-color: #ffc107;
            --background-color: #f0f2f5;
            --surface-color: #ffffff;
            --text-color: #333;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --hover-shadow: 0 4px 12px rgba(0,0,0,0.15);
            --global-font: 'Kanit', sans-serif;
        }

        /* Dark Mode */
        body.dark-mode {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --shadow: 0 4px 8px rgba(0,0,0,0.5);
            --hover-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        body.dark-mode .card,
        body.dark-mode .tab,
        body.dark-mode .admin-menu .btn,
        body.dark-mode .modal-content,
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea,
        body.dark-mode .stat-card,
        body.dark-mode .top-selling-list li,
        body.dark-mode .price-list li,
        body.dark-mode .reorder-list li,
        body.dark-mode .search-modal-result-item,
        body.dark-mode .low-stock-list li {
            background-color: var(--surface-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        body.dark-mode .admin-menu .btn {
            background-color: #333;
            color: #ccc;
        }
        body.dark-mode .admin-menu .btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        body.dark-mode .tax-results {
            background-color: #2e7d32;
            color: #fff;
        }
        body.dark-mode .tax-results h3 {
            color: #e0e0e0;
        }
        body.dark-mode .tax-results strong {
            color: #fff;
        }
        body.dark-mode .btn-secondary,
        body.dark-mode .tab {
            color: var(--text-color);
        }
        body.dark-mode .tab.active,
        body.dark-mode .btn-secondary:hover {
            color: white;
        }
        body.dark-mode #admin-gear-icon,
        body.dark-mode #back-to-admin-btn {
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        body.dark-mode .slider {
            background-color: #555;
        }
        body.dark-mode .slider:before {
            background-color: #ccc;
        }
        body.dark-mode input:checked + .slider {
            background-color: var(--primary-color);
        }
        body.dark-mode #reset-cart-btn {
            background: none;
        }
        body.dark-mode #order-details,
        body.dark-mode #cart-details {
            background-color: #2a2a2a;
        }
        body.dark-mode #font-preview {
            color: var(--text-color);
        }
        body.dark-mode .search-input-container .search-btn {
            background: #333;
        }
        body.dark-mode .search-modal-result-item:hover {
            background-color: #3a3a3a;
        }
        body.dark-mode .effect-controls {
            background-color: #2a2a2a;
            border-color: #333;
        }
        

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--global-font);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2, h3, h4 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        h1 {
            font-size: 2.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        #slogan {
            text-align: center;
            font-size: 1.2rem;
            margin-top: -15px;
            margin-bottom: 20px;
            color: #6c757d;
        }

        .view { display: none; }
        .view.active { display: block; }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
            font-family: var(--global-font);
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #218838; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .btn-secondary { background-color: var(--secondary-color); color: #333; }
        .btn-secondary:hover { background-color: #e0a800; }

        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-small { padding: 5px 10px; font-size: 0.9rem; }
        .btn-reset { background-color: var(--danger-color); padding: 5px 12px; font-size: 0.9rem; }
        .btn-reset:hover { background-color: #c82333; }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input[type="text"], input[type="number"], input[type="password"], input[type="url"], input[type="email"], select, input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--global-font);
            margin-bottom: 10px;
            background-color: var(--surface-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }

        #category-tabs, .tab-group-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            transition: border-color 0.3s;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .tab:hover { background-color: #ced4da; }
        .tab.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .tab img { width: 24px; height: 24px; }
        .tab.sortable { cursor: grab; }
        .tab.sortable:active { cursor: grabbing; }

        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            transition: border-color 0.3s;
        }
        th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            position: sticky;
            top: 0;
            z-index: 1;
            transition: background-color 0.3s;
        }
        body.dark-mode th {
            background-color: #2a2a2a;
        }

        td img { width: 32px; height: 32px; vertical-align: middle; margin-right: 10px; }
        .quantity-controls { 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            gap: 5px; 
        }
        .quantity-controls .btn { padding: 5px 12px; }
        .quantity-display { font-weight: 600; min-width: 30px; text-align: center; }

        #order-summary {
            margin-top: 20px;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #order-validation-message {
            color: var(--danger-color);
            font-weight: 500;
            min-height: 24px;
        }
        .order-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-content h2 { margin-bottom: 15px; text-align: left;}
        #order-details, #cart-details {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            text-align: left;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .modal-actions { text-align: center; }
        .modal .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #aaa;
        }
        .modal .close-btn:hover { color: #555; }
        .reset-btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .price-list-modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .price-list-modal-content label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .price-list-modal-content input[type="number"] {
            width: 100px;
            margin-left: 15px;
        }
        .price-list-modal-content hr {
            margin: 15px 0;
        }

        #admin-login-view {
            max-width: 400px;
            margin: 50px auto;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .admin-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .admin-menu .btn {
            background-color: #e9ecef;
            color: var(--text-color);
        }
        .admin-menu .btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        .admin-section { margin-bottom: 30px; }
        .admin-section h2 { text-align: left; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .admin-section h3 { text-align: left; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        
        .icon-preview {
            display: block;
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border-color);
        }
        
        .logo-preview-container {
            width: 150px;
            height: 150px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
        }
        #logo-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .color-palette .color-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .frame-selector img {
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .frame-selector img:hover, .frame-selector img.active {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        #search-box {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        #font-preview {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s, text-shadow 0.3s;
        }

        #customer-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        #shop-logo-display {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
            margin: 0 auto;
        }

        #header-title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin: 0 auto;
        }
        
        .floating-buttons-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            gap: 10px;
        }

        #admin-gear-icon, #back-to-admin-btn, #theme-toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, background-color 0.3s;
            padding: 5px;
            background-color: var(--surface-color);
            box-shadow: var(--shadow);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #admin-gear-icon:hover {
            transform: rotate(30deg);
            color: var(--primary-color);
        }
        #admin-gear-icon:active, #back-to-admin-btn:active, #theme-toggle-btn:active {
            transform: scale(0.95);
        }

        #back-to-admin-btn {
            display: none;
        }
        #theme-toggle-btn {
            font-size: 1.2rem;
            color: #ffc107;
            display: none;
        }
        body.dark-mode #theme-toggle-btn {
            color: var(--secondary-color);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
        }
        .stat-card .icon { font-size: 2rem; margin-bottom: 10px; }
        .stat-card h3 { font-size: 1.2rem; color: #6c757d; margin-bottom: 5px; }
        .stat-card .value { font-size: 2rem; font-weight: 600; }
        .stat-card .change { font-size: 0.9rem; margin-top: 5px; }
        .stat-card .change.positive { color: var(--success-color); }
        .stat-card .change.negative { color: var(--danger-color); }
        
        #monthly-profit, #daily-orders, #monthly-orders, #yearly-sales {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .chart-container {
            height: 300px;
            width: 100%;
        }
        .top-selling-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .top-selling-list li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-selling-list li:last-child { border-bottom: none; }
        .top-selling-list li span:first-child { font-weight: 600; }
        
        #product-list-container {
            position: relative;
        }

        .customer-reset-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .customer-reset-btn:hover {
            transform: scale(1.1);
        }
        
        #stock-management-view .admin-section h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-list {
            list-style-type: none;
            padding: 0;
        }
        .price-list li {
            margin-bottom: 5px;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .tax-results {
            margin-top: 20px;
            padding: 20px;
            background-color: #f1f8e9;
            border-left: 5px solid #66bb6a;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
        }
        .tax-results h3 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 10px;
            text-align: left;
            transition: color 0.3s;
        }
        .tax-results p {
            margin: 5px 0;
        }
        .tax-results strong {
            color: #1b5e20;
            transition: color 0.3s;
        }

        .reorder-list {
            list-style-type: none;
            padding: 0;
        }
        .reorder-list li {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .reorder-list li.dragging {
            opacity: 0.5;
            border-style: dashed;
        }
        .reorder-list li .handle {
            font-size: 1.5rem;
            color: #6c757d;
            cursor: grab;
        }
        .menu-btn {
            flex-shrink: 0;
        }

        .search-input-container {
            position: relative;
            display: flex;
        }
        .search-input-container input {
            padding-right: 45px;
        }
        .search-input-container .search-btn {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 11px;
            width: 40px;
            border: none;
            background: #e9ecef;
            cursor: pointer;
            border-radius: 0 8px 8px 0;
            font-size: 1.2rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #search-modal-results {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 10px;
        }
        .search-modal-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .search-modal-result-item:last-child {
            border-bottom: none;
        }
        .search-modal-result-item:hover {
            background-color: #f8f9fa;
        }

        .effect-controls {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }
        .effect-controls label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .effect-controls input[type="range"] {
            margin: 0;
        }
        .effect-control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .low-stock-list {
            list-style: none;
            padding: 0;
        }
        .low-stock-list li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @keyframes blink { 50% { opacity: 0.2; } }
        .blinking-warning::before {
            content: 'üî¥';
            margin-right: 8px;
            animation: blink 1.2s linear infinite;
        }
        #top-items-controls .btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        #top-items-controls .btn {
            background-color: #e9ecef;
            color: var(--text-color);
        }
        .tax-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .performance-bar {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .performance-bar-inner {
            height: 100%;
            border-radius: 5px;
        }
        .performance-bar-inner.good { background-color: var(--success-color); }
        .performance-bar-inner.bad { background-color: var(--danger-color); }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 2rem; }
            .btn { width: 100%; }
            .quantity-controls .btn { width: auto; }
            .admin-header { flex-direction: column; align-items: stretch; }
            .order-buttons { flex-direction: column; }
            .floating-buttons-container {
                top: 10px;
                right: 10px;
                gap: 5px;
            }
            #admin-gear-icon, #back-to-admin-btn, #theme-toggle-btn {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
            #customer-view-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            th, td { padding: 8px 10px; font-size: 0.9rem; }
            td img { width: 24px; height: 24px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            table { min-width: 100%; }
            #category-tabs, .admin-menu {
                justify-content: center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <!-- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) -->
    <div class="floating-buttons-container">
        <button id="admin-gear-icon" style="display: block;">‚öôÔ∏è</button>
        <button id="back-to-admin-btn" style="display: none;">‚öôÔ∏è</button>
        <button id="theme-toggle-btn" style="display: none;">‚òÄÔ∏è</button>
    </div>

    <div class="container">
        <div id="customer-view" class="view active">
            <div id="customer-view-header">
                <header>
                    <div id="header-title-container">
                        <img id="shop-logo-display" src="" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô" style="display: none;">
                        <h1 id="shop-name-display">WARISHAYDAY</h1>
                    </div>
                    <p id="slogan"></p>
                </header>
            </div>
            
            <main>
                <div id="category-tabs" class="card"></div>
                <input type="text" id="search-box" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                <div id="product-list-container" class="card">
                    <button id="reset-cart-btn" class="customer-reset-btn">üóëÔ∏è</button>
                    <h2 id="current-category-name"></h2>
                    <div class="table-wrapper">
                        <table id="product-table">
                            <thead>
                                <tr>
                                    <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th>‡πÄ‡∏•‡πÄ‡∏ß‡∏•</th>
                                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="product-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="order-summary" class="card">
                    <div id="order-validation-message"></div>
                    <div class="order-buttons">
                        <button id="view-order-btn" class="btn btn-secondary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                        <button id="confirm-order-btn" class="btn btn-primary">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                    </div>
                </div>
            </main>
        </div>

        <div id="admin-login-view" class="view">
            <div class="card">
                <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
                <div class="form-group">
                    <label for="pin-input">PIN</label>
                    <input type="password" id="pin-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN">
                </div>
                <button id="login-btn" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p id="login-error" style="color: var(--danger-color); margin-top: 10px;"></p>
            </div>
        </div>
        
        <div id="admin-panel-view" class="view">
            <div class="admin-header">
                <h2>Admin Panel</h2>
                <div style="display:flex; gap: 10px;">
                    <button id="view-shop-btn" class="btn btn-secondary">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
                    <button id="logout-btn" class="btn btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
            <div class="admin-menu">
            </div>

            <div id="admin-menu-admin" class="admin-menu-content">
                <div class="card admin-section">
                    <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
                    <div class="form-group">
                        <label for="shop-name">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" id="shop-name" placeholder="WARISHAYDAY">
                    </div>
                    <div class="form-group">
                        <label for="shop-slogan">‡∏™‡πÇ‡∏•‡πÅ‡∏Å‡∏ô‡∏£‡πâ‡∏≤‡∏ô</label>
                        <input type="text" id="shop-slogan" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏ß ‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå">
                    </div>
                     <div class="form-group">
                        <label for="shop-global-font">‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <select id="shop-global-font"></select>
                    </div>
                    <div class="form-group">
                        <label for="shop-font">‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                        <select id="shop-font"></select>
                        <div id="font-preview" style="font-family: 'Kanit', sans-serif;">WARISHAYDAY</div>
                    </div>

                    <div class="form-group">
                        <div class="toggle-switch-container">
                            <label>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="effect-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="effect-controls" id="effect-controls-container" style="display: none;">
                            <label>‡πÄ‡∏á‡∏≤‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (X) <input type="range" id="effect-offset-x" min="-10" max="10" value="2"></label>
                            <label>‡πÄ‡∏á‡∏≤‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (Y) <input type="range" id="effect-offset-y" min="-10" max="10" value="2"></label>
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏•‡∏≠ <input type="range" id="effect-blur" min="0" max="20" value="4"></label>
                            <div class="effect-control-item">
                                <label for="effect-color">‡∏™‡∏µ‡πÄ‡∏á‡∏≤</label>
                                <input type="color" id="effect-color" value="#000000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="order-format-select">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</label>
                        <select id="order-format-select">
                            <option value="format1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: WHD68/08/0001</option>
                            <option value="format2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: WHD-20250820-0001</option>
                            <option value="format3">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: WHD-12345</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="toggle-switch-container">
                            <label>‡πÉ‡∏ä‡πâ‡πÇ‡∏•‡πÇ‡∏Å‡πâ</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="logo-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <label for="logo-upload">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ (PNG)</label>
                        <input type="file" id="logo-upload" accept="image/png">
                        <div class="logo-preview-container">
                            <img id="logo-preview" src="" alt="‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÇ‡∏•‡πÇ‡∏Å‡πâ" style="display: none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‡∏ò‡∏µ‡∏°‡∏™‡∏µ (Theme)</label>
                        <div class="color-palette">
                            <button class="btn btn-small color-btn" data-color="#28a745" style="background-color:#28a745;"></button>
                            <button class="btn btn-small color-btn" data-color="#007bff" style="background-color:#007bff;"></button>
                            <button class="btn btn-small color-btn" data-color="#6c757d" style="background-color:#6c757d;"></button>
                            <button class="btn btn-small color-btn" data-color="#17a2b8" style="background-color:#17a2b8;"></button>
                            <button class="btn btn-small color-btn" data-color="#ffc107" style="background-color:#ffc107;"></button>
                            <button class="btn btn-small color-btn" data-color="#dc3545" style="background-color:#dc3545;"></button>
                            <button class="btn btn-small color-btn" data-color="#343a40" style="background-color:#343a40;"></button>
                            <button class="btn btn-small color-btn" data-color="#6610f2" style="background-color:#6610f2;"></button>
                            <button class="btn btn-small color-btn" data-color="#e83e8c" style="background-color:#e83e8c;"></button>
                            <button class="btn btn-small color-btn" data-color="#fd7e14" style="background-color:#fd7e14;"></button>
                            <button class="btn btn-small color-btn" data-color="#20c997" style="background-color:#20c997;"></button>
                            <button class="btn btn-small color-btn" data-color="#f8f9fa" style="background-color:#f8f9fa; border: 1px solid #ccc;"></button>
                        </div>
                    </div>

                    <div class="form-group" id="license-key-section" style="display: none;">
                        <label for="license-key-display">License Key</label>
                        <input type="text" id="license-key-display" readonly>
                        <p id="license-expiry-display"></p>
                    </div>

                    <button id="save-settings-btn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>

                <div class="card admin-section" id="admin-pin-section">
                    <h2>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
                    <div class="form-group">
                        <label for="new-pin">PIN ‡πÉ‡∏´‡∏°‡πà</label>
                        <input type="password" id="new-pin" placeholder="‡∏Å‡∏£‡∏≠‡∏Å PIN ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß">
                    </div>
                    <button id="change-pin-btn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PIN ‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>

            <div id="admin-menu-stock" class="admin-menu-content" style="display: none;">
                <div class="card admin-section">
                    <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                    <form id="category-form">
                        <input type="hidden" id="cat-id">
                        <div class="form-group">
                            <label for="cat-name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <div class="search-input-container">
                                <input type="text" id="cat-name" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ üîç" required>
                                <button type="button" class="search-btn" data-type="category">üîç</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cat-icon-upload">‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÑ‡∏ü‡∏•‡πå PNG)</label>
                            <input type="file" id="cat-icon-upload" accept="image/png">
                            <div id="cat-icon-preview" class="icon-preview" style="background-image: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                            <div class="btn-group">
                                <button type="button" id="set-per-piece-price-btn" class="btn btn-info">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô</button>
                            </div>
                        </div>
                        <button type="submit" id="submit-cat-btn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
                        <button type="button" id="cancel-cat-edit-btn" class="btn btn-secondary" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                    <hr style="margin: 20px 0;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                    <div class="table-wrapper">
                        <table id="admin-cat-table">
                            <thead><tr><th>‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö</th></tr></thead>
                            <tbody id="admin-cat-list"></tbody>
                        </table>
                    </div>
                </div>
            
                <div class="card admin-section">
                    <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="prod-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <div class="search-input-container">
                                <input type="text" id="prod-name" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ üîç" required>
                                <button type="button" class="search-btn" data-type="product">üîç</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="prod-level">‡πÄ‡∏•‡πÄ‡∏ß‡∏•</label>
                            <input type="number" id="prod-level" required>
                        </div>
                        <div class="form-group">
                            <label for="prod-category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="prod-category" required></select>
                        </div>
                        <div class="form-group">
                            <label for="prod-icon-upload">‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏ü‡∏•‡πå PNG)</label>
                            <input type="file" id="prod-icon-upload" accept="image/png">
                            <div id="prod-icon-preview" class="icon-preview" style="background-image: none;"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </form>
                    <hr style="margin: 20px 0;">
                    <div id="admin-product-tabs" class="card"></div>
                    <h3 id="admin-current-category-name"></h3>
                    <div class="table-wrapper">
                        <table id="admin-prod-table">
                            <thead><tr><th>‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏•‡πÄ‡∏ß‡∏•</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö</th></tr></thead>
                            <tbody id="admin-prod-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-menu-database" class="admin-menu-content" style="display: none;">
                <div class="card admin-section">
                    <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h2>
                    <form id="db-category-form">
                        <input type="hidden" id="db-cat-id">
                        <div class="form-group">
                            <label for="db-cat-name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <input type="text" id="db-cat-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠, ‡∏Ç‡∏¢‡∏≤‡∏¢, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ" required>
                        </div>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
                        <button type="button" id="cancel-db-cat-edit-btn" class="btn btn-secondary" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                    <hr style="margin: 20px 0;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h3>
                    <div class="table-wrapper">
                        <table id="db-cat-table">
                            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="db-cat-list"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card admin-section">
                    <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h2>
                    <div id="db-item-tabs" class="card tab-group-container"></div>
                    <form id="db-item-form" style="display: none;">
                        <input type="hidden" id="db-item-id">
                        <div class="form-group">
                            <label for="db-item-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <input type="text" id="db-item-name" required>
                        </div>
                        <div class="form-group">
                            <label for="db-item-level">‡πÄ‡∏•‡πÄ‡∏ß‡∏•</label>
                            <input type="number" id="db-item-level" required>
                        </div>
                        <div class="form-group">
                            <label for="db-item-quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</label>
                            <input type="number" id="db-item-quantity" value="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                        <button type="button" id="cancel-db-item-edit-btn" class="btn btn-secondary" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                    <hr id="db-item-hr" style="margin: 20px 0; display: none;">
                    <h3 id="db-current-category-name">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                    <div class="table-wrapper">
                        <table id="db-item-table">
                            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏•‡πÄ‡∏ß‡∏•</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="db-item-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-menu-order-number" class="admin-menu-content" style="display: none;">
                 <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap;">
                    <label for="order-date-picker">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="text" id="order-date-picker" style="width: 150px;" placeholder="‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                    <button id="reset-orders-btn" class="btn btn-danger btn-small">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div class="card admin-section">
                    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
                    <div class="table-wrapper">
                        <table id="active-orders-table">
                            <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="active-orders-list"></tbody>
                        </table>
                    </div>
                </div>
                 <div class="card admin-section">
                    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h2>
                    <div class="table-wrapper">
                        <table id="cancelled-orders-table">
                            <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="cancelled-orders-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-menu-dashboard" class="admin-menu-content" style="display: none;">
                <h2>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap;">
                    <label for="date-picker">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="text" id="date-picker" style="width: 150px;">
                    <button id="reset-analytics-btn" class="btn btn-danger btn-small">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                
                <div class="dashboard-grid">
                    <div class="stat-card" style="background-color: var(--success-color); color: white;">
                        <h3>‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="value" id="monthly-profit">0 ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="stat-card" style="background-color: var(--info-color); color: white;">
                        <h3>‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="value" id="daily-orders">0</div>
                    </div>
                    <div class="stat-card" style="background-color: var(--warning-color); color: #333;">
                        <h3>‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="value" id="monthly-orders">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏õ‡∏µ‡∏ô‡∏µ‡πâ)</h3>
                        <div class="value" id="yearly-sales">0 ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                </div>

                 <div class="dashboard-grid">
                    <div class="card admin-section">
                        <h2>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° (10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö)</h2>
                        <p>‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö</p>
                        <ol id="low-stock-list" class="low-stock-list"></ol>
                    </div>
                    <div class="card admin-section">
                        <h2>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                        <div class="chart-container"><canvas id="categorySalesChart"></canvas></div>
                    </div>
                </div>

                <div class="card admin-section">
                    <h2>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (Top 5)</h2>
                    <div id="top-items-controls" class="btn-group" style="justify-content: center; margin-bottom: 15px;">
                        <button class="btn btn-small" data-period="day">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                        <button class="btn btn-small" data-period="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                        <button class="btn btn-small" data-period="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
                    </div>
                    <ol id="top-items-list" class="top-selling-list"></ol>
                </div>
                
                <div class="card admin-section">
                    <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                    <p id="most-active-day"></p>
                    <p id="most-active-time"></p>
                    <div class="chart-container"><canvas id="dailyTrafficChart"></canvas></div>
                </div>

                <div class="card admin-section">
                    <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á)</h2>
                    <p id="best-selling-product"></p>
                    <p id="least-selling-product"></p>
                    <div class="chart-container"><canvas id="productSalesChart"></canvas></div>
                </div>
            </div>

            <div id="admin-menu-manage-account" class="admin-menu-content" style="display: none;">
                <div class="card admin-section">
                    <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
                    <p>‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 20 ‡∏Ñ‡∏ô</p>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <form id="sub-admin-form" style="flex-grow: 1;">
                            <input type="hidden" id="sub-admin-id">
                            <div class="form-group">
                                <label for="sub-admin-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                                <input type="text" id="sub-admin-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô A" required>
                            </div>
                            <div class="form-group">
                                <label for="sub-admin-pin">PIN</label>
                                <input type="password" id="sub-admin-pin" placeholder="‡∏Å‡∏£‡∏≠‡∏Å PIN (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß)" required>
                            </div>
                            <button type="submit" id="add-sub-admin-btn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                            <button type="button" id="cancel-sub-admin-edit" class="btn btn-secondary" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </form>
                        <button type="button" id="view-permissions-btn" class="btn btn-info" style="font-size: 1.5rem; padding: 10px; height: 50px;">
                            <span class="view-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢</h3>
                    <div class="table-wrapper">
                        <table id="sub-admin-table">
                            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>PIN</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="sub-admin-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-menu-tax" class="admin-menu-content" style="display: none;">
                <div class="card admin-section">
                    <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
                    <div class="toggle-switch-container">
                        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:</label>
                        <span id="tax-type-label">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tax-type-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <hr>
                    <div id="tax-person-form">
                        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)</h3>
                        <div class="form-group">
                            <label for="tax-income">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ)</label>
                            <input type="number" id="tax-income" readonly>
                        </div>
                        <div class="form-group">
                            <label for="tax-expense-type">‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
                            <select id="tax-expense-type">
                                <option value="standard">‡∏´‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏≤ 60% (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100,000 ‡∏ö‡∏≤‡∏ó)</option>
                                <option value="actual">‡∏´‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</option>
                            </select>
                            <input type="number" id="tax-actual-expense" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á" style="display:none; margin-top:10px;">
                        </div>
                        <h4>‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</h4>
                        <div class="tax-grid">
                            <div class="form-group"><label>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß: <strong>60,000</strong></label></div>
                            <div class="form-group"><label for="tax-spouse">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ):</label><input type="number" id="tax-spouse" value="0" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 60,000"></div>
                            <div class="form-group"><label for="tax-child">‡∏ö‡∏∏‡∏ï‡∏£ (‡∏Ñ‡∏ô‡∏•‡∏∞ 30,000):</label><input type="number" id="tax-child" value="0" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô"></div>
                            <div class="form-group"><label for="tax-parent">‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡∏Ñ‡∏ô‡∏•‡∏∞ 30,000):</label><input type="number" id="tax-parent" value="0" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô"></div>
                            <div class="form-group"><label for="tax-insurance">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:</label><input type="number" id="tax-insurance" value="0" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100,000"></div>
                            <div class="form-group"><label for="tax-donation">‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ):</label><input type="number" id="tax-donation" value="0" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô"></div>
                        </div>
                    </div>
                     <div id="tax-juristic-form" style="display:none;">
                        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</h3>
                        <div class="form-group">
                            <label for="tax-juristic-income">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ)</label>
                            <input type="number" id="tax-juristic-income" readonly>
                        </div>
                         <div class="form-group">
                            <label for="tax-juristic-expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</label>
                            <input type="number" id="tax-juristic-expense" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
                        </div>
                    </div>
                    <button id="calculate-tax-btn" class="btn btn-primary">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ</button>
                    <div id="tax-calculation-results"></div>
                </div>
            </div>

        </div>
    </div>
    
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <h2 id="order-modal-title">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
            <p id="order-modal-prompt">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô</p>
            <div id="order-details"></div>
            <div class="modal-actions">
                <button id="copy-order-btn" class="btn btn-danger">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
                <button id="close-order-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content: space-between; align-items:center; flex-wrap: wrap;">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            </div>
            <div id="cart-details"></div>
            <div class="modal-actions">
                <button id="close-cart-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="pin-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ PIN</h2>
            <div class="form-group">
                <label for="pin-confirm-input">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                <input type="password" id="pin-confirm-input" placeholder="‡∏£‡∏´‡∏±‡∏™ PIN">
            </div>
            <p id="pin-confirm-error" style="color: var(--danger-color); margin-bottom: 15px;"></p>
            <div class="modal-actions">
                <button id="confirm-action-btn" class="btn btn-danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button id="cancel-action-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
    
    <div id="reset-confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="reset-modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <div class="form-group">
                <select id="reset-period-select">
                    <option value="day">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                    <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                    <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                    <option value="all">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="confirm-reset-btn" class="btn btn-danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button id="cancel-reset-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="license-key-modal" class="modal" style="display: none;">
         <div class="modal-content">
            <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ</h2>
            <p>License Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠ Key ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å Key ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
            <div class="form-group">
                <label for="new-license-key-input">‡∏õ‡πâ‡∏≠‡∏ô License Key ‡πÉ‡∏´‡∏°‡πà</label>
                <input type="text" id="new-license-key-input" placeholder="XXXX-XXXX-XXXX-XXXX">
            </div>
            <p id="license-key-error" style="color: var(--danger-color);"></p>
            <div class="modal-actions">
                <button id="submit-new-license-key-btn" class="btn btn-primary">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="edit-shop-modal" class="modal">
        <div class="modal-content">
            <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <form id="edit-shop-form">
                <input type="hidden" id="edit-shop-id">
                <div class="form-group">
                    <label for="edit-shop-name">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="edit-shop-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-shop-email">Email</label>
                    <input type="email" id="edit-shop-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-shop-pin">PIN</label>
                    <input type="password" id="edit-shop-pin" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" id="close-edit-shop-modal-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="enter-key-modal" class="modal">
        <div class="modal-content">
            <h2>‡∏õ‡πâ‡∏≠‡∏ô Key ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</h2>
            <p id="enter-key-shop-name"></p>
            <form id="enter-key-form">
                <input type="hidden" id="enter-key-shop-id">
                <div class="form-group">
                    <label for="new-key-input">License Key</label>
                    <input type="text" id="new-key-input" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
                    <button type="button" id="close-enter-key-modal-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>


    <div id="per-piece-price-modal" class="modal">
        <div class="modal-content price-list-modal-content">
            <h2>‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô</h2>
            <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÜ 10 ‡∏ä‡∏¥‡πâ‡∏ô</p>
            <form id="per-piece-price-form"></form>
            <hr>
            <div class="modal-actions">
                <button id="save-per-piece-price-btn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                <button id="close-per-piece-price-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="bulk-price-modal" class="modal">
        <div class="modal-content price-list-modal-content">
            <h2>‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏´‡∏°‡∏≤</h2>
            <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</p>
            <form id="bulk-price-form"></form>
            <hr>
            <div class="modal-actions">
                <button id="save-bulk-price-btn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                <button id="close-bulk-price-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="reorder-menu-modal" class="modal">
        <div class="modal-content">
            <h2>‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏ô‡∏π</h2>
            <p>‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
            <ul id="reorder-menu-list" class="reorder-list"></ul>
            <div class="modal-actions">
                <button id="save-menu-order-btn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á</button>
                <button id="close-reorder-menu-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
    
    <div id="permission-modal" class="modal">
        <div class="modal-content">
            <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2>
            <p id="permission-user-name" style="font-weight: bold;"></p>
            <ul id="permission-list" style="list-style: none; padding: 0;"></ul>
            <hr>
            <div class="modal-actions">
                <button id="save-permissions-btn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                <button id="close-permission-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal">
        <div class="modal-content">
            <h2 id="search-modal-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
            <input type="text" id="search-modal-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
            <div id="search-modal-results"></div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button id="close-search-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ==================================================================
        // START: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API
        // ==================================================================

        // URL ‡∏Ç‡∏≠‡∏á Netlify Functions (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° Endpoint ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const API_ENDPOINT = '/.netlify/functions/data';

        let appData = {
            categories: [],
            products: [],
            database: [],
            cart: {},
            adminPin: '210406',
            subAdmins: [],
            shopSettings: {
                shopName: "WARISHAYDAY",
                slogan: "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° Hay Day",
                themeColor: "#28a745",
                fontFamily: "'Kanit', sans-serif",
                globalFontFamily: "'Kanit', sans-serif",
                orderNumberFormat: 'format1',
                orderNumberCounters: { format1: 1, format2: 1, format3: 1 },
                licenseKey: null,
                subscriptionExpires: null,
                logo: null,
                useLogo: false,
                darkMode: false,
                shopNameEffect: {
                    enabled: false,
                    offsetX: 2,
                    offsetY: 2,
                    blur: 4,
                    color: '#000000'
                }
            },
            analytics: {
                dailyTraffic: Array(7).fill(0),
                hourlyTraffic: Array(24).fill(0),
                productSales: {},
                orders: [],
                totalSales: 0,
                monthlyProfit: 0
            },
            menuOrder: [
                'admin', 'database', 'stock', 'order-number', 'dashboard', 'manage-account', 'tax'
            ]
        };

        const FONT_OPTIONS = [
            { name: "Kanit", value: "'Kanit', sans-serif" },
            { name: "Chakra Petch", value: "'Chakra Petch', sans-serif" },
            { name: "IBM Plex Sans Thai", value: "'IBM Plex Sans Thai', sans-serif" },
            { name: "Sarabun", value: "'Sarabun', sans-serif" },
            { name: "Prompt", value: "'Prompt', sans-serif" },
            { name: "Mali", value: "'Mali', sans-serif" },
            { name: "Anuphan", value: "'Anuphan', sans-serif" },
            { name: "Taviraj", value: "'Taviraj', serif" },
            { name: "Trirong", value: "'Trirong', serif" },
            { name: "Srisakdi", value: "'Srisakdi', cursive" },
            { name: "Fahkwang", value: "'Fahkwang', cursive" },
            { name: "Kufam", value: "'Kufam', sans-serif" },
            { name: "Cormorant Garamond", value: "'Cormorant Garamond', serif" },
            { name: "Playfair Display", value: "'Playfair Display', serif" },
            { name: "Oswald", value: "'Oswald', sans-serif" },
            { name: "Lato", value: "'Lato', sans-serif" },
            { name: "Montserrat", value: "'Montserrat', sans-serif" },
            { name: "Roboto", value: "'Roboto', sans-serif" },
            { name: "Open Sans", value: "'Open Sans', sans-serif" },
            { name: "Poppins", value: "'Poppins', sans-serif" },
            { name: "Raleway", value: "'Raleway', sans-serif" },
            { name: "Merriweather", value: "'Merriweather', serif" },
            { name: "Nunito", value: "'Nunito', sans-serif" },
            { name: "Dancing Script", value: "'Dancing Script', cursive" },
            { name: "Pacifico", value: "'Pacifico', cursive" },
            { name: "Indie Flower", value: "'Indie Flower', cursive" },
            { name: "Permanent Marker", value: "'Permanent Marker', cursive" },
            { name: "Lobster", value: "'Lobster', cursive" },
            { name: "Bebas Neue", value: "'Bebas Neue', cursive" },
            { name: "Anton", value: "'Anton', sans-serif" },
            { name: "Fugaz One", value: "'Fugaz One', cursive" },
            { name: "Exo 2", value: "'Exo 2', sans-serif" },
            { name: "Source Sans Pro", value: "'Source Sans Pro', sans-serif" },
            { name: "Cabin", value: "'Cabin', sans-serif" },
            { name: "Comfortaa", value: "'Comfortaa', cursive" },
            { name: "Quicksand", value: "'Quicksand', sans-serif" },
            { name: "Josefin Sans", value: "'Josefin Sans', sans-serif" },
            { name: "Amatic SC", value: "'Amatic SC', cursive" },
            { name: "Special Elite", value: "'Special Elite', cursive" },
            { name: "Press Start 2P", value: "'Press Start 2P', cursive" },
            { name: "VT323", value: "'VT323', monospace" },
            { name: "Shadows Into Light", value: "'Shadows Into Light', cursive" },
            { name: "Acme", value: "'Acme', sans-serif" },
            { name: "Righteous", value: "'Righteous', cursive" },
            { name: "Patua One", value: "'Patua One', cursive" },
            { name: "Abril Fatface", value: "'Abril Fatface', cursive" },
            { name: "Alfa Slab One", value: "'Alfa Slab One', cursive" },
            { name: "Titan One", value: "'Titan One', cursive" },
            { name: "Passion One", value: "'Passion One', cursive" },
            { name: "Luckiest Guy", value: "'Luckiest Guy', cursive" },
            { name: "Monoton", value: "'Monoton', cursive" },
            { name: "Great Vibes", value: "'Great Vibes', cursive" },
            { name: "Sacramento", value: "'Sacramento', cursive" },
            { name: "Kaushan Script", value: "'Kaushan Script', cursive" },
            { name: "Allura", value: "'Allura', cursive" },
            { name: "Satisfy", value: "'Satisfy', cursive" },
            { name: "Handlee", value: "'Handlee', cursive" },
            { name: "Pangolin", value: "'Pangolin', cursive" },
            { name: "Gochi Hand", value: "'Gochi Hand', cursive" },
            { name: "Kalam", value: "'Kalam', cursive" },
            { name: "Caveat", value: "'Caveat', cursive" },
            { name: "Zeyada", value: "'Zeyada', cursive" },
            { name: "Homemade Apple", value: "'Homemade Apple', cursive" },
            { name: "Coming Soon", value: "'Coming Soon', cursive" },
            { name: "Neucha", value: "'Neucha', cursive" },
            { name: "Gloria Hallelujah", value: "'Gloria Hallelujah', cursive" },
            { name: "Walter Turncoat", value: "'Walter Turncoat', cursive" },
            { name: "Sue Ellen Francisco", value: "'Sue Ellen Francisco', cursive" },
            { name: "Reenie Beanie", value: "'Reenie Beanie', cursive" },
            { name: "Shadows Into Light Two", value: "'Shadows Into Light Two', cursive" },
            { name: "GFS Didot", value: "'GFS Didot', serif" },
            { name: "Cinzel", value: "'Cinzel', serif" },
            { name: "Cormorant", value: "'Cormorant', serif" },
            { name: "Lora", value: "'Lora', serif" },
            { name: "PT Serif", value: "'PT Serif', serif" },
            { name: "Frank Ruhl Libre", value: "'Frank Ruhl Libre', serif" },
            { name: "Domine", value: "'Domine', serif" },
            { name: "Bitter", value: "'Bitter', serif" },
            { name: "Arvo", value: "'Arvo', serif" },
            { name: "Libre Baskerville", value: "'Libre Baskerville', serif" },
            { name: "Bodoni Moda", value: "'Bodoni Moda', serif" },
            { name: "Merriweather Sans", value: "'Merriweather Sans', sans-serif" },
            { name: "Nunito Sans", value: "'Nunito Sans', sans-serif" },
            { name: "Quicksand", value: "'Quicksand', sans-serif" },
            { name: "Roboto Condensed", value: "'Roboto Condensed', sans-serif" },
            { name: "Montserrat Alternates", value: "'Montserrat Alternates', sans-serif" },
            { name: "Fira Sans", value: "'Fira Sans', sans-serif" },
            { name: "Vollkorn", value: "'Vollkorn', serif" },
            { name: "Roboto Slab", value: "'Roboto Slab', serif" },
            { name: "Old Standard TT", value: "'Old Standard TT', serif" },
            { name: "Cardo", value: "'Cardo', serif" },
            { name: "EB Garamond", value: "'EB Garamond', serif" },
            { name: "Literata", value: "'Literata', serif" },
            { name: "Cormorant Infant", value: "'Cormorant Infant', serif" },
            { name: "Nanum Myeongjo", value: "'Nanum Myeongjo', serif" },
            { name: "Noto Serif", value: "'Noto Serif', serif" },
            { name: "Playfair Display SC", value: "'Playfair Display SC', serif" },
            { name: "Amiri", value: "'Amiri', serif" },
            { name: "Libre Caslon Display", value: "'Libre Caslon Display', serif" },
            { name: "Trispace", value: "'Trispace', sans-serif" },
            { name: "Orbitron", value: "'Orbitron', sans-serif" },
            { name: "Syncopate", value: "'Syncopate', sans-serif" },
            { name: "Iceland", value: "'Iceland', cursive" },
            { name: "Nova Square", value: "'Nova Square', cursive" },
            { name: "Wallpoet", value: "'Wallpoet', cursive" }
        ];

        const MENU_NAMES = {
            'admin': '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô',
            'stock': '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
            'database': '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            'order-number': 'Order Number',
            'dashboard': 'Dashboard',
            'manage-account': 'Manage account',
            'tax': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏µ'
        };

        const generateId = () => Date.now() + Math.floor(Math.random() * 1000);

        /**
         * [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô Netlify Function
         */
        const saveState = async () => {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appData),
                });
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                console.log('Data saved successfully!');
            } catch (error) {
                console.error('Failed to save state:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        };

        /**
         * [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà] ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô Netlify Function
         */
        const loadState = async () => {
            try {
                const response = await fetch(API_ENDPOINT);
                
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (response.status === 404) {
                    console.log('No data found on server, initializing with default data.');
                    await saveState(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }

                const serverData = await response.json();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏™‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const defaultAppData = {
                    database: [],
                    shopSettings: {
                        shopName: "WARISHAYDAY", slogan: "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° Hay Day", themeColor: "#28a745", fontFamily: "'Kanit', sans-serif",
                        globalFontFamily: "'Kanit', sans-serif", logo: null, useLogo: false, darkMode: false,
                        orderNumberFormat: 'format1', orderNumberCounters: { format1: 1, format2: 1, format3: 1 },
                        licenseKey: null, subscriptionExpires: null,
                        shopNameEffect: { enabled: false, offsetX: 2, offsetY: 2, blur: 4, color: '#000000' }
                    },
                    analytics: { dailyTraffic: Array(7).fill(0), hourlyTraffic: Array(24).fill(0), productSales: {}, orders: [], totalSales: 0, monthlyProfit: 0 },
                    subAdmins: [],
                    menuOrder: ['admin', 'database', 'stock', 'order-number', 'dashboard', 'manage-account', 'tax']
                };
                appData = { ...defaultAppData, ...serverData };
                appData.shopSettings = {...defaultAppData.shopSettings, ...appData.shopSettings};
                appData.analytics.orders = appData.analytics.orders || [];
                appData.analytics.orders.forEach(o => { if(!o.status) o.status = 'active'; });

                if (!appData.menuOrder.includes('database')) {
                    appData.menuOrder.splice(1, 0, 'database');
                }
                if (!appData.menuOrder.includes('order-number')) {
                    const stockIndex = appData.menuOrder.indexOf('stock');
                    appData.menuOrder.splice(stockIndex + 1, 0, 'order-number');
                }
                
                appData.menuOrder = appData.menuOrder.filter(item => item !== 'management-store');
                
                appData.subAdmins.forEach(sa => {
                    if (!sa.permissions) {
                        sa.permissions = {};
                        appData.menuOrder.forEach(key => sa.permissions[key] = false);
                        sa.permissions['stock'] = true;
                    }
                    if (sa.permissions['management-store']) {
                        delete sa.permissions['management-store'];
                    }
                });

            } catch (error) {
                console.error('Failed to load state:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
            }
        };

        // ==================================================================
        // END: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
        // ==================================================================

        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const views = {
            customer: document.getElementById('customer-view'),
            adminLogin: document.getElementById('admin-login-view'),
            adminPanel: document.getElementById('admin-panel-view'),
        };
        const shopNameDisplay = document.getElementById('shop-name-display');
        const shopLogoDisplay = document.getElementById('shop-logo-display');
        const headerTitleContainer = document.getElementById('header-title-container');
        const sloganElement = document.getElementById('slogan');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const productTableBody = document.getElementById('product-table-body');
        const currentCategoryName = document.getElementById('current-category-name');
        const orderValidationMsg = document.getElementById('order-validation-message');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const viewOrderBtn = document.getElementById('view-order-btn');
        const orderModal = document.getElementById('order-modal');
        const cartModal = document.getElementById('cart-modal');
        const orderDetails = document.getElementById('order-details');
        const cartDetails = document.getElementById('cart-details');
        const searchBox = document.getElementById('search-box');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const adminGearIcon = document.getElementById('admin-gear-icon');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        
        const adminMenuAdmin = document.getElementById('admin-menu-admin');
        const adminMenuStock = document.getElementById('admin-menu-stock');
        const adminMenuDatabase = document.getElementById('admin-menu-database');
        const adminMenuOrderNumber = document.getElementById('admin-menu-order-number');
        const adminMenuDashboard = document.getElementById('admin-menu-dashboard');
        const adminMenuManageAccount = document.getElementById('admin-menu-manage-account');
        const adminMenuTax = document.getElementById('admin-menu-tax');

        const adminMenuContainer = document.querySelector('.admin-menu');
        
        let activeAdminMenu = 'admin';
        let activeCategoryId = null;
        let adminActiveCategoryId = null;
        let dbActiveCategoryId = null;
        let editingProductId = null;
        let editingCategoryId = null;
        let editingDbCategoryId = null;
        let editingDbItemId = null;
        let editingSubAdminId = null;
        let catIconFile = null;
        let prodIconFile = null;
        let logoFile = null;
        let isAdminLoggedIn = false;
        let loggedInUser = null; 
        
        let dailyTrafficChart, productSalesChart, categorySalesChart, monthlyRevenueChart;

        const datePicker = document.getElementById('date-picker');
        let orderDatePicker;
        let selectedDate = new Date().toISOString().slice(0, 10);
        let fp;

        const applyTheme = () => {
            document.documentElement.style.setProperty('--primary-color', appData.shopSettings.themeColor);
            document.documentElement.style.setProperty('--global-font', appData.shopSettings.globalFontFamily);
            shopNameDisplay.style.fontFamily = appData.shopSettings.fontFamily;
            shopNameDisplay.textContent = appData.shopSettings.shopName;
            sloganElement.textContent = appData.shopSettings.slogan;
            
            const effect = appData.shopSettings.shopNameEffect;
            if (effect.enabled) {
                shopNameDisplay.style.textShadow = `${effect.offsetX}px ${effect.offsetY}px ${effect.blur}px ${effect.color}`;
            } else {
                shopNameDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.1)';
            }
            
            if (appData.shopSettings.useLogo && appData.shopSettings.logo) {
                shopLogoDisplay.src = appData.shopSettings.logo;
                shopLogoDisplay.style.display = 'block';
                shopNameDisplay.style.display = 'none';
                headerTitleContainer.style.flexDirection = 'row';
                sloganElement.style.marginTop = '0';
            } else {
                shopLogoDisplay.style.display = 'none';
                shopNameDisplay.style.display = 'block';
                headerTitleContainer.style.flexDirection = 'column';
                sloganElement.style.marginTop = '-15px';
            }

            if (appData.shopSettings.darkMode) {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleBtn.textContent = 'üåô';
            }
        };
        
        themeToggleBtn.addEventListener('click', async () => {
            appData.shopSettings.darkMode = !appData.shopSettings.darkMode;
            applyTheme();
            await saveState();
        });

        const renderCustomerView = () => {
            applyTheme();
            renderCategoryTabs();
            renderProducts();
            checkOrderValidation();
            adminGearIcon.style.display = isAdminLoggedIn ? 'none' : 'flex';
            backToAdminBtn.style.display = isAdminLoggedIn ? 'flex' : 'none';
            themeToggleBtn.style.display = 'flex';
        };

        const renderCategoryTabs = () => {
            categoryTabsContainer.innerHTML = '';
            appData.categories.forEach(cat => {
                const tab = document.createElement('div');
                tab.className = `tab ${cat.id === activeCategoryId ? 'active' : ''}`;
                tab.dataset.id = cat.id;
                tab.innerHTML = `${cat.icon ? `<img src="${cat.icon}" alt="${cat.name}">` : ''}<span>${cat.name}</span>`;
                tab.addEventListener('click', () => {
                    activeCategoryId = cat.id;
                    searchBox.value = '';
                    renderCustomerView();
                });
                categoryTabsContainer.appendChild(tab);
            });
        };

        const renderProducts = (searchTerm = '') => {
            productTableBody.innerHTML = '';
            let productsToDisplay = [];
            
            if (searchTerm) {
                productsToDisplay = appData.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                currentCategoryName.textContent = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: "${searchTerm}"`;
            } else {
                const activeCategory = appData.categories.find(c => c.id === activeCategoryId);
                if (!activeCategory) {
                    productTableBody.innerHTML = '<tr><td colspan="4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</td></tr>';
                    currentCategoryName.textContent = '';
                    return;
                }
                currentCategoryName.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${activeCategory.name}`;
                productsToDisplay = appData.products.filter(p => p.categoryId === activeCategoryId);
            }
            
            if (productsToDisplay.length === 0) {
                 productTableBody.innerHTML = '<tr><td colspan="4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
            } else {
                productsToDisplay.forEach(prod => {
                    const quantity = appData.cart[prod.id] || 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${prod.icon ? `<img src="${prod.icon}" alt="${prod.name}">` : ''}${prod.name}</td>
                        <td>${prod.level}</td>
                        <td><span class="quantity-display">${quantity}</span></td>
                        <td>
                            <div class="quantity-controls">
                                <button class="btn btn-primary btn-small" data-id="${prod.id}" data-op="10">+10</button>
                                <button class="btn btn-danger btn-small" data-id="${prod.id}" data-op="-10">-10</button>
                            </div>
                        </td>
                    `;
                    productTableBody.appendChild(row);
                });
            }
        };

        searchBox.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            renderProducts(searchTerm);
            if (searchTerm) {
                categoryTabsContainer.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            } else {
                renderCategoryTabs();
            }
        });

        const calculatePrice = (categoryId, quantity) => {
            const category = appData.categories.find(c => c.id === categoryId);
            if (!category) return { price: 0, type: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤' };

            let totalPrice = 0;
            let priceType = '';
            
            if (category.bulkPrices && category.bulkPrices.length > 0) {
                const sortedBulkPrices = category.bulkPrices.sort((a, b) => b.min - a.min);
                for (const range of sortedBulkPrices) {
                    if (quantity >= range.min && quantity <= range.max) {
                        totalPrice = range.price;
                        priceType = `‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏´‡∏°‡∏≤: ${range.min}-${range.max} ‡∏ä‡∏¥‡πâ‡∏ô`;
                        return { price: totalPrice, type: priceType };
                    }
                }
            }

            if (category.perPiecePrices && category.perPiecePrices.length > 0) {
                const sortedPerPiecePrices = category.perPiecePrices.sort((a, b) => b.quantity - a.quantity);
                let remainingQuantity = quantity;

                for (const priceItem of sortedPerPiecePrices) {
                    if (remainingQuantity >= priceItem.quantity && priceItem.price > 0) {
                        const numBlocks = Math.floor(remainingQuantity / priceItem.quantity);
                        totalPrice += numBlocks * priceItem.price;
                        priceType += `${numBlocks} x ${priceItem.quantity} ‡∏ä‡∏¥‡πâ‡∏ô`;
                        remainingQuantity %= priceItem.quantity;
                        if (remainingQuantity > 0 && remainingQuantity < sortedPerPiecePrices[0].quantity) {
                             priceType += ` (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remainingQuantity} ‡∏ä‡∏¥‡πâ‡∏ô)`;
                             break;
                        } else if (remainingQuantity > 0) {
                             priceType += ' + ';
                        }
                    }
                }
                
                if (totalPrice > 0) {
                    return { price: totalPrice, type: priceType.replace(/\s\+\s$/, '') };
                }
            }
            
            return { price: 0, type: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤' };
        };

        const checkOrderValidation = () => {
            let messages = [];
            let totalOrderPrice = 0;
            const itemsByCategory = {};
            
            for (const productId in appData.cart) {
                const quantity = appData.cart[productId];
                if (quantity > 0) {
                    const product = appData.products.find(p => p.id == productId);
                    if (product) {
                        if (!itemsByCategory[product.categoryId]) {
                            itemsByCategory[product.categoryId] = {
                                total: 0,
                                items: []
                            };
                        }
                        itemsByCategory[product.categoryId].total += quantity;
                        itemsByCategory[product.categoryId].items.push(product);
                    }
                }
            }
            
            let isOrderable = true;
            for (const categoryId in itemsByCategory) {
                const total = itemsByCategory[categoryId].total;
                const category = appData.categories.find(c => c.id == categoryId);
                if (!category) continue;
                const priceResult = calculatePrice(parseInt(categoryId), total);

                if (priceResult.price === 0) {
                    messages.push(`‡∏´‡∏°‡∏ß‡∏î "${category.name}" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${total} ‡∏ä‡∏¥‡πâ‡∏ô`);
                    isOrderable = false;
                } else {
                    totalOrderPrice += priceResult.price;
                }
            }
            
            if (messages.length > 0) {
                orderValidationMsg.innerHTML = messages.join('<br>');
                confirmOrderBtn.disabled = true;
            } else {
                if (totalOrderPrice > 0) {
                    orderValidationMsg.innerHTML = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${totalOrderPrice} ‡∏ö‡∏≤‡∏ó`;
                    confirmOrderBtn.disabled = false;
                } else {
                    orderValidationMsg.textContent = '';
                    confirmOrderBtn.disabled = true;
                }
            }
        };

        productTableBody.addEventListener('click', (e) => {
            if (e.target.matches('button[data-op]')) {
                const productId = e.target.dataset.id;
                const operation = parseInt(e.target.dataset.op);
                let currentQuantity = appData.cart[productId] || 0;
                currentQuantity += operation;
                if (currentQuantity < 0) currentQuantity = 0;
                appData.cart[productId] = currentQuantity;
                const quantityDisplay = e.target.closest('tr').querySelector('.quantity-display');
                if (quantityDisplay) { quantityDisplay.textContent = currentQuantity; }
                checkOrderValidation();
            }
        });

        const createOrderSummaryText = (orderNumber = null) => {
            let summaryText = `${appData.shopSettings.shopName}\n`;
            if (orderNumber) {
                summaryText += `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${orderNumber}\n\n`;
            }

            const itemsByCategory = {};
            let totalOrderPrice = 0;

            appData.categories.forEach(cat => {
                itemsByCategory[cat.id] = { name: cat.name, items: [], totalQuantity: 0 };
            });

            for (const productId in appData.cart) {
                const quantity = appData.cart[productId];
                if (quantity > 0) {
                    const product = appData.products.find(p => p.id == productId);
                    if (product && itemsByCategory[product.categoryId]) {
                        itemsByCategory[product.categoryId].items.push(`LV${product.level} ${product.name} x ${quantity}`);
                        itemsByCategory[product.categoryId].totalQuantity += quantity;
                    }
                }
            }

            for (const categoryId in itemsByCategory) {
                const categoryData = itemsByCategory[categoryId];
                if (categoryData.items.length > 0) {
                    summaryText += `--- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${categoryData.name} ---\n`;
                    summaryText += categoryData.items.join('\n') + '\n';
                    
                    const priceResult = calculatePrice(parseInt(categoryId), categoryData.totalQuantity);
                    if (priceResult.price > 0) {
                        summaryText += `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${priceResult.price} ‡∏ö‡∏≤‡∏ó\n`;
                        totalOrderPrice += priceResult.price;
                    }
                    summaryText += '\n';
                }
            }
            summaryText += `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalOrderPrice} ‡∏ö‡∏≤‡∏ó`;

            if (totalOrderPrice === 0) {
                return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
            }
            return summaryText;
        };
        
        confirmOrderBtn.addEventListener('click', () => {
            if (confirmOrderBtn.disabled) return;
            document.getElementById('order-modal-title').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
            document.getElementById('order-modal-prompt').style.display = 'block';
            document.getElementById('copy-order-btn').style.display = 'inline-block';
            const orderNumber = generateOrderNumber();
            orderDetails.textContent = createOrderSummaryText(orderNumber);
            orderDetails.dataset.orderNumber = orderNumber; // Store for later
            orderModal.style.display = 'flex';
        });

        viewOrderBtn.addEventListener('click', () => {
            cartDetails.textContent = createOrderSummaryText();
            cartModal.style.display = 'flex';
        });

        document.getElementById('copy-order-btn').addEventListener('click', async () => {
            const orderText = orderDetails.textContent;
            try {
                await navigator.clipboard.writeText(orderText);
                alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                
                const totalOrderPrice = parseFloat(orderValidationMsg.textContent.replace('‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ', '').replace(' ‡∏ö‡∏≤‡∏ó', ''));
                if (!isNaN(totalOrderPrice) && totalOrderPrice > 0) {
                    const newOrder = {
                        id: orderDetails.dataset.orderNumber,
                        timestamp: new Date().toISOString(),
                        total: totalOrderPrice,
                        items: { ...appData.cart },
                        status: 'active'
                    };
                    appData.analytics.orders.push(newOrder);
                    
                    for (const prodId in appData.cart) {
                        if (appData.cart[prodId] > 0) {
                            const product = appData.products.find(p => p.id == prodId);
                            if (product) {
                                if (!appData.analytics.productSales[product.name]) {
                                    appData.analytics.productSales[product.name] = 0;
                                }
                                appData.analytics.productSales[product.name] += appData.cart[prodId];

                                for (const dbCat of appData.database) {
                                    const dbItem = dbCat.items.find(i => i.name === product.name);
                                    if (dbItem) {
                                        dbItem.quantity = Math.max(0, dbItem.quantity - appData.cart[prodId]);
                                        break; 
                                    }
                                }
                            }
                        }
                    }
                }

                appData.cart = {};
                await saveState();
                orderModal.style.display = 'none';
                renderCustomerView();
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        });
        
        document.getElementById('close-order-modal-btn').addEventListener('click', () => {
            orderModal.style.display = 'none';
        });

        document.getElementById('close-cart-modal-btn').addEventListener('click', () => {
            cartModal.style.display = 'none';
        });
        
        document.getElementById('reset-cart-btn').addEventListener('click', () => {
             if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                appData.cart = {};
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á saveState ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ù‡∏±‡πà‡∏á client
                renderCustomerView();
                alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
            }
        });

        const switchView = (viewName) => {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[viewName].classList.add('active');
        };

        adminGearIcon.addEventListener('click', () => {
            if (!isAdminLoggedIn) {
                switchView('adminLogin');
                themeToggleBtn.style.display = 'none';
            }
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            const pinInput = document.getElementById('pin-input');
            const loginError = document.getElementById('login-error');
            const pin = pinInput.value;
            
            let loggedIn = false;
            
            if (pin === appData.adminPin) {
                isAdminLoggedIn = true;
                loggedInUser = { name: 'Super Admin', isSuper: true };
                loggedIn = true;
            } else {
                const subAdmin = appData.subAdmins.find(sa => sa.pin === pin);
                if (subAdmin) {
                    isAdminLoggedIn = true;
                    loggedInUser = subAdmin;
                    loggedIn = true;
                }
            }

            if (loggedIn) {
                switchView('adminPanel');
                renderAdminPanel();
                pinInput.value = '';
                loginError.textContent = '';
                adminGearIcon.style.display = 'none';
                backToAdminBtn.style.display = 'flex';
                themeToggleBtn.style.display = 'none';
                
                const today = new Date().getDay();
                appData.analytics.dailyTraffic[today] = (appData.analytics.dailyTraffic[today] || 0) + 1;
                await saveState();
            } else {
                loginError.textContent = 'PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            isAdminLoggedIn = false;
            loggedInUser = null;
            switchView('customer');
            renderCustomerView();
        });
        
        document.getElementById('view-shop-btn').addEventListener('click', () => {
            switchView('customer');
            renderCustomerView();
        });

        backToAdminBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) {
                switchView('adminPanel');
                renderAdminPanel();
            }
        });

        const renderAdminMenu = () => {
            adminMenuContainer.innerHTML = '';
            const isSuperAdmin = loggedInUser && loggedInUser.isSuper;

            appData.menuOrder.forEach(menuKey => {
                let showMenuItem = false;
                if (isSuperAdmin) {
                    showMenuItem = true;
                } else if(loggedInUser && loggedInUser.permissions) {
                    showMenuItem = loggedInUser.permissions[menuKey] === true;
                }
                
                if (showMenuItem && MENU_NAMES[menuKey]) {
                    const btn = document.createElement('button');
                    btn.className = `btn menu-btn ${menuKey === activeAdminMenu ? 'active' : ''}`;
                    btn.dataset.menu = menuKey;
                    btn.textContent = MENU_NAMES[menuKey];
                    adminMenuContainer.appendChild(btn);
                }
            });

            if (isSuperAdmin) {
                const reorderBtn = document.createElement('button');
                reorderBtn.className = 'btn btn-small btn-danger';
                reorderBtn.textContent = 'EDIT';
                reorderBtn.id = 'reorder-menu-btn';
                adminMenuContainer.appendChild(reorderBtn);
                reorderBtn.addEventListener('click', () => {
                    renderReorderMenuModal();
                });
            }
            
            document.querySelectorAll('.admin-menu .menu-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    activeAdminMenu = e.target.dataset.menu;
                    renderAdminPanel();
                });
            });
        };

        const renderAdminPanel = () => {
            document.querySelectorAll('.admin-menu-content').forEach(el => el.style.display = 'none');

            const isSuperAdmin = loggedInUser && loggedInUser.isSuper;
            document.getElementById('admin-pin-section').style.display = isSuperAdmin ? 'block' : 'none';
            document.getElementById('license-key-section').style.display = isSuperAdmin ? 'none' : 'block';

            renderAdminMenu();

            document.querySelectorAll('.admin-menu .menu-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.admin-menu .menu-btn[data-menu="${activeAdminMenu}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            const permissions = (loggedInUser && loggedInUser.permissions) || {};
            const canAccess = (menu) => isSuperAdmin || permissions[menu];

            if (activeAdminMenu === 'admin' && canAccess('admin')) {
                adminMenuAdmin.style.display = 'block';
                document.getElementById('shop-name').value = appData.shopSettings.shopName;
                document.getElementById('shop-slogan').value = appData.shopSettings.slogan;
                document.getElementById('shop-global-font').value = appData.shopSettings.globalFontFamily;
                document.getElementById('shop-font').value = appData.shopSettings.fontFamily;
                document.getElementById('order-format-select').value = appData.shopSettings.orderNumberFormat;
                document.getElementById('font-preview').style.fontFamily = appData.shopSettings.fontFamily;
                document.getElementById('logo-toggle').checked = appData.shopSettings.useLogo;
                if (appData.shopSettings.logo) {
                    document.getElementById('logo-preview').src = appData.shopSettings.logo;
                    document.getElementById('logo-preview').style.display = 'block';
                } else {
                    document.getElementById('logo-preview').style.display = 'none';
                }
                const effect = appData.shopSettings.shopNameEffect;
                document.getElementById('effect-toggle').checked = effect.enabled;
                document.getElementById('effect-offset-x').value = effect.offsetX;
                document.getElementById('effect-offset-y').value = effect.offsetY;
                document.getElementById('effect-blur').value = effect.blur;
                document.getElementById('effect-color').value = effect.color;
                document.getElementById('effect-controls-container').style.display = effect.enabled ? 'grid' : 'none';
                updateFontPreviewEffect();
                
                document.getElementById('license-key-display').value = appData.shopSettings.licenseKey || 'N/A';
                const expiryDate = appData.shopSettings.subscriptionExpires ? new Date(appData.shopSettings.subscriptionExpires) : null;
                if (expiryDate) {
                    document.getElementById('license-expiry-display').textContent = `‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${expiryDate.toLocaleDateString('th-TH')}`;
                } else {
                     document.getElementById('license-expiry-display').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                }
            } else if (activeAdminMenu === 'stock' && canAccess('stock')) {
                adminMenuStock.style.display = 'block';
                renderAdminCategories();
                renderAdminProductTabs();
                renderAdminProducts();
                populateCategoryDropdown();
            } else if (activeAdminMenu === 'database' && canAccess('database')) {
                adminMenuDatabase.style.display = 'block';
                renderDbCategories();
                renderDbItemTabs();
                renderDbItems();
            } else if (activeAdminMenu === 'order-number' && canAccess('order-number')) {
                adminMenuOrderNumber.style.display = 'block';
                if (!orderDatePicker) {
                    orderDatePicker = flatpickr("#order-date-picker", {
                        mode: "range",
                        dateFormat: "Y-m-d",
                        onClose: function(selectedDates, dateStr, instance) {
                            renderOrderNumberView(selectedDates);
                        }
                    });
                }
                renderOrderNumberView();
            } else if (activeAdminMenu === 'dashboard' && canAccess('dashboard')) {
                adminMenuDashboard.style.display = 'block';
                if (!fp) {
                    fp = flatpickr(datePicker, {
                        defaultDate: selectedDate,
                        dateFormat: "Y-m-d",
                        onChange: function(selectedDates, dateStr) {
                            selectedDate = dateStr;
                            renderDashboard();
                        }
                    });
                }
                renderDashboard();
            } else if (activeAdminMenu === 'manage-account' && canAccess('manage-account')) {
                adminMenuManageAccount.style.display = 'block';
                renderSubAdmins();
            } else if (activeAdminMenu === 'tax' && canAccess('tax')) {
                adminMenuTax.style.display = 'block';
                renderTaxCalculator();
            } else {
                if (!isSuperAdmin) {
                    const firstPermittedMenu = appData.menuOrder.find(key => permissions[key]);
                    if (firstPermittedMenu) {
                        activeAdminMenu = firstPermittedMenu;
                        renderAdminPanel();
                    } else {
                        adminMenuAdmin.style.display = 'block'; 
                        adminMenuAdmin.innerHTML = '<div class="card admin-section"><h2>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πà‡∏≤‡∏á‡πÜ</p></div>';
                    }
                }
            }
        };

        const renderDashboard = () => {
            const today = new Date();
            const selectedDay = new Date(selectedDate);
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const ordersToday = appData.analytics.orders.filter(o => o.timestamp.startsWith(selectedDate));
            const ordersInMonth = appData.analytics.orders
                                    .filter(o => new Date(o.timestamp).getFullYear() === currentYear && new Date(o.timestamp).getMonth() === currentMonth);
            const ordersInYear = appData.analytics.orders.filter(o => new Date(o.timestamp).getFullYear() === currentYear);
            
            const monthlyProfit = ordersInMonth.reduce((sum, order) => sum + order.total, 0);
            const yearlySales = ordersInYear.reduce((sum, order) => sum + order.total, 0);

            document.getElementById('monthly-profit').textContent = `${monthlyProfit.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('daily-orders').textContent = ordersToday.length;
            document.getElementById('monthly-orders').textContent = ordersInMonth.length;
            document.getElementById('yearly-sales').textContent = `${yearlySales.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

            const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            const maxTraffic = Math.max(...appData.analytics.dailyTraffic);
            const mostActiveDayIndex = appData.analytics.dailyTraffic.indexOf(maxTraffic);
            document.getElementById('most-active-day').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ${days[mostActiveDayIndex]} (${maxTraffic} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;

            const hours = appData.analytics.hourlyTraffic;
            const maxHourTraffic = Math.max(...hours);
            const mostActiveHourIndex = hours.indexOf(maxHourTraffic);
            document.getElementById('most-active-time').textContent = `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ${mostActiveHourIndex}:00 - ${mostActiveHourIndex + 1}:00 ‡∏ô. (${maxHourTraffic} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;
            
            renderTrafficChart(days);
            renderProductSalesChart();
            renderCategorySalesChart(ordersInYear);
            
            renderLowStockList();
            renderTopItems('month');
            document.querySelectorAll('#top-items-controls .btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#top-items-controls .btn[data-period="month"]').classList.add('active');

        };

        const renderTrafficChart = (days) => {
            if (dailyTrafficChart) dailyTrafficChart.destroy();
            dailyTrafficChart = new Chart(document.getElementById('dailyTrafficChart'), {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°',
                        data: appData.analytics.dailyTraffic,
                        backgroundColor: 'rgba(40, 167, 69, 0.5)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        };

        const renderProductSalesChart = () => {
             const productNames = Object.keys(appData.analytics.productSales);
            const productQuantities = Object.values(appData.analytics.productSales);
            const bestSelling = productNames.length > 0 ? productNames[productQuantities.indexOf(Math.max(...productQuantities))] : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            const leastSelling = productNames.length > 0 ? productNames[productQuantities.indexOf(Math.min(...productQuantities))] : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('best-selling-product').textContent = `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î): ${bestSelling}`;
            document.getElementById('least-selling-product').textContent = `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î): ${leastSelling}`;

            if (productSalesChart) productSalesChart.destroy();
            productSalesChart = new Chart(document.getElementById('productSalesChart'), {
                type: 'doughnut',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                        data: productQuantities,
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        const renderCategorySalesChart = (orders) => {
            const salesByCategory = {};
            orders.forEach(order => {
                const itemsByCategoryInOrder = {};
                for (const prodId in order.items) {
                    const product = appData.products.find(p => p.id == prodId);
                    if (product && product.categoryId) {
                        if (!itemsByCategoryInOrder[product.categoryId]) {
                            itemsByCategoryInOrder[product.categoryId] = 0;
                        }
                        itemsByCategoryInOrder[product.categoryId] += order.items[prodId];
                    }
                }
                 for (const catId in itemsByCategoryInOrder) {
                    const cat = appData.categories.find(c => c.id == catId);
                    if (cat) {
                        const priceResult = calculatePrice(parseInt(catId), itemsByCategoryInOrder[catId]);
                        if (!salesByCategory[cat.name]) salesByCategory[cat.name] = 0;
                        salesByCategory[cat.name] += priceResult.price;
                    }
                }
            });

            if (categorySalesChart) categorySalesChart.destroy();
            categorySalesChart = new Chart(document.getElementById('categorySalesChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(salesByCategory),
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                        data: Object.values(salesByCategory),
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#dc3545', '#6610f2', '#fd7e14', '#e83e8c', '#6c757d']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        const renderLowStockList = () => {
            const listEl = document.getElementById('low-stock-list');
            listEl.innerHTML = '';
            const allItems = [];
            appData.database.forEach(cat => {
                cat.items.forEach(item => allItems.push({ name: item.name, quantity: item.quantity }));
            });
            
            allItems.sort((a, b) => a.quantity - b.quantity);
            const lowStockItems = allItems.slice(0, 10);

            if (lowStockItems.length === 0) {
                listEl.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
                return;
            }

            lowStockItems.forEach((item, index) => {
                const li = document.createElement('li');
                if (index < 5) {
                    li.className = 'blinking-warning';
                }
                li.innerHTML = `<span>${item.name}</span><strong>${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</strong>`;
                listEl.appendChild(li);
            });
        };

        const renderTopItems = (period) => {
             const listEl = document.getElementById('top-items-list');
            listEl.innerHTML = '';
            const today = new Date();
            let ordersToAnalyze = [];

            if(period === 'day') {
                const dateStr = today.toISOString().slice(0, 10);
                ordersToAnalyze = appData.analytics.orders.filter(o => o.timestamp.startsWith(dateStr));
            } else if (period === 'month') {
                ordersToAnalyze = appData.analytics.orders.filter(o => new Date(o.timestamp).getMonth() === today.getMonth() && new Date(o.timestamp).getFullYear() === today.getFullYear());
            } else { // year
                ordersToAnalyze = appData.analytics.orders.filter(o => new Date(o.timestamp).getFullYear() === today.getFullYear());
            }

            const itemCounts = {};
            ordersToAnalyze.forEach(order => {
                for(const prodId in order.items) {
                    const product = appData.products.find(p => p.id == prodId);
                    if(product){
                        if(!itemCounts[product.name]) itemCounts[product.name] = 0;
                        itemCounts[product.name] += order.items[prodId];
                    }
                }
            });

            const sortedItems = Object.entries(itemCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
            
            if (sortedItems.length === 0) {
                listEl.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</li>';
                return;
            }

            sortedItems.forEach(([name, quantity]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${name}</span><strong>${quantity.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô</strong>`;
                listEl.appendChild(li);
            });
        };

        document.getElementById('top-items-controls').addEventListener('click', (e) => {
            if(e.target.matches('.btn')) {
                document.querySelectorAll('#top-items-controls .btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderTopItems(e.target.dataset.period);
            }
        });


        const renderAdminProductTabs = () => {
            const tabsContainer = document.getElementById('admin-product-tabs');
            tabsContainer.innerHTML = '';
            appData.categories.forEach(cat => {
                const tab = document.createElement('div');
                tab.className = `tab ${cat.id === adminActiveCategoryId ? 'active' : ''}`;
                tab.dataset.id = cat.id;
                tab.textContent = cat.name;
                tab.addEventListener('click', () => {
                    adminActiveCategoryId = cat.id;
                    renderAdminProducts();
                    renderAdminProductTabs();
                });
                tabsContainer.appendChild(tab);
            });
        };

        const renderAdminCategories = () => {
            const list = document.getElementById('admin-cat-list');
            list.innerHTML = '';
            appData.categories.forEach(cat => {
                const priceText = [];
                if (cat.perPiecePrices && cat.perPiecePrices.length > 0) {
                    const sortedPrices = cat.perPiecePrices.sort((a,b) => a.quantity - b.quantity);
                    priceText.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô:`);
                    sortedPrices.forEach(p => priceText.push(`- ${p.quantity} ‡∏ä‡∏¥‡πâ‡∏ô = ${p.price} ‡∏ö‡∏≤‡∏ó`));
                }
                if (cat.bulkPrices && cat.bulkPrices.length > 0) {
                    const sortedPrices = cat.bulkPrices.sort((a,b) => a.min - b.min);
                    priceText.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏´‡∏°‡∏≤:`);
                    sortedPrices.forEach(p => priceText.push(`- ${p.min}-${p.max} ‡∏ä‡∏¥‡πâ‡∏ô = ${p.price} ‡∏ö‡∏≤‡∏ó`));
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cat.icon ? `<img src="${cat.icon}" alt="icon" style="width:24px; height:24px;">` : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
                    <td>${cat.name}</td>
                    <td><ul class="price-list">${priceText.length > 0 ? `<li>${priceText.join('</li><li>')}</li>` : '<li>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</li>'}</ul></td>
                    <td>
                        <button class="btn btn-secondary btn-small btn-cat-edit" data-id="${cat.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn btn-danger btn-small btn-cat-delete" data-id="${cat.id}">‡∏•‡∏ö</button>
                    </td>
                `;
                list.appendChild(row);
            });
        };
        
        const renderAdminProducts = () => {
            const list = document.getElementById('admin-prod-list');
            list.innerHTML = '';
            
            const productsInCategory = appData.products.filter(p => p.categoryId === adminActiveCategoryId);
            const adminCurrentCategoryName = document.getElementById('admin-current-category-name');
            const activeCategory = appData.categories.find(c => c.id === adminActiveCategoryId);
            adminCurrentCategoryName.textContent = activeCategory ? `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${activeCategory.name}` : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';

            if (productsInCategory.length === 0) {
                 list.innerHTML = '<tr><td colspan="4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</td></tr>';
            } else {
                productsInCategory.forEach(prod => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${prod.icon ? `<img src="${prod.icon}" alt="${prod.name}">` : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
                        <td>${prod.name}</td>
                        <td>${prod.level}</td>
                        <td>
                            <button class="btn btn-secondary btn-small btn-edit" data-id="${prod.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn btn-danger btn-small btn-delete" data-id="${prod.id}">‡∏•‡∏ö</button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            }
        };
        
        const populateCategoryDropdown = () => {
            const select = document.getElementById('prod-category');
            select.innerHTML = '';
            appData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        };

        const fontSelect = document.getElementById('shop-font');
        const globalFontSelect = document.getElementById('shop-global-font');
        const fontPreview = document.getElementById('font-preview');
        
        const populateFontSelectors = () => {
            FONT_OPTIONS.forEach(font => {
                const option = document.createElement('option');
                option.value = font.value;
                option.textContent = font.name;
                fontSelect.appendChild(option.cloneNode(true));
                globalFontSelect.appendChild(option.cloneNode(true));
            });
        };
        populateFontSelectors();

        fontSelect.addEventListener('change', (e) => {
            fontPreview.style.fontFamily = e.target.value;
        });
        
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                appData.shopSettings.themeColor = e.target.dataset.color;
                applyTheme();
            });
        });

        document.getElementById('logo-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                logoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('logo-preview').src = e.target.result;
                    document.getElementById('logo-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                logoFile = null;
                document.getElementById('logo-preview').style.display = 'none';
            }
        });

        const updateFontPreviewEffect = () => {
            const effect = {
                enabled: document.getElementById('effect-toggle').checked,
                offsetX: document.getElementById('effect-offset-x').value,
                offsetY: document.getElementById('effect-offset-y').value,
                blur: document.getElementById('effect-blur').value,
                color: document.getElementById('effect-color').value
            };
            if(effect.enabled) {
                fontPreview.style.textShadow = `${effect.offsetX}px ${effect.offsetY}px ${effect.blur}px ${effect.color}`;
            } else {
                fontPreview.style.textShadow = 'none';
            }
        };

        document.getElementById('effect-controls-container').addEventListener('input', updateFontPreviewEffect);
        document.getElementById('effect-toggle').addEventListener('change', (e) => {
            document.getElementById('effect-controls-container').style.display = e.target.checked ? 'grid' : 'none';
            updateFontPreviewEffect();
        });


        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            appData.shopSettings.shopName = document.getElementById('shop-name').value;
            appData.shopSettings.slogan = document.getElementById('shop-slogan').value;
            appData.shopSettings.fontFamily = document.getElementById('shop-font').value;
            appData.shopSettings.globalFontFamily = document.getElementById('shop-global-font').value;
            appData.shopSettings.orderNumberFormat = document.getElementById('order-format-select').value;
            appData.shopSettings.useLogo = document.getElementById('logo-toggle').checked;
            appData.shopSettings.shopNameEffect = {
                enabled: document.getElementById('effect-toggle').checked,
                offsetX: document.getElementById('effect-offset-x').value,
                offsetY: document.getElementById('effect-offset-y').value,
                blur: document.getElementById('effect-blur').value,
                color: document.getElementById('effect-color').value
            };
            
            if (logoFile) {
                appData.shopSettings.logo = await readFileAsBase64(logoFile);
            }
            
            await saveState();
            applyTheme();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');
        });

        document.getElementById('change-pin-btn').addEventListener('click', async () => {
            const newPin = document.getElementById('new-pin').value;
            if (newPin && newPin.length >= 4) {
                if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡πÄ‡∏õ‡πá‡∏ô "${newPin}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    appData.adminPin = newPin;
                    await saveState();
                    alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    document.getElementById('new-pin').value = '';
                }
            } else {
                alert('PIN ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
            }
        });
        
        document.getElementById('cat-icon-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                catIconFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('cat-icon-preview').style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            } else {
                catIconFile = null;
                document.getElementById('cat-icon-preview').style.backgroundImage = 'none';
            }
        });

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('cat-name').value.trim();
            if (!name) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'); return; }

            let iconData = null;
            if (catIconFile) { iconData = await readFileAsBase64(catIconFile); }

            if (editingCategoryId) {
                const index = appData.categories.findIndex(c => c.id === editingCategoryId);
                if (index !== -1) {
                    appData.categories[index] = { ...appData.categories[index], name, icon: iconData || appData.categories[index].icon };
                }
            } else {
                appData.categories.push({ id: generateId(), name, icon: iconData, perPiecePrices: [], bulkPrices: [] });
            }

            await saveState();
            resetCategoryForm();
            renderAdminPanel();
        });
        
        const deleteCategory = async (id) => {
            if (confirm('‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                appData.categories = appData.categories.filter(c => c.id !== id);
                appData.products = appData.products.filter(p => p.categoryId !== id);
                if (appData.categories.length > 0) {
                    if (!appData.categories.find(c => c.id === activeCategoryId)) { activeCategoryId = appData.categories[0].id; }
                    if (!appData.categories.find(c => c.id === adminActiveCategoryId)) { adminActiveCategoryId = appData.categories[0].id; }
                } else {
                    activeCategoryId = null;
                    adminActiveCategoryId = null;
                }
                await saveState();
                renderAdminPanel();
            }
        };

        const resetCategoryForm = () => {
            editingCategoryId = null;
            document.getElementById('category-form').reset();
            document.getElementById('submit-cat-btn').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
            document.getElementById('cancel-cat-edit-btn').style.display = 'none';
            document.getElementById('cat-icon-preview').style.backgroundImage = 'none';
            catIconFile = null;
        }

        document.getElementById('cancel-cat-edit-btn').addEventListener('click', resetCategoryForm);
        
        document.getElementById('admin-cat-list').addEventListener('click', (e) => {
            const id = parseInt(e.target.dataset.id);
            if (e.target.classList.contains('btn-cat-edit')) {
                const category = appData.categories.find(c => c.id === id);
                if (category) {
                    editingCategoryId = id;
                    document.getElementById('cat-name').value = category.name;
                    const catIconPreview = document.getElementById('cat-icon-preview');
                    if (category.icon) { catIconPreview.style.backgroundImage = `url(${category.icon})`; } else { catIconPreview.style.backgroundImage = 'none'; }
                    document.getElementById('submit-cat-btn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                    document.getElementById('cancel-cat-edit-btn').style.display = 'inline-block';
                    document.getElementById('category-form').scrollIntoView();
                }
            }
            if (e.target.classList.contains('btn-cat-delete')) {
                deleteCategory(id);
            }
        });
        
        document.getElementById('prod-icon-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                prodIconFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('prod-icon-preview').style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            } else {
                prodIconFile = null;
                document.getElementById('prod-icon-preview').style.backgroundImage = 'none';
            }
        });

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const product = {
                id: editingProductId || generateId(),
                name: document.getElementById('prod-name').value,
                level: parseInt(document.getElementById('prod-level').value),
                categoryId: parseInt(document.getElementById('prod-category').value),
                icon: null,
            };
            
            if (prodIconFile) { product.icon = await readFileAsBase64(prodIconFile); }

            if (editingProductId) {
                const index = appData.products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    appData.products[index] = { ...appData.products[index], ...product, icon: product.icon || appData.products[index].icon };
                }
            } else {
                appData.products.push(product);
            }
            
            await saveState();
            resetProductForm();
            renderAdminProducts();
        });
        
        document.getElementById('cancel-edit-btn').addEventListener('click', resetProductForm);

        document.getElementById('admin-prod-list').addEventListener('click', async (e) => {
            const id = parseInt(e.target.dataset.id);
            if (e.target.classList.contains('btn-edit')) {
                const product = appData.products.find(p => p.id === id);
                if (product) {
                    editingProductId = id;
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('prod-name').value = product.name;
                    document.getElementById('prod-level').value = product.level;
                    document.getElementById('prod-category').value = product.categoryId;
                    const prodIconPreview = document.getElementById('prod-icon-preview');
                    if (product.icon) { prodIconPreview.style.backgroundImage = `url(${product.icon})`; } else { prodIconPreview.style.backgroundImage = 'none'; }
                    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
                    document.getElementById('product-form').scrollIntoView();
                }
            }
            if (e.target.classList.contains('btn-delete')) {
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    appData.products = appData.products.filter(p => p.id !== id);
                    await saveState();
                    renderAdminProducts();
                }
            }
        });

        function resetProductForm() {
            editingProductId = null;
            document.getElementById('product-form').reset();
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('prod-icon-preview').style.backgroundImage = 'none';
            prodIconFile = null;
        }

        const resetConfirmModal = document.getElementById('reset-confirm-modal');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        let currentResetContext = null;

        const openResetModal = (context) => {
            currentResetContext = context;
            resetConfirmModal.style.display = 'flex';
        };

        document.getElementById('reset-analytics-btn').addEventListener('click', () => openResetModal('analytics'));
        document.getElementById('reset-orders-btn').addEventListener('click', () => openResetModal('orders'));

        cancelResetBtn.addEventListener('click', () => {
            resetConfirmModal.style.display = 'none';
        });

        confirmResetBtn.addEventListener('click', async () => {
            const period = document.getElementById('reset-period-select').value;
            const now = new Date();
            const today = now.toISOString().slice(0, 10);
            
            const weekStart = new Date(now);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().slice(0, 10);

            const monthStartStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${period})? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                if (currentResetContext === 'analytics') {
                    if (period === 'all') {
                        appData.analytics = { dailyTraffic: Array(7).fill(0), hourlyTraffic: Array(24).fill(0), productSales: {}, orders: [], totalSales: 0, monthlyProfit: 0 };
                    } else {
                        alert('‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà');
                         appData.analytics.dailyTraffic = Array(7).fill(0);
                         appData.analytics.hourlyTraffic = Array(24).fill(0);
                         appData.analytics.productSales = {};
                    }
                    renderDashboard();
                } else if (currentResetContext === 'orders') {
                    if (period === 'all') {
                        appData.analytics.orders = [];
                    } else {
                        appData.analytics.orders = appData.analytics.orders.filter(order => {
                            const orderDate = order.timestamp.slice(0, 10);
                            if (period === 'day') return orderDate !== today;
                            if (period === 'week') return orderDate < weekStartStr;
                            if (period === 'month') return orderDate < monthStartStr;
                            return true;
                        });
                    }
                    renderOrderNumberView();
                }
                await saveState();
                alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            }
            resetConfirmModal.style.display = 'none';
        });

        const perPiecePriceModal = document.getElementById('per-piece-price-modal');
        const bulkPriceModal = document.getElementById('bulk-price-modal');
        const perPiecePriceForm = document.getElementById('per-piece-price-form');
        const bulkPriceForm = document.getElementById('bulk-price-form');

        document.getElementById('set-per-piece-price-btn').addEventListener('click', () => {
            if (!editingCategoryId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô'); return; }
            renderPerPiecePriceForm();
            perPiecePriceModal.style.display = 'flex';
        });

        document.getElementById('close-per-piece-price-modal-btn').addEventListener('click', () => { perPiecePriceModal.style.display = 'none'; });
        document.getElementById('close-bulk-price-modal-btn').addEventListener('click', () => { bulkPriceModal.style.display = 'none'; });

        const renderPerPiecePriceForm = () => {
            perPiecePriceForm.innerHTML = '';
            const category = appData.categories.find(c => c.id === editingCategoryId);
            const prices = category.perPiecePrices || [];
            
            for (let i = 10; i <= 1000; i += 10) {
                const priceItem = prices.find(p => p.quantity === i);
                const currentValue = priceItem ? priceItem.price : '';
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${i} ‡∏ä‡∏¥‡πâ‡∏ô: <input type="number" data-quantity="${i}" value="${currentValue}" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)"></label>`;
                perPiecePriceForm.appendChild(div);
            }
        };

        document.getElementById('save-per-piece-price-btn').addEventListener('click', async () => {
            const category = appData.categories.find(c => c.id === editingCategoryId);
            const newPrices = [];
            perPiecePriceForm.querySelectorAll('input').forEach(input => {
                const quantity = parseInt(input.dataset.quantity);
                const price = parseInt(input.value);
                if (price > 0) {
                    newPrices.push({ quantity, price });
                }
            });
            category.perPiecePrices = newPrices;
            await saveState();
            renderAdminCategories();
            perPiecePriceModal.style.display = 'none';
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });

        document.getElementById('save-bulk-price-btn').addEventListener('click', async () => {
            const category = appData.categories.find(c => c.id === editingCategoryId);
            const newPrices = [];
            bulkPriceForm.querySelectorAll('input').forEach(input => {
                const min = parseInt(input.dataset.min);
                const max = parseInt(input.dataset.max);
                const price = parseInt(input.value);
                if (price > 0) {
                    newPrices.push({ min, max, price });
                }
            });
            category.bulkPrices = newPrices;
            await saveState();
            renderAdminCategories();
            bulkPriceModal.style.display = 'none';
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏´‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });

        // --- SuperAdmin Logic ---
        const renderSubAdmins = () => {
            const list = document.getElementById('sub-admin-list');
            list.innerHTML = '';
            if (appData.subAdmins.length === 0) {
                list.innerHTML = '<tr><td colspan="3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢</td></tr>';
            } else {
                appData.subAdmins.forEach(sa => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sa.name}</td>
                        <td>${sa.pin}</td>
                        <td>
                            <button class="btn btn-secondary btn-small btn-sub-admin-edit" data-id="${sa.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn btn-danger btn-small btn-sub-admin-delete" data-id="${sa.id}">‡∏•‡∏ö</button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            }
        };

        const subAdminForm = document.getElementById('sub-admin-form');
        const subAdminNameInput = document.getElementById('sub-admin-name');
        const subAdminPinInput = document.getElementById('sub-admin-pin');
        const addSubAdminBtn = document.getElementById('add-sub-admin-btn');
        const cancelSubAdminEditBtn = document.getElementById('cancel-sub-admin-edit');

        subAdminForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = subAdminNameInput.value.trim();
            const pin = subAdminPinInput.value;

            if (pin.length < 4) { alert('PIN ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'); return; }

            if (editingSubAdminId) {
                const subAdmin = appData.subAdmins.find(sa => sa.id === editingSubAdminId);
                if (subAdmin) {
                     if (appData.subAdmins.find(sa => sa.pin === pin && sa.id !== editingSubAdminId)) { alert('PIN ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß'); return; }
                    subAdmin.name = name;
                    subAdmin.pin = pin;
                }
            } else {
                if (appData.subAdmins.length >= 20) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏Ñ‡∏ô'); return; }
                if (appData.subAdmins.find(sa => sa.pin === pin)) { alert('PIN ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'); return; }
                const newSubAdmin = { 
                    id: generateId(), 
                    name, 
                    pin, 
                    permissions: {
                        'admin': true, 'database': true, 'stock': true,
                        'order-number': true, 'dashboard': true,
                        'manage-account': true, 'tax': true
                    } 
                };
                appData.subAdmins.push(newSubAdmin);
            }
            
            await saveState();
            resetSubAdminForm();
            renderSubAdmins();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });

        const resetSubAdminForm = () => {
            editingSubAdminId = null;
            subAdminForm.reset();
            addSubAdminBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            cancelSubAdminEditBtn.style.display = 'none';
        };

        cancelSubAdminEditBtn.addEventListener('click', resetSubAdminForm);

        document.getElementById('sub-admin-list').addEventListener('click', async (e) => {
            const id = parseInt(e.target.dataset.id);
            if (e.target.classList.contains('btn-sub-admin-edit')) {
                const subAdmin = appData.subAdmins.find(sa => sa.id === id);
                if (subAdmin) {
                    editingSubAdminId = id;
                    subAdminNameInput.value = subAdmin.name;
                    subAdminPinInput.value = subAdmin.pin;
                    addSubAdminBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                    cancelSubAdminEditBtn.style.display = 'inline-block';
                }
            }
            if (e.target.classList.contains('btn-sub-admin-delete')) {
                if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    appData.subAdmins = appData.subAdmins.filter(sa => sa.id !== id);
                    await saveState();
                    renderSubAdmins();
                }
            }
        });

        // Permissions Modal
        const permissionModal = document.getElementById('permission-modal');
        const permissionList = document.getElementById('permission-list');
        const permissionUserName = document.getElementById('permission-user-name');
        let currentSubAdminPermissionsId = null;

        document.getElementById('view-permissions-btn').addEventListener('click', () => {
            if (appData.subAdmins.length === 0) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏¢'); return; }
            renderPermissionsModal();
        });

        const renderPermissionsModal = () => {
            permissionList.innerHTML = '';
            const subAdmin = appData.subAdmins[0];
            if (!subAdmin) return;
            currentSubAdminPermissionsId = subAdmin.id;
            permissionUserName.textContent = `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${subAdmin.name}`;
            const menuKeys = appData.menuOrder;
            menuKeys.forEach(key => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.marginBottom = '15px';
                const isChecked = subAdmin.permissions[key] || false;
                li.innerHTML = `<span>${MENU_NAMES[key]}</span><label class="toggle-switch"><input type="checkbox" data-menu-key="${key}" ${isChecked ? 'checked' : ''}><span class="slider"></span></label>`;
                permissionList.appendChild(li);
            });
            permissionModal.style.display = 'flex';
        };
        
        document.getElementById('save-permissions-btn').addEventListener('click', async () => {
            const subAdmin = appData.subAdmins.find(sa => sa.id === currentSubAdminPermissionsId);
            if (subAdmin) {
                const newPermissions = {};
                permissionList.querySelectorAll('input[type="checkbox"]').forEach(input => {
                    newPermissions[input.dataset.menuKey] = input.checked;
                });
                subAdmin.permissions = newPermissions;
                await saveState();
                permissionModal.style.display = 'none';
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                if (loggedInUser && loggedInUser.id === currentSubAdminPermissionsId) { renderAdminPanel(); }
            }
        });

        document.getElementById('close-permission-modal-btn').addEventListener('click', () => { permissionModal.style.display = 'none'; });

        // --- Tax Calculator Logic ---
        const taxTypeToggle = document.getElementById('tax-type-toggle');
        const taxPersonForm = document.getElementById('tax-person-form');
        const taxJuristicForm = document.getElementById('tax-juristic-form');
        const taxResultsContainer = document.getElementById('tax-calculation-results');
        
        taxTypeToggle.addEventListener('change', () => {
            const isJuristic = taxTypeToggle.checked;
            document.getElementById('tax-type-label').textContent = isJuristic ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤';
            taxPersonForm.style.display = isJuristic ? 'none' : 'block';
            taxJuristicForm.style.display = isJuristic ? 'block' : 'none';
            renderTaxCalculator();
        });

         document.getElementById('tax-expense-type').addEventListener('change', (e) => {
            document.getElementById('tax-actual-expense').style.display = e.target.value === 'actual' ? 'block' : 'none';
        });

        document.getElementById('calculate-tax-btn').addEventListener('click', () => {
            const isJuristic = taxTypeToggle.checked;
            let resultsHTML = '';

            if(isJuristic) {
                const income = parseFloat(document.getElementById('tax-juristic-income').value) || 0;
                const expense = parseFloat(document.getElementById('tax-juristic-expense').value) || 0;
                const profit = income - expense;
                let tax = 0;
                if (profit > 3000000) {
                    tax = (3000000 * 0.15) + ((profit - 3000000) * 0.20);
                } else if (profit > 0) {
                    tax = profit * 0.15;
                }
                resultsHTML = `<h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</h3>
                               <p>‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <strong>${profit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</strong></p>
                               <p>‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì): <strong>${tax.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</strong></p>`;
            } else {
                const income = parseFloat(document.getElementById('tax-income').value) || 0;
                let expense = 0;
                if(document.getElementById('tax-expense-type').value === 'standard') {
                    expense = Math.min(income * 0.6, 100000);
                } else {
                    expense = parseFloat(document.getElementById('tax-actual-expense').value) || 0;
                }
                const deductions = 60000 + 
                                   (parseFloat(document.getElementById('tax-spouse').value) || 0) +
                                   ((parseFloat(document.getElementById('tax-child').value) || 0) * 30000) +
                                   ((parseFloat(document.getElementById('tax-parent').value) || 0) * 30000) +
                                   (parseFloat(document.getElementById('tax-insurance').value) || 0) +
                                   (parseFloat(document.getElementById('tax-donation').value) || 0);
                
                const taxableIncome = Math.max(0, income - expense - deductions);
                
                let tax = 0;
                if (taxableIncome > 5000000) tax += (taxableIncome - 5000000) * 0.35;
                if (taxableIncome > 2000000) tax += (Math.min(taxableIncome, 5000000) - 2000000) * 0.30;
                if (taxableIncome > 1000000) tax += (Math.min(taxableIncome, 2000000) - 1000000) * 0.25;
                if (taxableIncome > 750000) tax += (Math.min(taxableIncome, 1000000) - 750000) * 0.20;
                if (taxableIncome > 500000) tax += (Math.min(taxableIncome, 750000) - 500000) * 0.15;
                if (taxableIncome > 300000) tax += (Math.min(taxableIncome, 500000) - 300000) * 0.10;
                if (taxableIncome > 150000) tax += (Math.min(taxableIncome, 300000) - 150000) * 0.05;

                resultsHTML = `<h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏†.‡∏á.‡∏î. 90/91)</h3>
                               <p>‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <strong>${taxableIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</strong></p>
                               <p>‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì): <strong>${tax.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</strong></p>`;
            }
            taxResultsContainer.innerHTML = `<div class="tax-results">${resultsHTML}</div>`;
        });

        const renderTaxCalculator = () => {
            const totalRevenue = appData.analytics.orders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('tax-income').value = totalRevenue;
            document.getElementById('tax-juristic-income').value = totalRevenue;
            taxResultsContainer.innerHTML = '';
        };

        // --- Reorder Menu Modal Logic ---
        const reorderMenuModal = document.getElementById('reorder-menu-modal');
        const reorderMenuList = document.getElementById('reorder-menu-list');
        const renderReorderMenuModal = () => {
            reorderMenuList.innerHTML = '';
            appData.menuOrder.forEach(key => {
                const li = document.createElement('li');
                li.textContent = MENU_NAMES[key];
                li.dataset.menu = key;
                li.draggable = true;
                li.classList.add('sortable');
                reorderMenuList.appendChild(li);
            });
            reorderMenuModal.style.display = 'flex';
            addDragDropListeners();
        };
        const addDragDropListeners = () => { /* ... (Existing drag/drop logic remains unchanged) ... */ };
        document.getElementById('save-menu-order-btn').addEventListener('click', async () => {
            const newOrder = [...reorderMenuList.children].map(li => li.dataset.menu);
            appData.menuOrder = newOrder;
            await saveState();
            reorderMenuModal.style.display = 'none';
            renderAdminPanel();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });
        document.getElementById('close-reorder-menu-modal-btn').addEventListener('click', () => { reorderMenuModal.style.display = 'none'; });

        // --- DATABASE FEATURE LOGIC ---
        const dbCategoryForm = document.getElementById('db-category-form');
        const dbCatList = document.getElementById('db-cat-list');
        const renderDbCategories = () => {
            dbCatList.innerHTML = '';
            appData.database.forEach(cat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cat.name}</td>
                    <td>${cat.items.length}</td>
                    <td>
                        <button class="btn btn-secondary btn-small btn-db-cat-edit" data-id="${cat.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn btn-danger btn-small btn-db-cat-delete" data-id="${cat.id}">‡∏•‡∏ö</button>
                    </td>
                `;
                dbCatList.appendChild(row);
            });
        };
        const resetDbCategoryForm = () => {
            editingDbCategoryId = null;
            dbCategoryForm.reset();
            document.getElementById('cancel-db-cat-edit-btn').style.display = 'none';
        };
        dbCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('db-cat-name').value.trim();
            if (!name) return;

            if (editingDbCategoryId) {
                const cat = appData.database.find(c => c.id === editingDbCategoryId);
                if (cat) cat.name = name;
            } else {
                appData.database.push({ id: generateId(), name, items: [] });
            }
            await saveState();
            resetDbCategoryForm();
            renderDbCategories();
            renderDbItemTabs();
        });
        document.getElementById('cancel-db-cat-edit-btn').addEventListener('click', resetDbCategoryForm);
        dbCatList.addEventListener('click', async (e) => {
            const id = parseInt(e.target.dataset.id);
            if (e.target.classList.contains('btn-db-cat-edit')) {
                const cat = appData.database.find(c => c.id === id);
                if (cat) {
                    editingDbCategoryId = id;
                    document.getElementById('db-cat-id').value = cat.id;
                    document.getElementById('db-cat-name').value = cat.name;
                    document.getElementById('cancel-db-cat-edit-btn').style.display = 'inline-block';
                }
            }
            if (e.target.classList.contains('btn-db-cat-delete')) {
                if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    appData.database = appData.database.filter(c => c.id !== id);
                    if (dbActiveCategoryId === id) dbActiveCategoryId = null;
                    await saveState();
                    renderDbCategories();
                    renderDbItemTabs();
                    renderDbItems();
                }
            }
        });
        const dbItemTabs = document.getElementById('db-item-tabs');
        const dbItemList = document.getElementById('db-item-list');
        const dbItemForm = document.getElementById('db-item-form');
        const dbItemHr = document.getElementById('db-item-hr');
        const dbCurrentCategoryName = document.getElementById('db-current-category-name');
        const renderDbItemTabs = () => {
            dbItemTabs.innerHTML = '';
            appData.database.forEach(cat => {
                const tab = document.createElement('div');
                tab.className = `tab ${cat.id === dbActiveCategoryId ? 'active' : ''}`;
                tab.dataset.id = cat.id;
                tab.textContent = cat.name;
                tab.addEventListener('click', () => {
                    dbActiveCategoryId = cat.id;
                    renderDbItemTabs();
                    renderDbItems();
                });
                dbItemTabs.appendChild(tab);
            });
        };
        const renderDbItems = () => {
            dbItemList.innerHTML = '';
            const activeCategory = appData.database.find(c => c.id === dbActiveCategoryId);
            if (!activeCategory) {
                dbItemForm.style.display = 'none';
                dbItemHr.style.display = 'none';
                dbCurrentCategoryName.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
                dbItemList.innerHTML = '<tr><td colspan="4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
                return;
            }
            dbItemForm.style.display = 'block';
            dbItemHr.style.display = 'block';
            dbCurrentCategoryName.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${activeCategory.name}`;
            
            if (activeCategory.items.length === 0) {
                dbItemList.innerHTML = '<tr><td colspan="4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</td></tr>';
            } else {
                activeCategory.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.level}</td>
                        <td>${item.quantity}</td>
                        <td>
                            <button class="btn btn-secondary btn-small btn-db-item-edit" data-id="${item.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn btn-danger btn-small btn-db-item-delete" data-id="${item.id}">‡∏•‡∏ö</button>
                        </td>
                    `;
                    dbItemList.appendChild(row);
                });
            }
        };
        const resetDbItemForm = () => {
            editingDbItemId = null;
            dbItemForm.reset();
            document.getElementById('db-item-quantity').value = 0;
            document.getElementById('cancel-db-item-edit-btn').style.display = 'none';
        };
        dbItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = appData.database.find(c => c.id === dbActiveCategoryId);
            if (!category) return;
            const name = document.getElementById('db-item-name').value.trim();
            const level = parseInt(document.getElementById('db-item-level').value);
            const quantity = parseInt(document.getElementById('db-item-quantity').value);
            if (!name || isNaN(level) || isNaN(quantity)) return;

            if (editingDbItemId) {
                const item = category.items.find(i => i.id === editingDbItemId);
                if (item) { item.name = name; item.level = level; item.quantity = quantity; }
            } else {
                category.items.push({ id: generateId(), name, level, quantity });
            }
            await saveState();
            resetDbItemForm();
            renderDbItems();
            renderDbCategories();
        });
        document.getElementById('cancel-db-item-edit-btn').addEventListener('click', resetDbItemForm);
        dbItemList.addEventListener('click', async (e) => {
            const id = parseInt(e.target.dataset.id);
            const category = appData.database.find(c => c.id === dbActiveCategoryId);
            if (!category) return;
            if (e.target.classList.contains('btn-db-item-edit')) {
                const item = category.items.find(i => i.id === id);
                if (item) {
                    editingDbItemId = id;
                    document.getElementById('db-item-id').value = item.id;
                    document.getElementById('db-item-name').value = item.name;
                    document.getElementById('db-item-level').value = item.level;
                    document.getElementById('db-item-quantity').value = item.quantity;
                    document.getElementById('cancel-db-item-edit-btn').style.display = 'inline-block';
                }
            }
            if (e.target.classList.contains('btn-db-item-delete')) {
                category.items = category.items.filter(i => i.id !== id);
                await saveState();
                renderDbItems();
                renderDbCategories();
            }
        });

        // --- Search Modal Logic ---
        const searchModal = document.getElementById('search-modal');
        const searchModalTitle = document.getElementById('search-modal-title');
        const searchModalInput = document.getElementById('search-modal-input');
        const searchModalResults = document.getElementById('search-modal-results');
        const openSearchModal = (type) => {
            searchModalTitle.textContent = type === 'category' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            searchModalInput.value = '';
            searchModalInput.dataset.type = type;
            populateSearchResults(type, '');
            searchModal.style.display = 'flex';
            searchModalInput.focus();
        };
        const populateSearchResults = (type, searchTerm) => {
            searchModalResults.innerHTML = '';
            const lowerSearchTerm = searchTerm.toLowerCase();
            if (type === 'category') {
                const filtered = appData.database.filter(cat => cat.name.toLowerCase().includes(lowerSearchTerm));
                filtered.forEach(cat => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-modal-result-item';
                    itemDiv.textContent = cat.name;
                    itemDiv.addEventListener('click', () => {
                        document.getElementById('cat-name').value = cat.name;
                        searchModal.style.display = 'none';
                    });
                    searchModalResults.appendChild(itemDiv);
                });
            } else if (type === 'product') {
                appData.database.forEach(cat => {
                    const filtered = cat.items.filter(item => item.name.toLowerCase().includes(lowerSearchTerm));
                    filtered.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-modal-result-item';
                        itemDiv.textContent = `${item.name} (LV: ${item.level}) - [${cat.name}]`;
                        itemDiv.addEventListener('click', () => {
                            document.getElementById('prod-name').value = item.name;
                            document.getElementById('prod-level').value = item.level;
                            searchModal.style.display = 'none';
                        });
                        searchModalResults.appendChild(itemDiv);
                    });
                });
            }
        };
        document.querySelectorAll('.search-btn').forEach(btn => { btn.addEventListener('click', () => { openSearchModal(btn.dataset.type); }); });
        searchModalInput.addEventListener('input', (e) => { populateSearchResults(e.target.dataset.type, e.target.value); });
        document.getElementById('close-search-modal-btn').addEventListener('click', () => { searchModal.style.display = 'none'; });

        // --- ORDER NUMBER ---
        const generateOrderNumber = () => {
            const format = appData.shopSettings.orderNumberFormat;
            const counters = appData.shopSettings.orderNumberCounters;
            const now = new Date();
            
            let num = counters[format] || 1;
            counters[format] = num + 1;

            const pad = (n, width) => n.toString().padStart(width, '0');

            switch(format) {
                case 'format1': // WHD68/08/0001
                    const thaiYear = (now.getFullYear() + 543).toString().slice(-2);
                    const month = pad(now.getMonth() + 1, 2);
                    return `WHD${thaiYear}/${month}/${pad(num, 4)}`;
                case 'format2': // WHD-20250820-0001
                    const year = now.getFullYear();
                    const day = pad(now.getDate(), 2);
                    return `WHD-${year}${pad(now.getMonth() + 1, 2)}${day}-${pad(num, 4)}`;
                case 'format3': // WHD-12345 (Random)
                default:
                    return `WHD-${Math.floor(Math.random() * 90000) + 10000}`;
            }
        };

        const renderOrderNumberView = (dateRange = []) => {
            const activeList = document.getElementById('active-orders-list');
            const cancelledList = document.getElementById('cancelled-orders-list');
            activeList.innerHTML = '';
            cancelledList.innerHTML = '';

            let orders = [...appData.analytics.orders];

            if (dateRange.length > 0) {
                const start = dateRange[0].setHours(0,0,0,0);
                const end = dateRange.length === 2 ? dateRange[1].setHours(23,59,59,999) : new Date(start).setHours(23,59,59,999);
                orders = orders.filter(o => {
                    const orderDate = new Date(o.timestamp).getTime();
                    return orderDate >= start && orderDate <= end;
                });
            }
            
            orders.reverse();

            orders.forEach(order => {
                const date = new Date(order.timestamp);
                const formattedDate = `${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH')}`;
                const row = document.createElement('tr');

                if (order.status === 'active') {
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${formattedDate}</td>
                        <td>${order.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                        <td>
                            <button class="btn btn-info btn-small view-order-details" data-id="${order.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                            <button class="btn btn-danger btn-small cancel-order" data-id="${order.id}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </td>`;
                    activeList.appendChild(row);
                } else {
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${formattedDate}</td>
                        <td>${order.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                        <td>
                            <button class="btn btn-info btn-small view-order-details" data-id="${order.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                        </td>`;
                    cancelledList.appendChild(row);
                }
            });

            document.querySelectorAll('.view-order-details').forEach(btn => btn.addEventListener('click', (e) => viewOrderDetails(e.target.dataset.id)));
            document.querySelectorAll('.cancel-order').forEach(btn => btn.addEventListener('click', (e) => cancelOrder(e.target.dataset.id)));
        };

        const viewOrderDetails = (orderId) => {
             const order = appData.analytics.orders.find(o => o.id === orderId);
            if (!order) return;

            const originalCart = { ...appData.cart };
            appData.cart = order.items;
            const summaryText = createOrderSummaryText(order.id);
            appData.cart = originalCart;

            document.getElementById('order-modal-title').textContent = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
            document.getElementById('order-modal-prompt').style.display = 'none';
            document.getElementById('copy-order-btn').style.display = 'none';
            orderDetails.textContent = summaryText;
            orderModal.style.display = 'flex';
        };

        const cancelOrder = async (orderId) => {
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${orderId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                const order = appData.analytics.orders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'cancelled';
                    await saveState();
                    renderOrderNumberView(orderDatePicker.selectedDates);
                }
            }
        };
        
        // --- LICENSE KEY / SUBSCRIPTION ---
        const checkSubscription = async () => {
            if (loggedInUser && loggedInUser.isSuper) return; 

            const expiry = appData.shopSettings.subscriptionExpires;
            if (!expiry) { 
                const today = new Date();
                today.setDate(today.getDate() + 30);
                appData.shopSettings.subscriptionExpires = today.toISOString();
                appData.shopSettings.licenseKey = "TRIAL-KEY-30-DAYS";
                await saveState();
                return;
            }

            if (new Date() > new Date(expiry)) {
                document.getElementById('license-key-modal').style.display = 'flex';
                document.getElementById('customer-view').style.display = 'none';
                document.getElementById('admin-login-view').style.display = 'none';
            }
        };

        document.getElementById('submit-new-license-key-btn').addEventListener('click', async () => {
            const key = document.getElementById('new-license-key-input').value;
            const keyParts = key.split('-');
            if (key.startsWith("KEY-") && keyParts.length === 3) {
                const days = parseInt(keyParts[1]);
                if (!isNaN(days)) {
                    const today = new Date();
                    today.setDate(today.getDate() + days);
                    appData.shopSettings.subscriptionExpires = today.toISOString();
                    appData.shopSettings.licenseKey = key;
                    await saveState();
                    alert('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    window.location.reload();
                } else {
                     document.getElementById('license-key-error').textContent = 'Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                }
            } else {
                 document.getElementById('license-key-error').textContent = 'Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            }
        });


        // --- Init ---
        const init = async () => {
            await loadState();
            await checkSubscription();
            
            if (appData.categories.length > 0) {
                if (!appData.categories.find(c => c.id === activeCategoryId)) { activeCategoryId = appData.categories[0].id; }
                adminActiveCategoryId = activeCategoryId;
            } else { activeCategoryId = null; adminActiveCategoryId = null; }
            if (appData.database.length > 0) {
                 if (!appData.database.find(c => c.id === dbActiveCategoryId)) { dbActiveCategoryId = appData.database[0].id; }
            } else { dbActiveCategoryId = null; }
            renderCustomerView();
            
            // ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
        };

        init();
    });
    </script>
</body>
</html>
