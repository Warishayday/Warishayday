<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WARISHAYDAY - ร้านค้าไอเท็ม Hay Day</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600&family=IBM+Plex+Sans+Thai:wght@300;400;500;600&family=Mali:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600&family=Taviraj:wght@300;400;500;600&family=Trirong:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #28a745;
            --secondary-color: #ffc107;
            --background-color: #f0f2f5;
            --surface-color: #ffffff;
            --text-color: #333;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --hover-shadow: 0 4px 12px rgba(0,0,0,0.15);
            --global-font: 'Kanit', sans-serif;
        }

        /* Dark Mode */
        body.dark-mode {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --shadow: 0 4px 8px rgba(0,0,0,0.5);
            --hover-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        body.dark-mode .card,
        body.dark-mode .tab,
        body.dark-mode .modal-content,
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea,
        body.dark-mode .stat-card,
        body.dark-mode .top-selling-list li,
        body.dark-mode .price-list li,
        body.dark-mode .reorder-list li,
        body.dark-mode .search-modal-result-item,
        body.dark-mode .low-stock-list li {
            background-color: var(--surface-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        body.dark-mode .btn-secondary,
        body.dark-mode .tab {
            color: var(--text-color);
        }
        body.dark-mode .tab.active,
        body.dark-mode .btn-secondary:hover {
            color: white;
        }
        body.dark-mode #admin-gear-icon,
        body.dark-mode #back-to-admin-btn,
        body.dark-mode #lang-toggle-btn {
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        body.dark-mode .slider {
            background-color: #555;
        }
        body.dark-mode .slider:before {
            background-color: #ccc;
        }
        body.dark-mode input:checked + .slider {
            background-color: var(--primary-color);
        }
        body.dark-mode #reset-cart-btn {
            background: none;
        }
        body.dark-mode #order-details,
        body.dark-mode #cart-details {
            background-color: #2a2a2a;
        }
        body.dark-mode #font-preview {
            color: var(--text-color);
        }
        body.dark-mode .search-input-container .search-btn {
            background: #333;
        }
        body.dark-mode .search-modal-result-item:hover {
            background-color: #3a3a3a;
        }
        body.dark-mode .effect-controls {
            background-color: #2a2a2a;
            border-color: #333;
        }
        
        /* ================================================= */
        /* ===== START: โค้ดสำหรับหน้าจอโหลด (อัปเดตใหม่) ===== */
        /* ================================================= */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-family: 'Kanit', sans-serif;
            backdrop-filter: blur(5px);
        }
        #loader-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
            transition: opacity 0.5s ease;
        }

        .loader-content {
            text-align: center;
            z-index: 1;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 250px;
            height: 15px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #dc3545, #6610f2, #007bff, #28a745, #ffc107);
            background-size: 200% 100%;
            animation: running-progress 3s linear infinite;
        }

        @keyframes running-progress {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        /* ================================================= */
        /* ===== END: โค้ดสำหรับหน้าจอโหลด (อัปเดตใหม่) ===== */
        /* ================================================= */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--global-font);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        #background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 0.5s ease, filter 0.5s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2, h3, h4 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        h1 {
            font-size: 2.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        #slogan {
            text-align: center;
            font-size: 1.2rem;
            margin-top: -15px;
            margin-bottom: 20px;
            color: #6c757d;
        }

        .view { display: none; }
        .view.active { display: block; }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
            font-family: var(--global-font);
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #218838; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .btn-secondary { background-color: var(--secondary-color); color: #333; }
        .btn-secondary:hover { background-color: #e0a800; }

        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-small { padding: 5px 10px; font-size: 0.9rem; }
        .btn-reset { background-color: var(--danger-color); padding: 5px 12px; font-size: 0.9rem; }
        .btn-reset:hover { background-color: #c82333; }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input[type="text"], input[type="number"], input[type="password"], input[type="url"], input[type="email"], select, input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--global-font);
            margin-bottom: 10px;
            background-color: var(--surface-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }

        #category-tabs, .tab-group-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            transition: border-color 0.3s;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .tab:hover { background-color: #ced4da; }
        .tab.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .tab img { width: 24px; height: 24px; }
        .tab.sortable { cursor: grab; }
        .tab.sortable:active { cursor: grabbing; }

        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            transition: border-color 0.3s;
        }
        th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            position: sticky;
            top: 0;
            z-index: 1;
            transition: background-color 0.3s;
        }
        body.dark-mode th {
            background-color: #2a2a2a;
        }

        td img { width: 32px; height: 32px; vertical-align: middle; margin-right: 10px; }
        .quantity-controls { 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            gap: 5px; 
        }
        .quantity-controls .btn { padding: 5px 12px; }
        .quantity-display { font-weight: 600; min-width: 30px; text-align: center; }

        #order-summary {
            position: sticky;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 8px rgba(0,0,0,0.05);
            z-index: 100;
            margin-top: 20px;
        }
        #order-validation-message {
            color: var(--danger-color);
            font-weight: 500;
            min-height: 24px;
        }
        
        .validation-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .validation-link:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .order-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .order-buttons .btn {
            flex: 1;
        }

        .copyright-footer {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #6c757d;
            transition: opacity 0.3s;
        }
        body.dark-mode .copyright-footer {
            color: #888;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-content h2 { margin-bottom: 15px; text-align: left;}
        #order-details, #cart-details {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            text-align: left;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .modal-actions { text-align: center; }
        .modal .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #aaa;
        }
        .modal .close-btn:hover { color: #555; }
        
        .copy-success-content {
            background-color: var(--surface-color);
            padding: 40px 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .copy-success-content p {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 4;
            stroke: var(--primary-color);
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px var(--primary-color);
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3;
            stroke-miterlimit: 10;
            stroke: var(--primary-color);
            fill: none;
            animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards;
        }
        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 40px var(--primary-color);
            }
        }
        body.dark-mode .copy-success-content {
            background-color: #2a2a2a;
        }
        body.dark-mode .checkmark {
            stroke: #fff;
        }
        body.dark-mode .checkmark__circle {
            stroke: #fff;
        }
        @keyframes fill-dark {
            100% {
                box-shadow: inset 0px 0px 0px 40px #fff;
            }
        }
        body.dark-mode .checkmark {
            animation: fill-dark .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        body.dark-mode .checkmark__check {
            stroke: var(--primary-color);
        }
        
        .reset-btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .price-list-modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .price-list-modal-content label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .price-list-modal-content input[type="number"] {
            width: 100px;
            margin-left: 15px;
        }
        .price-list-modal-content hr {
            margin: 15px 0;
        }

        #admin-login-view {
            max-width: 400px;
            margin: 50px auto;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* ===== START: MODERN ADMIN MENU STYLES (NO ICONS, 2 ROWS) ===== */
        .admin-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .admin-menu .btn.menu-btn {
            background-color: #e9ecef;
            color: var(--text-color);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            flex-grow: 1; /* Allow buttons to grow */
        }
        .admin-menu .btn.menu-btn:hover {
            background-color: #ced4da;
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }
        .admin-menu .btn.menu-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .admin-menu .btn#reorder-menu-btn {
            background-color: var(--danger-color);
            color: white;
            flex-grow: 0; /* Prevent edit button from growing */
        }
        .admin-menu .btn#reorder-menu-btn:hover {
            background-color: #c82333;
        }

        body.dark-mode .admin-menu {
            border-bottom-color: var(--border-color);
        }
        body.dark-mode .admin-menu .btn.menu-btn {
            background-color: #333;
            color: #ccc;
        }
        body.dark-mode .admin-menu .btn.menu-btn:hover {
            background-color: #444;
        }
        body.dark-mode .admin-menu .btn.menu-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        /* ===== END: MODERN ADMIN MENU STYLES (NO ICONS, 2 ROWS) ===== */

        .admin-section { margin-bottom: 30px; }
        .admin-section h2 { text-align: left; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .admin-section h3 { text-align: left; }
        .admin-sub-content { display: none; }
        .admin-sub-content.active { display: block; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        
        .icon-preview, .bg-preview {
            display: block;
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border-color);
        }
        .bg-preview {
            width: 150px;
            height: 80px;
        }
        
        .logo-preview-container {
            width: 150px;
            height: 150px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
        }
        #logo-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .color-palette .color-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .frame-selector img {
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .frame-selector img:hover, .frame-selector img.active {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        #search-box {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        #font-preview, #global-font-preview {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s, text-shadow 0.3s;
        }

        #customer-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        #shop-logo-display {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
            margin: 0 auto;
        }

        #header-title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin: 0 auto;
        }
        
        .floating-buttons-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            gap: 10px;
        }

        #admin-gear-icon, #back-to-admin-btn, #theme-toggle-btn, #lang-toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, background-color 0.3s;
            padding: 5px;
            background-color: var(--surface-color);
            box-shadow: var(--shadow);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #admin-gear-icon:hover {
            transform: rotate(30deg);
            color: var(--primary-color);
        }
        #admin-gear-icon:active, #back-to-admin-btn:active, #theme-toggle-btn:active, #lang-toggle-btn:active {
            transform: scale(0.95);
        }

        #back-to-admin-btn {
            display: none;
        }
        #theme-toggle-btn {
            font-size: 1.2rem;
            color: #ffc107;
            display: none;
        }
        body.dark-mode #theme-toggle-btn {
            color: var(--secondary-color);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
        }
        .stat-card .icon { font-size: 2rem; margin-bottom: 10px; }
        .stat-card h3 { font-size: 1.2rem; color: #6c757d; margin-bottom: 5px; }
        .stat-card .value { font-size: 2rem; font-weight: 600; }
        .stat-card .change { font-size: 0.9rem; margin-top: 5px; }
        .stat-card .change.positive { color: var(--success-color); }
        .stat-card .change.negative { color: var(--danger-color); }
        
        #monthly-profit, #daily-orders, #monthly-orders, #yearly-sales {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .chart-container {
            height: 300px;
            width: 100%;
        }
        .top-selling-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .top-selling-list li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-selling-list li:last-child { border-bottom: none; }
        .top-selling-list li span:first-child { font-weight: 600; }
        
        #product-list-container {
            position: relative;
        }

        .customer-reset-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .customer-reset-btn:hover {
            transform: scale(1.1);
        }
        
        #stock-management-view .admin-section h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-list {
            list-style-type: none;
            padding: 0;
        }
        .price-list li {
            margin-bottom: 5px;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            transition: background-color: 0.3s;
        }

        .reorder-list {
            list-style-type: none;
            padding: 0;
        }
        .reorder-list li {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .reorder-list li.dragging {
            opacity: 0.5;
            border-style: dashed;
        }
        .reorder-list li .handle {
            font-size: 1.5rem;
            color: #6c757d;
            cursor: grab;
        }
        .menu-btn {
            flex-shrink: 0;
        }

        .effect-controls {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }
        .effect-controls label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .effect-controls input[type="range"] {
            margin: 0;
        }
        .effect-control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .low-stock-list {
            list-style: none;
            padding: 0;
        }
        .low-stock-list li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @keyframes blink { 50% { opacity: 0.2; } }
        .blinking-warning::before {
            content: '🔴';
            margin-right: 8px;
            animation: blink 1.2s linear infinite;
        }
        #top-items-controls .btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        #top-items-controls .btn {
            background-color: #e9ecef;
            color: var(--text-color);
        }
        .tax-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .performance-bar {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .performance-bar-inner {
            height: 100%;
            border-radius: 5px;
        }
        .performance-bar-inner.good { background-color: var(--success-color); }
        .performance-bar-inner.bad { background-color: var(--danger-color); }

        .product-row.product-unavailable {
            opacity: 0.6;
            background-color: #f8f9fa;
        }
        body.dark-mode .product-row.product-unavailable {
            background-color: #2a2a2a;
        }
        .product-row.product-unavailable .quantity-controls button {
            pointer-events: none;
            cursor: not-allowed;
        }
        .status-cell {
            text-align: center;
            font-weight: 500;
            color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 2rem; }
            .btn { width: 100%; }
            .quantity-controls .btn { width: auto; }
            .admin-header { flex-direction: column; align-items: stretch; }
            
            .order-buttons { 
                flex-direction: row; 
            }

            .floating-buttons-container {
                top: 10px;
                right: 10px;
                gap: 5px;
            }
            #admin-gear-icon, #back-to-admin-btn, #theme-toggle-btn, #lang-toggle-btn {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
            #customer-view-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            th, td { padding: 8px 10px; font-size: 0.9rem; }
            td img { width: 24px; height: 24px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            table { min-width: 100%; }
            
            .admin-menu .btn.menu-btn, .admin-menu .btn#reorder-menu-btn {
                flex-basis: calc(50% - 5px); /* 2 columns with 10px gap */
            }

            #order-summary {
                padding: 15px;
            }
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div id="loader-overlay">
        <div id="loader-background"></div>
        <div class="loader-content">
            <div class="spinner"></div>
            <p data-translate-key="loadingMessage">กำลังโหลดข้อมูลล่าสุด...</p>
            <div class="progress-bar"></div>
        </div>
    </div>
    <div id="background-overlay"></div>

    <div class="floating-buttons-container">
        <button id="admin-gear-icon" style="display: block;">⚙️</button>
        <button id="back-to-admin-btn" style="display: none;">⚙️</button>
        <button id="theme-toggle-btn" style="display: none;">☀️</button>
        <button id="lang-toggle-btn" style="display: none;">🌎</button>
    </div>

    <div class="container">
        <div id="customer-view" class="view active">
            <div id="customer-view-header">
                <header>
                    <div id="header-title-container">
                        <img id="shop-logo-display" src="" alt="โลโก้ร้าน" style="display: none;">
                        <h1 id="shop-name-display">WARISHAYDAY</h1>
                    </div>
                    <p id="slogan"></p>
                </header>
            </div>
            
            <main>
                <div id="category-tabs" class="card"></div>
                <input type="text" id="search-box" data-translate-key="searchPlaceholder" placeholder="ค้นหาสินค้า...">
                <div id="product-list-container" class="card">
                    <button id="reset-cart-btn" class="customer-reset-btn">🗑️</button>
                    <h2 id="current-category-name" data-translate-key="itemsListTitle"></h2>
                    <div class="table-wrapper">
                        <table id="product-table">
                            <thead>
                                <tr>
                                    <th data-translate-key="tableHeaderItem">สินค้า</th>
                                    <th data-translate-key="tableHeaderLevel">เลเวล</th>
                                    <th data-translate-key="tableHeaderQuantity">จำนวน</th>
                                    <th data-translate-key="tableHeaderManage">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="product-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="order-summary">
                    <div id="order-validation-message"></div>
                    <div class="order-buttons">
                        <button id="view-order-btn" class="btn btn-secondary" data-translate-key="viewOrderBtn">รายการสั่งซื้อ</button>
                        <button id="confirm-order-btn" class="btn btn-primary" data-translate-key="confirmOrderBtn">ยืนยันสั่งซื้อ</button>
                    </div>
                    <p id="copyright-footer" class="copyright-footer"></p>
                </div>
            </main>
        </div>

        <div id="admin-login-view" class="view">
            <div class="card">
                <h2 data-translate-key="adminLoginTitle">เข้าสู่ระบบหลังบ้าน</h2>
                <div class="form-group">
                    <label for="pin-input" data-translate-key="pinLabel">PIN</label>
                    <input type="password" id="pin-input" placeholder="กรอกรหัส PIN">
                </div>
                <button id="login-btn" class="btn btn-primary" data-translate-key="loginBtn">เข้าสู่ระบบ</button>
                <p id="login-error" style="color: var(--danger-color); margin-top: 10px;"></p>
                <button id="back-to-customer-view-btn" class="btn btn-secondary" style="margin-top: 15px;" data-translate-key="backToShopBtn">กลับหน้าหลักสั่งสินค้า</button>
            </div>
        </div>
        
        <div id="admin-panel-view" class="view">
            <div class="admin-header">
                <h2 data-translate-key="adminPanelTitle">Admin Panel</h2>
                <div style="display:flex; gap: 10px;">
                    <button id="view-shop-btn" class="btn btn-secondary" data-translate-key="viewShopBtn">มุมมองหน้าร้าน</button>
                    <button id="logout-btn" class="btn btn-danger" data-translate-key="logoutBtn">ออกจากระบบ</button>
                </div>
            </div>
            <div class="admin-menu"></div>

            <!-- UPDATE: Restructured Admin Content -->
            <div id="admin-menu-admin" class="admin-menu-content">
                <div class="tab-group-container" id="admin-settings-tabs"></div>
                <div class="card">
                    <div id="admin-sub-shop-info" class="admin-sub-content">
                        <h2 data-translate-key="shopInfoTitle">ข้อมูลร้าน</h2>
                        <div class="form-group">
                            <label for="shop-name" data-translate-key="shopNameLabel">ชื่อร้านค้า</label>
                            <input type="text" id="shop-name" placeholder="WARISHAYDAY">
                        </div>
                        <div class="form-group">
                            <label for="shop-slogan" data-translate-key="shopSloganLabel">สโลแกนร้าน</label>
                            <input type="text" id="shop-slogan" placeholder="เช่น บริการไว ใส่ใจทุกออเดอร์">
                        </div>
                        <div class="form-group">
                            <label for="manager-name" data-translate-key="managerNameLabel">ชื่อผู้จัดการระบบ</label>
                            <input type="text" id="manager-name" placeholder="ชื่อผู้จัดการ">
                        </div>
                        <div class="form-group">
                            <label for="shareholder-name" data-translate-key="shareholderNameLabel">ชื่อผู้ถือหุ้นใหญ่</label>
                            <input type="text" id="shareholder-name" placeholder="ชื่อผู้ถือหุ้น">
                        </div>
                         <div class="form-group">
                            <label for="order-format-select" data-translate-key="orderFormatLabel">รูปแบบเลขที่ออเดอร์</label>
                            <select id="order-format-select">
                                <option value="format1">ตัวอย่าง: WHD68/08/0001</option>
                                <option value="format2">ตัวอย่าง: WHD-20250820-0001</option>
                                <option value="format3">ตัวอย่าง: WHD-12345</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label data-translate-key="themeColorLabel">ธีมสี (Theme)</label>
                            <div class="color-palette">
                                <button class="btn btn-small color-btn" data-color="#28a745" style="background-color:#28a745;"></button>
                                <button class="btn btn-small color-btn" data-color="#007bff" style="background-color:#007bff;"></button>
                                <button class="btn btn-small color-btn" data-color="#6c757d" style="background-color:#6c757d;"></button>
                                <button class="btn btn-small color-btn" data-color="#17a2b8" style="background-color:#17a2b8;"></button>
                                <button class="btn btn-small color-btn" data-color="#ffc107" style="background-color:#ffc107;"></button>
                                <button class="btn btn-small color-btn" data-color="#dc3545" style="background-color:#dc3545;"></button>
                                <button class="btn btn-small color-btn" data-color="#343a40" style="background-color:#343a40;"></button>
                                <button class="btn btn-small color-btn" data-color="#6610f2" style="background-color:#6610f2;"></button>
                                <button class="btn btn-small color-btn" data-color="#e83e8c" style="background-color:#e83e8c;"></button>
                                <button class="btn btn-small color-btn" data-color="#fd7e14" style="background-color:#fd7e14;"></button>
                                <button class="btn btn-small color-btn" data-color="#20c997" style="background-color:#20c997;"></button>
                                <button class="btn btn-small color-btn" data-color="#f8f9fa" style="background-color:#f8f9fa; border: 1px solid #ccc;"></button>
                            </div>
                        </div>
                        <button id="save-shop-info-btn" class="btn btn-primary" data-translate-key="saveSettingsBtn">บันทึกข้อมูลร้าน</button>
                    </div>
                    <div id="admin-sub-system-fonts" class="admin-sub-content">
                        <h2 data-translate-key="systemFontsTitle">System Fonts</h2>
                        <div class="form-group">
                            <label for="shop-font" data-translate-key="shopNameFontLabel">ฟอนต์ชื่อร้าน</label>
                            <select id="shop-font"></select>
                            <div id="font-preview" style="font-family: 'Kanit', sans-serif;">WARISHAYDAY</div>
                        </div>
                        <div class="form-group">
                            <div class="toggle-switch-container">
                                <label data-translate-key="enableEffectLabel">เปิดใช้เอฟเฟกต์ชื่อร้าน</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="effect-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="effect-controls" id="effect-controls-container" style="display: none;">
                                <label><span data-translate-key="effectOffsetX">เงาแนวนอน (X)</span> <input type="range" id="effect-offset-x" min="-10" max="10" value="2"></label>
                                <label><span data-translate-key="effectOffsetY">เงาแนวตั้ง (Y)</span> <input type="range" id="effect-offset-y" min="-10" max="10" value="2"></label>
                                <label><span data-translate-key="effectBlur">ความเบลอ</span> <input type="range" id="effect-blur" min="0" max="20" value="4"></label>
                                <div class="effect-control-item">
                                    <label for="effect-color" data-translate-key="effectColor">สีเงา</label>
                                    <input type="color" id="effect-color" value="#000000">
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="form-group">
                            <label for="shop-global-font" data-translate-key="globalFontLabel">ฟอนต์ระบบทั้งหมด</label>
                            <select id="shop-global-font"></select>
                            <div id="global-font-preview" style="font-family: 'Kanit', sans-serif;" data-translate-key="fontPreviewText">ตัวอย่างฟอนต์ระบบ</div>
                        </div>
                        <hr>
                        <div class="form-group">
                            <div class="toggle-switch-container">
                                <label data-translate-key="useLogoLabel">ใช้โลโก้</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="logo-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <label for="logo-upload" data-translate-key="uploadLogoLabel">อัปโหลดโลโก้ (PNG)</label>
                            <input type="file" id="logo-upload" accept="image/png">
                            <div class="logo-preview-container">
                                <img id="logo-preview" src="" alt="พรีวิวโลโก้" style="display: none;">
                            </div>
                        </div>
                        <hr>
                        <div class="form-group">
                            <label for="copyright-text" data-translate-key="copyrightTextLabel">ข้อความ Copyright</label>
                            <input type="text" id="copyright-text">
                            <label for="copyright-opacity" data-translate-key="copyrightOpacityLabel">ความคมชัด</label>
                            <input type="range" id="copyright-opacity" min="0" max="1" step="0.1" value="1">
                        </div>
                        <button id="save-system-fonts-btn" class="btn btn-primary" data-translate-key="saveSettingsBtn">บันทึกการตั้งค่า</button>
                    </div>
                    <div id="admin-sub-background" class="admin-sub-content">
                        <h2 data-translate-key="backgroundSettingsTitle">ตั้งค่าพื้นหลัง</h2>
                        <div class="form-group">
                            <label for="bg-upload" data-translate-key="uploadBgLabel">อัปโหลดภาพพื้นหลัง</label>
                            <input type="file" id="bg-upload" accept="image/*">
                            <div id="bg-preview" class="bg-preview" style="display: none;"></div>
                            <label for="bg-opacity" data-translate-key="bgOpacityLabel">ความโปร่งใส (จาง-ชัด)</label>
                            <input type="range" id="bg-opacity" min="0.1" max="1" step="0.05" value="1">
                            <label for="bg-blur" data-translate-key="bgBlurLabel">ความเบลอ (น้อย-มาก)</label>
                            <input type="range" id="bg-blur" min="0" max="20" step="1" value="0">
                            <div class="btn-group" style="margin-top: 10px;">
                                <button type="button" id="remove-bg-btn" class="btn btn-danger btn-small" data-translate-key="removeBgBtn">ลบพื้นหลัง</button>
                                <button type="button" id="preview-bg-btn" class="btn btn-info btn-small" data-translate-key="previewBgBtn">ดูตัวอย่าง</button>
                            </div>
                        </div>
                        <button id="save-background-settings-btn" class="btn btn-primary" data-translate-key="saveSettingsBtn">บันทึกพื้นหลัง</button>
                    </div>
                    <div id="admin-sub-loading-bg" class="admin-sub-content">
                        <h2 data-translate-key="loadingBackgroundTitle">พื้นหลัง Loading</h2>
                        <div class="form-group">
                            <label for="loading-bg-upload" data-translate-key="uploadLoadingBgLabel">อัปโหลดภาพพื้นหลัง</label>
                            <input type="file" id="loading-bg-upload" accept="image/*">
                            <div id="loading-bg-preview" class="bg-preview" style="display: none;"></div>
                            <label for="loading-bg-opacity" data-translate-key="bgOpacityLabel">ความโปร่งใส (จาง-ชัด)</label>
                            <input type="range" id="loading-bg-opacity" min="0.1" max="1" step="0.05" value="0.7">
                            <button type="button" id="remove-loading-bg-btn" class="btn btn-danger btn-small" data-translate-key="removeBgBtn" style="margin-top: 10px;">ลบพื้นหลัง</button>
                        </div>
                        <button id="save-loading-bg-settings-btn" class="btn btn-primary" data-translate-key="saveSettingsBtn">บันทึกพื้นหลัง Loading</button>
                    </div>
                    <div id="admin-sub-pin" class="admin-sub-content">
                        <h2 data-translate-key="changePinTitle">เปลี่ยนรหัสผ่าน</h2>
                        <div class="form-group">
                            <label for="new-pin" data-translate-key="newPinLabel">PIN ใหม่</label>
                            <input type="password" id="new-pin" placeholder="กรอก PIN ใหม่อย่างน้อย 4 ตัว">
                        </div>
                        <button id="change-pin-btn" class="btn btn-primary" data-translate-key="saveNewPinBtn">บันทึก PIN ใหม่</button>
                    </div>
                </div>
            </div>

            <div id="admin-menu-stock" class="admin-menu-content" style="display: none;">
                <div class="tab-group-container" id="admin-stock-tabs"></div>
                <div id="admin-sub-categories" class="admin-sub-content">
                    <div class="card admin-section">
                        <h2 data-translate-key="manageCategoriesTitle">จัดการหมวดหมู่</h2>
                        <form id="category-form">
                            <input type="hidden" id="cat-id">
                            <div class="form-group">
                                <label for="cat-name" data-translate-key="categoryNameLabel">ชื่อหมวดหมู่</label>
                                <input type="text" id="cat-name" placeholder="ชื่อหมวดหมู่" required>
                            </div>
                            <div class="form-group">
                                <label for="cat-icon-upload" data-translate-key="categoryIconLabel">ไอค่อนหมวดหมู่ (ไฟล์ PNG)</label>
                                <input type="file" id="cat-icon-upload" accept="image/png">
                                <div id="cat-icon-preview" class="icon-preview" style="background-image: none;"></div>
                            </div>
                            <div class="form-group">
                                <label for="cat-min-order" data-translate-key="minOrderLabel">จำนวนสั่งซื้อขั้นต่ำ</label>
                                <input type="number" id="cat-min-order" value="30" min="0">
                            </div>
                            <div class="form-group">
                                <label data-translate-key="setPriceLabel">ตั้งค่าราคา</label>
                                <div class="btn-group">
                                    <button type="button" id="set-per-piece-price-btn" class="btn btn-info" data-translate-key="setPerPiecePriceBtn">ตั้งราคาต่อชิ้น</button>
                                </div>
                            </div>
                            <button type="submit" id="submit-cat-btn" class="btn btn-primary" data-translate-key="saveCategoryBtn">เพิ่ม/บันทึกหมวดหมู่</button>
                            <button type="button" id="cancel-cat-edit-btn" class="btn btn-secondary" style="display:none;" data-translate-key="cancelBtn">ยกเลิก</button>
                        </form>
                        <hr style="margin: 20px 0;">
                        <h3 data-translate-key="categoryListTitle">รายการหมวดหมู่</h3>
                        <div class="table-wrapper">
                            <table id="admin-cat-table">
                                <thead><tr><th data-translate-key="tableHeaderIcon">ไอค่อน</th><th data-translate-key="tableHeaderName">ชื่อ</th><th data-translate-key="tableHeaderMinOrder">ขั้นต่ำ</th><th data-translate-key="tableHeaderPrice">ราคา</th><th data-translate-key="tableHeaderManage">แก้ไข/ลบ</th></tr></thead>
                                <tbody id="admin-cat-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-sub-products" class="admin-sub-content">
                     <div class="card admin-section">
                        <h2 data-translate-key="manageProductsTitle">จัดการสินค้า</h2>
                        <form id="product-form">
                            <input type="hidden" id="product-id">
                            <div class="form-group">
                                <label for="prod-name" data-translate-key="productNameLabel">ชื่อสินค้า</label>
                                <input type="text" id="prod-name" placeholder="ชื่อสินค้า" required>
                            </div>
                            <div class="form-group">
                                <label for="prod-level" data-translate-key="levelLabel">เลเวล</label>
                                <input type="number" id="prod-level" required>
                            </div>
                            <div class="form-group">
                                <label for="prod-stock" data-translate-key="stockQuantityLabel">จำนวนคงเหลือ</label>
                                <input type="number" id="prod-stock" value="-1" required>
                            </div>
                            <div class="form-group">
                                <label for="prod-category" data-translate-key="categoryLabel">หมวดหมู่</label>
                                <select id="prod-category" required></select>
                            </div>
                            <div class="form-group">
                                <label for="prod-icon-upload" data-translate-key="productIconLabel">ไอค่อนสินค้า (ไฟล์ PNG)</label>
                                <input type="file" id="prod-icon-upload" accept="image/png">
                                <div id="prod-icon-preview" class="icon-preview" style="background-image: none;"></div>
                            </div>
                            <div class="form-group">
                                <div class="toggle-switch-container">
                                    <label data-translate-key="productAvailableLabel">เปิดขายสินค้านี้</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="prod-available" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" data-translate-key="saveProductBtn">บันทึกสินค้า</button>
                            <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;" data-translate-key="cancelEditBtn">ยกเลิกแก้ไข</button>
                        </form>
                        <hr style="margin: 20px 0;">
                        <div id="admin-product-tabs" class="card"></div>
                        <h3 id="admin-current-category-name"></h3>
                        <div class="table-wrapper">
                            <table id="admin-prod-table">
                                <thead><tr><th data-translate-key="tableHeaderIcon">ไอค่อน</th><th data-translate-key="tableHeaderName">ชื่อ</th><th data-translate-key="tableHeaderLevel">เลเวล</th><th data-translate-key="tableHeaderStock">คงเหลือ</th><th data-translate-key="tableHeaderStatus">สถานะ</th><th data-translate-key="tableHeaderManage">แก้ไข/ลบ</th></tr></thead>
                                <tbody id="admin-prod-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-menu-order-number" class="admin-menu-content" style="display: none;">
                <div class="tab-group-container" id="admin-order-tabs"></div>
                 <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap;">
                    <label for="order-date-picker" data-translate-key="selectDateLabel">เลือกวันที่:</label>
                    <input type="text" id="order-date-picker" style="width: 150px;" placeholder="ดูออเดอร์ทั้งหมด">
                    <button id="reset-orders-btn" class="btn btn-danger btn-small" data-translate-key="resetDataBtn">รีเซ็ทข้อมูล</button>
                </div>
                <div id="admin-sub-active-orders" class="admin-sub-content">
                    <div class="card admin-section">
                        <h2 data-translate-key="activeOrdersTitle">รายการออเดอร์ปัจจุบัน</h2>
                        <div class="table-wrapper">
                            <table id="active-orders-table">
                                <thead><tr><th data-translate-key="tableHeaderOrderNo">เลขออเดอร์</th><th data-translate-key="tableHeaderDateTime">วันที่/เวลา</th><th data-translate-key="tableHeaderTotal">ยอดรวม</th><th data-translate-key="tableHeaderManage">จัดการ</th></tr></thead>
                                <tbody id="active-orders-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-sub-cancelled-orders" class="admin-sub-content">
                    <div class="card admin-section">
                        <h2 data-translate-key="cancelledOrdersTitle">รายการออเดอร์ที่ถูกยกเลิก</h2>
                        <div class="table-wrapper">
                            <table id="cancelled-orders-table">
                                <thead><tr><th data-translate-key="tableHeaderOrderNo">เลขออเดอร์</th><th data-translate-key="tableHeaderDateTime">วันที่/เวลา</th><th data-translate-key="tableHeaderTotal">ยอดรวม</th><th data-translate-key="tableHeaderManage">จัดการ</th></tr></thead>
                                <tbody id="cancelled-orders-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-menu-dashboard" class="admin-menu-content" style="display: none;">
                <h2 data-translate-key="dashboardTitle">ภาพรวมร้านค้า</h2>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap;">
                    <label for="date-picker" data-translate-key="selectDateLabel">เลือกวันที่:</label>
                    <input type="text" id="date-picker" style="width: 150px;">
                    <button id="reset-analytics-btn" class="btn btn-danger btn-small" data-translate-key="resetDataBtn">รีเซ็ทข้อมูล</button>
                </div>
                
                <div class="dashboard-grid">
                    <div class="stat-card" style="background-color: var(--success-color); color: white;">
                        <h3 data-translate-key="monthlyProfitTitle">กำไรเดือนนี้</h3>
                        <div class="value" id="monthly-profit">0 บาท</div>
                    </div>
                    <div class="stat-card" style="background-color: var(--info-color); color: white;">
                        <h3 data-translate-key="dailyOrdersTitle">ยอดออเดอร์วันนี้</h3>
                        <div class="value" id="daily-orders">0</div>
                    </div>
                    <div class="stat-card" style="background-color: var(--warning-color); color: #333;">
                        <h3 data-translate-key="monthlyOrdersTitle">ยอดออเดอร์เดือนนี้</h3>
                        <div class="value" id="monthly-orders">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-translate-key="yearlySalesTitle">ยอดขายรวม (ปีนี้)</h3>
                        <div class="value" id="yearly-sales">0 บาท</div>
                    </div>
                </div>

                 <div class="dashboard-grid">
                    <div class="card admin-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                            <h2 data-translate-key="lowStockTitle" style="margin-bottom:0; border:0; padding:0;">สินค้าที่ต้องเติม (10 อันดับ)</h2>
                            <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center; gap: 5px;">
                                <label for="low-stock-threshold" data-translate-key="lowStockThresholdLabel" style="margin-bottom: 0; white-space: nowrap;">แจ้งเตือนเมื่อเหลือน้อยกว่า:</label>
                                <input type="number" id="low-stock-threshold" value="50" style="width: 80px; display: inline-block; padding: 5px; margin-bottom: 0;">
                            </div>
                        </div>
                        <p data-translate-key="lowStockInfo">รบกวนเติมสินค้าสำหรับรายการที่มีไฟกระพริบ</p>
                        <ol id="low-stock-list" class="low-stock-list"></ol>
                    </div>
                    <div class="card admin-section">
                        <h2 data-translate-key="categorySalesTitle">ยอดขายตามหมวดหมู่</h2>
                        <div class="chart-container"><canvas id="categorySalesChart"></canvas></div>
                    </div>
                </div>

                <div class="card admin-section">
                    <h2 data-translate-key="topSellingTitle">สินค้าขายดี (Top 5)</h2>
                    <div id="top-items-controls" class="btn-group" style="justify-content: center; margin-bottom: 15px;">
                        <button class="btn btn-small" data-period="day" data-translate-key="periodDay">วันนี้</button>
                        <button class="btn btn-small" data-period="month" data-translate-key="periodMonth">เดือนนี้</button>
                        <button class="btn btn-small" data-period="year" data-translate-key="periodYear">ปีนี้</button>
                    </div>
                    <ol id="top-items-list" class="top-selling-list"></ol>
                </div>
                
                <div class="card admin-section">
                    <h2 data-translate-key="trafficStatsTitle">สถิติการเข้าใช้งาน</h2>
                    <p id="most-active-day"></p>
                    <p id="most-active-time"></p>
                    <div class="chart-container"><canvas id="dailyTrafficChart"></canvas></div>
                </div>

                <div class="card admin-section">
                    <h2 data-translate-key="productStatsTitle">สถิติสินค้า (ตามจำนวนที่สั่ง)</h2>
                    <p id="best-selling-product"></p>
                    <p id="least-selling-product"></p>
                    <div class="chart-container"><canvas id="productSalesChart"></canvas></div>
                </div>
            </div>

            <div id="admin-menu-manage-account" class="admin-menu-content" style="display: none;">
                <div class="card admin-section">
                    <h2 data-translate-key="manageAccountTitle">จัดการบัญชี</h2>
                    <p data-translate-key="subAdminLimitInfo">จำกัดจำนวนผู้ใช้ย่อยได้สูงสุด 20 คน</p>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <form id="sub-admin-form" style="flex-grow: 1;">
                            <input type="hidden" id="sub-admin-id">
                            <div class="form-group">
                                <label for="sub-admin-name" data-translate-key="usernameLabel">ชื่อผู้ใช้</label>
                                <input type="text" id="sub-admin-name" placeholder="เช่น แอดมิน A" required>
                            </div>
                            <div class="form-group">
                                <label for="sub-admin-pin" data-translate-key="pinLabel">PIN</label>
                                <input type="password" id="sub-admin-pin" placeholder="กรอก PIN (อย่างน้อย 4 ตัว)" required>
                            </div>
                            <button type="submit" id="add-sub-admin-btn" class="btn btn-primary" data-translate-key="addUserBtn">เพิ่มผู้ใช้</button>
                            <button type="button" id="cancel-sub-admin-edit" class="btn btn-secondary" style="display:none;" data-translate-key="cancelBtn">ยกเลิก</button>
                        </form>
                        <button type="button" id="view-permissions-btn" class="btn btn-info" style="font-size: 1.5rem; padding: 10px; height: 50px;">
                            <span class="view-icon">👁️</span>
                        </button>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h3 data-translate-key="subAdminListTitle">รายการผู้ใช้ย่อย</h3>
                    <div class="table-wrapper">
                        <table id="sub-admin-table">
                            <thead><tr><th data-translate-key="tableHeaderName">ชื่อ</th><th data-translate-key="pinLabel">PIN</th><th data-translate-key="tableHeaderManage">จัดการ</th></tr></thead>
                            <tbody id="sub-admin-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <div id="copy-success-modal" class="modal">
        <div class="copy-success-content">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
            <p data-translate-key="copySuccessMessage">คัดลอกออเดอร์สำเร็จ</p>
        </div>
    </div>

    <div id="order-modal" class="modal">
        <div class="modal-content">
            <h2 id="order-modal-title" data-translate-key="orderSummaryTitle">สรุปออเดอร์</h2>
            <p id="order-modal-prompt" data-translate-key="copyOrderPrompt">กรุณาคัดลอกข้อความด้านล่างเพื่อส่งให้ทางร้าน</p>
            <div id="order-details"></div>
            <div class="modal-actions">
                <button id="copy-order-btn" class="btn btn-danger" data-translate-key="copyOrderBtn">คัดลอกออเดอร์</button>
                <button id="close-order-modal-btn" class="btn btn-secondary" data-translate-key="closeBtn">ปิด</button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content: space-between; align-items:center; flex-wrap: wrap;">
                <h2 data-translate-key="yourOrderListTitle">รายการสั่งซื้อของคุณ</h2>
            </div>
            <div id="cart-details"></div>
            <div class="modal-actions">
                <button id="close-cart-modal-btn" class="btn btn-secondary" data-translate-key="closeBtn">ปิด</button>
            </div>
        </div>
    </div>

    <div id="pin-confirm-modal" class="modal">
        <div class="modal-content">
            <h2 data-translate-key="confirmPinTitle">ยืนยันรหัส PIN</h2>
            <div class="form-group">
                <label for="pin-confirm-input" data-translate-key="enterPinPrompt">กรอกรหัส PIN เพื่อยืนยัน</label>
                <input type="password" id="pin-confirm-input" placeholder="รหัส PIN">
            </div>
            <p id="pin-confirm-error" style="color: var(--danger-color); margin-bottom: 15px;"></p>
            <div class="modal-actions">
                <button id="confirm-action-btn" class="btn btn-danger" data-translate-key="confirmBtn">ยืนยัน</button>
                <button id="cancel-action-btn" class="btn btn-secondary" data-translate-key="cancelBtn">ยกเลิก</button>
            </div>
        </div>
    </div>
    
    <div id="reset-confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="reset-modal-title" data-translate-key="confirmResetTitle">ยืนยันการรีเซ็ทข้อมูล</h2>
            <p data-translate-key="selectResetPeriodPrompt">กรุณาเลือกช่วงเวลาที่ต้องการรีเซ็ทข้อมูล</p>
            <div class="form-group">
                <select id="reset-period-select">
                    <option value="day" data-translate-key="periodDay">เฉพาะวันนี้</option>
                    <option value="week" data-translate-key="periodWeek">สัปดาห์นี้</option>
                    <option value="month" data-translate-key="periodMonth">เดือนนี้</option>
                    <option value="all" data-translate-key="periodAll">ข้อมูลทั้งหมด</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="confirm-reset-btn" class="btn btn-danger" data-translate-key="confirmBtn">ยืนยัน</button>
                <button id="cancel-reset-btn" class="btn btn-secondary" data-translate-key="cancelBtn">ยกเลิก</button>
            </div>
        </div>
    </div>

    <div id="per-piece-price-modal" class="modal">
        <div class="modal-content price-list-modal-content">
            <h2 data-translate-key="setPerPiecePriceTitle">ตั้งราคาต่อชิ้น</h2>
            <p data-translate-key="setPerPiecePriceInfo">กำหนดราคาสำหรับทุกๆ 10 ชิ้น</p>
            <form id="per-piece-price-form"></form>
            <hr>
            <div class="modal-actions">
                <button id="save-per-piece-price-btn" class="btn btn-primary" data-translate-key="savePriceBtn">บันทึกราคา</button>
                <button id="close-per-piece-price-modal-btn" class="btn btn-secondary" data-translate-key="closeBtn">ปิด</button>
            </div>
        </div>
    </div>

    <div id="bulk-price-modal" class="modal">
        <div class="modal-content price-list-modal-content">
            <h2 data-translate-key="setBulkPriceTitle">ตั้งราคาเหมา</h2>
            <p data-translate-key="setBulkPriceInfo">กำหนดราคาสำหรับช่วงจำนวนชิ้น</p>
            <form id="bulk-price-form"></form>
            <hr>
            <div class="modal-actions">
                <button id="save-bulk-price-btn" class="btn btn-primary" data-translate-key="savePriceBtn">บันทึกราคา</button>
                <button id="close-bulk-price-modal-btn" class="btn btn-secondary" data-translate-key="closeBtn">ปิด</button>
            </div>
        </div>
    </div>

    <div id="reorder-menu-modal" class="modal">
        <div class="modal-content">
            <h2 data-translate-key="reorderMenuTitle">จัดเรียงเมนู</h2>
            <p data-translate-key="reorderMenuInfo">ลากและวางเพื่อจัดลำดับเมนูตามต้องการ</p>
            <ul id="reorder-menu-list" class="reorder-list"></ul>
            <div class="modal-actions">
                <button id="save-menu-order-btn" class="btn btn-primary" data-translate-key="saveOrderBtn">บันทึกการจัดเรียง</button>
                <button id="close-reorder-menu-modal-btn" class="btn btn-secondary" data-translate-key="closeBtn">ปิด</button>
            </div>
        </div>
    </div>
    
    <div id="permission-modal" class="modal">
        <div class="modal-content">
            <h2 data-translate-key="setPermissionsTitle">ตั้งค่าสิทธิ์การเข้าถึง</h2>
            <p id="permission-user-name" style="font-weight: bold;"></p>
            <ul id="permission-list" style="list-style: none; padding: 0;"></ul>
            <hr>
            <div class="modal-actions">
                <button id="save-permissions-btn" class="btn btn-primary" data-translate-key="savePermissionsBtn">บันทึกสิทธิ์</button>
                <button id="close-permission-modal-btn" class="btn btn-secondary" data-translate-key="closeBtn">ปิด</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_ENDPOINT = '/.netlify/functions/data';

        let appData = {
            categories: [],
            products: [],
            cart: {},
            adminPin: '210406',
            subAdmins: [],
            shopSettings: {
                shopName: "WARISHAYDAY",
                slogan: "ร้านค้าไอเท็ม Hay Day",
                managerName: "", // NEW
                shareholderName: "", // NEW
                themeColor: "#28a745",
                fontFamily: "'Kanit', sans-serif",
                globalFontFamily: "'Kanit', sans-serif",
                orderNumberFormat: 'format1',
                orderNumberCounters: { format1: 1, format2: 1, format3: 1 },
                logo: null,
                useLogo: false,
                darkMode: false,
                shopNameEffect: {
                    enabled: false,
                    offsetX: 2,
                    offsetY: 2,
                    blur: 4,
                    color: '#000000'
                },
                backgroundImage: null,
                backgroundOpacity: 1,
                backgroundBlur: 0,
                loadingBackgroundImage: null,
                loadingBackgroundOpacity: 0.7,
                language: 'th',
                lowStockThreshold: 50,
                copyrightText: "Copyright © 2025 Warishayday", // NEW
                copyrightOpacity: 1, // NEW
            },
            analytics: {
                dailyTraffic: Array(7).fill(0),
                hourlyTraffic: Array(24).fill(0),
                productSales: {},
                orders: [],
                totalSales: 0,
                monthlyProfit: 0
            },
            menuOrder: [
                'admin', 'stock', 'order-number', 'dashboard', 'manage-account'
            ]
        };

        const FONT_OPTIONS = [
            { name: "Kanit", value: "'Kanit', sans-serif" },
            { name: "Chakra Petch", value: "'Chakra Petch', sans-serif" },
            { name: "IBM Plex Sans Thai", value: "'IBM Plex Sans Thai', sans-serif" },
            { name: "Sarabun", value: "'Sarabun', sans-serif" },
            { name: "Prompt", value: "'Prompt', sans-serif" },
            { name: "Mali", value: "'Mali', sans-serif" },
            { name: "Anuphan", value: "'Anuphan', sans-serif" },
            { name: "Taviraj", value: "'Taviraj', serif" },
            { name: "Trirong", value: "'Trirong', serif" },
        ];
        
        const translations = {
            th: {
                loadingMessage: "กำลังโหลดข้อมูลล่าสุด...",
                closeBtn: "ปิด", cancelBtn: "ยกเลิก", confirmBtn: "ยืนยัน", saveBtn: "บันทึก", editBtn: "แก้ไข", deleteBtn: "ลบ",
                searchPlaceholder: "ค้นหาสินค้า...", itemsListTitle: "รายการสินค้า", tableHeaderItem: "สินค้า", tableHeaderLevel: "เลเวล", tableHeaderQuantity: "จำนวน", tableHeaderManage: "จัดการ",
                viewOrderBtn: "รายการสั่งซื้อ", confirmOrderBtn: "ยืนยันสั่งซื้อ", totalAmount: "ยอดรวม",
                adminLoginTitle: "เข้าสู่ระบบหลังบ้าน", pinLabel: "PIN", loginBtn: "เข้าสู่ระบบ", backToShopBtn: "กลับหน้าหลักสั่งสินค้า", invalidPinError: "PIN ไม่ถูกต้อง!",
                adminPanelTitle: "Admin Panel", viewShopBtn: "มุมมองหน้าร้าน", logoutBtn: "ออกจากระบบ",
                menuAdmin: "ตั้งค่าร้าน", menuStock: "สต๊อกสินค้า", menuOrderNumber: "Order Number", menuDashboard: "Dashboard", menuManageAccount: "Manage account", editMenuOrderBtn: "EDIT",
                
                shopInfoTitle: "ข้อมูลร้าน",
                systemFontsTitle: "System Fonts",
                fontPreviewText: "ตัวอย่างฟอนต์ระบบ",
                shopNameLabel: "ชื่อร้านค้า", shopSloganLabel: "สโลแกนร้าน", 
                managerNameLabel: "ชื่อผู้จัดการระบบ",
                shareholderNameLabel: "ชื่อผู้ถือหุ้นใหญ่",
                globalFontLabel: "ฟอนต์ระบบทั้งหมด", shopNameFontLabel: "ฟอนต์ชื่อร้าน",
                enableEffectLabel: "เปิดใช้เอฟเฟกต์ชื่อร้าน", effectOffsetX: "เงาแนวนอน (X)", effectOffsetY: "เงาแนวตั้ง (Y)", effectBlur: "ความเบลอ", effectColor: "สีเงา",
                orderFormatLabel: "รูปแบบเลขที่ออเดอร์", useLogoLabel: "ใช้โลโก้", uploadLogoLabel: "อัปโหลดโลโก้ (PNG)",
                backgroundSettingsTitle: "ตั้งค่าพื้นหลัง", uploadBgLabel: "อัปโหลดภาพพื้นหลัง", bgOpacityLabel: "ความโปร่งใส (จาง-ชัด)", bgBlurLabel: "ความเบลอ (น้อย-มาก)",
                removeBgBtn: "ลบพื้นหลัง", previewBgBtn: "ดูตัวอย่าง", themeColorLabel: "ธีมสี (Theme)", saveSettingsBtn: "บันทึกการตั้งค่า",
                copyrightTextLabel: "ข้อความ Copyright",
                copyrightOpacityLabel: "ความคมชัด",

                changePinTitle: "เปลี่ยนรหัสผ่าน", newPinLabel: "PIN ใหม่", saveNewPinBtn: "บันทึก PIN ใหม่",
                manageCategoriesTitle: "จัดการหมวดหมู่", categoryNameLabel: "ชื่อหมวดหมู่", categoryIconLabel: "ไอค่อนหมวดหมู่ (ไฟล์ PNG)", minOrderLabel: "จำนวนสั่งซื้อขั้นต่ำ",
                setPriceLabel: "ตั้งค่าราคา", setPerPiecePriceBtn: "ตั้งราคาต่อชิ้น", saveCategoryBtn: "เพิ่ม/บันทึกหมวดหมู่", categoryListTitle: "รายการหมวดหมู่",
                tableHeaderIcon: "ไอค่อน", tableHeaderName: "ชื่อ", tableHeaderMinOrder: "ขั้นต่ำ", tableHeaderPrice: "ราคา",
                manageProductsTitle: "จัดการสินค้า", productNameLabel: "ชื่อสินค้า", levelLabel: "เลเวล", stockQuantityLabel: "จำนวนคงเหลือ", categoryLabel: "หมวดหมู่",
                productIconLabel: "ไอค่อนสินค้า (ไฟล์ PNG)", productAvailableLabel: "เปิดขายสินค้านี้", saveProductBtn: "บันทึกสินค้า", cancelEditBtn: "ยกเลิกแก้ไข",
                tableHeaderStock: "คงเหลือ", tableHeaderStatus: "สถานะ", statusAvailable: "เปิดขาย", statusUnavailable: "ปิดขาย",
                selectDateLabel: "เลือกวันที่:", resetDataBtn: "รีเซ็ทข้อมูล", activeOrdersTitle: "รายการออเดอร์ปัจจุบัน", cancelledOrdersTitle: "รายการออเดอร์ที่ถูกยกเลิก",
                tableHeaderOrderNo: "เลขออเดอร์", tableHeaderDateTime: "วันที่/เวลา", tableHeaderTotal: "ยอดรวม", viewDetailsBtn: "ดูรายละเอียด", cancelOrderBtn: "ยกเลิก",
                dashboardTitle: "ภาพรวมร้านค้า", monthlyProfitTitle: "กำไรเดือนนี้", dailyOrdersTitle: "ยอดออเดอร์วันนี้", monthlyOrdersTitle: "ยอดออเดอร์เดือนนี้", yearlySalesTitle: "ยอดขายรวม (ปีนี้)",
                lowStockTitle: "สินค้าที่ต้องเติม (10 อันดับ)", lowStockThresholdLabel: "แจ้งเตือนเมื่อเหลือน้อยกว่า:", lowStockInfo: "รบกวนเติมสินค้าสำหรับรายการที่มีไฟกระพริบ",
                noLowStockItems: "ไม่มีสินค้าใกล้หมด", categorySalesTitle: "ยอดขายตามหมวดหมู่", topSellingTitle: "สินค้าขายดี (Top 5)",
                periodDay: "วันนี้", periodMonth: "เดือนนี้", periodYear: "ปีนี้", trafficStatsTitle: "สถิติการเข้าใช้งาน", productStatsTitle: "สถิติสินค้า (ตามจำนวนที่สั่ง)",
                manageAccountTitle: "จัดการบัญชี", subAdminLimitInfo: "จำกัดจำนวนผู้ใช้ย่อยได้สูงสุด 20 คน", usernameLabel: "ชื่อผู้ใช้", addUserBtn: "เพิ่มผู้ใช้", subAdminListTitle: "รายการผู้ใช้ย่อย",
                orderSummaryTitle: "สรุปออเดอร์", copyOrderPrompt: "กรุณาคัดลอกข้อความด้านล่างเพื่อส่งให้ทางร้าน", copyOrderBtn: "คัดลอกออเดอร์", copySuccessMessage: "คัดลอกออเดอร์สำเร็จ",
                yourOrderListTitle: "รายการสั่งซื้อของคุณ", confirmPinTitle: "ยืนยันรหัส PIN", enterPinPrompt: "กรอกรหัส PIN เพื่อยืนยัน",
                confirmResetTitle: "ยืนยันการรีเซ็ทข้อมูล", selectResetPeriodPrompt: "กรุณาเลือกช่วงเวลาที่ต้องการรีเซ็ทข้อมูล", periodWeek: "สัปดาห์นี้", periodAll: "ข้อมูลทั้งหมด",
                setPerPiecePriceTitle: "ตั้งราคาต่อชิ้น", setPerPiecePriceInfo: "กำหนดราคาสำหรับทุกๆ 10 ชิ้น", savePriceBtn: "บันทึกราคา",
                reorderMenuTitle: "จัดเรียงเมนู", reorderMenuInfo: "ลากและวางเพื่อจัดลำดับเมนูตามต้องการ", saveOrderBtn: "บันทึกการจัดเรียง",
                setPermissionsTitle: "ตั้งค่าสิทธิ์การเข้าถึง", savePermissionsBtn: "บันทึกสิทธิ์",
                loadingBackgroundTitle: "พื้นหลัง Loading", uploadLoadingBgLabel: "อัปโหลดภาพพื้นหลัง Loading",
            },
            en: {
                loadingMessage: "Loading latest data...",
                closeBtn: "Close", cancelBtn: "Cancel", confirmBtn: "Confirm", saveBtn: "Save", editBtn: "Edit", deleteBtn: "Delete",
                searchPlaceholder: "Search for items...", itemsListTitle: "Item List", tableHeaderItem: "Item", tableHeaderLevel: "Level", tableHeaderQuantity: "Quantity", tableHeaderManage: "Manage",
                viewOrderBtn: "View Order", confirmOrderBtn: "Confirm Order", totalAmount: "Total",
                adminLoginTitle: "Admin Login", pinLabel: "PIN", loginBtn: "Login", backToShopBtn: "Back to Shop", invalidPinError: "Invalid PIN!",
                adminPanelTitle: "Admin Panel", viewShopBtn: "View Shop", logoutBtn: "Logout",
                menuAdmin: "Shop Settings", menuStock: "Stock", menuOrderNumber: "Order Number", menuDashboard: "Dashboard", menuManageAccount: "Manage Account", editMenuOrderBtn: "EDIT",
                
                shopInfoTitle: "Shop Information",
                systemFontsTitle: "System Fonts",
                fontPreviewText: "System Font Preview",
                shopNameLabel: "Shop Name", shopSloganLabel: "Shop Slogan",
                managerNameLabel: "System Manager Name",
                shareholderNameLabel: "Major Shareholder Name",
                globalFontLabel: "Global Font", shopNameFontLabel: "Shop Name Font",
                enableEffectLabel: "Enable Shop Name Effect", effectOffsetX: "Offset X", effectOffsetY: "Offset Y", effectBlur: "Blur", effectColor: "Color",
                orderFormatLabel: "Order Number Format", useLogoLabel: "Use Logo", uploadLogoLabel: "Upload Logo (PNG)",
                backgroundSettingsTitle: "Background Settings", uploadBgLabel: "Upload Background Image", bgOpacityLabel: "Opacity (Faint-Clear)", bgBlurLabel: "Blur (Less-More)",
                removeBgBtn: "Remove Background", previewBgBtn: "Preview", themeColorLabel: "Theme Color", saveSettingsBtn: "Save Settings",
                copyrightTextLabel: "Copyright Text",
                copyrightOpacityLabel: "Opacity",

                changePinTitle: "Change PIN", newPinLabel: "New PIN", saveNewPinBtn: "Save New PIN",
                manageCategoriesTitle: "Manage Categories", categoryNameLabel: "Category Name", categoryIconLabel: "Category Icon (PNG)", minOrderLabel: "Minimum Order Quantity",
                setPriceLabel: "Set Prices", setPerPiecePriceBtn: "Set Per-Piece Price", saveCategoryBtn: "Add/Save Category", categoryListTitle: "Category List",
                tableHeaderIcon: "Icon", tableHeaderName: "Name", tableHeaderMinOrder: "Min. Qty", tableHeaderPrice: "Price",
                manageProductsTitle: "Manage Products", productNameLabel: "Product Name", levelLabel: "Level", stockQuantityLabel: "Stock Quantity", categoryLabel: "Category",
                productIconLabel: "Product Icon (PNG)", productAvailableLabel: "This product is available", saveProductBtn: "Save Product", cancelEditBtn: "Cancel Edit",
                tableHeaderStock: "Stock", tableHeaderStatus: "Status", statusAvailable: "Available", statusUnavailable: "Unavailable",
                selectDateLabel: "Select Date:", resetDataBtn: "Reset Data", activeOrdersTitle: "Active Orders", cancelledOrdersTitle: "Cancelled Orders",
                tableHeaderOrderNo: "Order No.", tableHeaderDateTime: "Date/Time", tableHeaderTotal: "Total", viewDetailsBtn: "Details", cancelOrderBtn: "Cancel",
                dashboardTitle: "Dashboard", monthlyProfitTitle: "This Month's Profit", dailyOrdersTitle: "Today's Orders", monthlyOrdersTitle: "This Month's Orders", yearlySalesTitle: "This Year's Sales",
                lowStockTitle: "Low Stock Items (Top 10)", lowStockThresholdLabel: "Alert when stock is less than:", lowStockInfo: "Please restock items with a blinking light.",
                noLowStockItems: "No items are low on stock", categorySalesTitle: "Sales by Category", topSellingTitle: "Top 5 Selling Items",
                periodDay: "Today", periodMonth: "This Month", periodYear: "This Year", trafficStatsTitle: "Traffic Statistics", productStatsTitle: "Product Statistics (by quantity)",
                manageAccountTitle: "Manage Accounts", subAdminLimitInfo: "Sub-admin limit is 20 users.", usernameLabel: "Username", addUserBtn: "Add User", subAdminListTitle: "Sub-Admin List",
                orderSummaryTitle: "Order Summary", copyOrderPrompt: "Please copy the text below to send to the shop.", copyOrderBtn: "Copy Order", copySuccessMessage: "Order copied successfully",
                yourOrderListTitle: "Your Order List", confirmPinTitle: "Confirm PIN", enterPinPrompt: "Enter PIN to confirm",
                confirmResetTitle: "Confirm Data Reset", selectResetPeriodPrompt: "Please select the period for data reset.", periodWeek: "This Week", periodAll: "All Data",
                setPerPiecePriceTitle: "Set Per-Piece Price", setPerPiecePriceInfo: "Set the price for every 10 pieces.", savePriceBtn: "Save Prices",
                reorderMenuTitle: "Reorder Menu", reorderMenuInfo: "Drag and drop to reorder the menu.", saveOrderBtn: "Save Order",
                setPermissionsTitle: "Set Permissions", savePermissionsBtn: "Save Permissions",
                loadingBackgroundTitle: "Loading Background", uploadLoadingBgLabel: "Upload Loading Background",
            }
        };

        const MENU_NAMES = {
            'admin': 'menuAdmin',
            'stock': 'menuStock',
            'order-number': 'menuOrderNumber',
            'dashboard': 'menuDashboard',
            'manage-account': 'menuManageAccount'
        };
        
        const SUB_MENUS = {
            'admin': { 
                'shop-info': 'shopInfoTitle', 
                'system-fonts': 'systemFontsTitle',
                'background': 'backgroundSettingsTitle', 
                'loading-bg': 'loadingBackgroundTitle', 
                'pin': 'changePinTitle' 
            },
            'stock': { 'categories': 'manageCategoriesTitle', 'products': 'manageProductsTitle' },
            'order-number': { 'active-orders': 'activeOrdersTitle', 'cancelled-orders': 'cancelledOrdersTitle' }
        };

        const generateId = () => Date.now() + Math.floor(Math.random() * 1000);

        const saveState = async () => {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData),
                });
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                console.log('Data saved successfully!');
            } catch (error) {
                console.error('Failed to save state:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง');
            }
        };

        const loadState = async () => {
            try {
                const response = await fetch(API_ENDPOINT);
                if (response.status === 404) {
                    console.log('No data found, initializing with default data.');
                    await saveState(); 
                    return;
                }
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const serverData = await response.json();
                const defaultAppData = {
                    cart: {},
                    shopSettings: {
                        shopName: "WARISHAYDAY", slogan: "ร้านค้าไอเท็ม Hay Day", managerName: "", shareholderName: "", themeColor: "#28a745", fontFamily: "'Kanit', sans-serif",
                        globalFontFamily: "'Kanit', sans-serif", logo: null, useLogo: false, darkMode: false,
                        orderNumberFormat: 'format1', orderNumberCounters: { format1: 1, format2: 1, format3: 1 },
                        shopNameEffect: { enabled: false, offsetX: 2, offsetY: 2, blur: 4, color: '#000000' },
                        backgroundImage: null, backgroundOpacity: 1, backgroundBlur: 0, 
                        loadingBackgroundImage: null, loadingBackgroundOpacity: 0.7,
                        language: 'th', lowStockThreshold: 50,
                        copyrightText: "Copyright © 2025 Warishayday", copyrightOpacity: 1,
                    },
                    analytics: { dailyTraffic: Array(7).fill(0), hourlyTraffic: Array(24).fill(0), productSales: {}, orders: [], totalSales: 0, monthlyProfit: 0 },
                    subAdmins: [],
                    menuOrder: ['admin', 'stock', 'order-number', 'dashboard', 'manage-account'],
                    categories: [], products: [],
                };
                appData = { ...defaultAppData, ...serverData };
                appData.shopSettings = {...defaultAppData.shopSettings, ...appData.shopSettings};
                appData.analytics.orders = appData.analytics.orders || [];
                appData.analytics.orders.forEach(o => { if(!o.status) o.status = 'active'; });
                appData.categories.forEach(cat => { if (cat.minOrderQuantity === undefined) cat.minOrderQuantity = 30; });
                appData.products.forEach(prod => {
                    if (prod.isAvailable === undefined) prod.isAvailable = true;
                    if (prod.stock === undefined) prod.stock = -1;
                });
                const validMenus = new Set(defaultAppData.menuOrder);
                appData.menuOrder = (appData.menuOrder || defaultAppData.menuOrder).filter(item => validMenus.has(item));
                appData.subAdmins.forEach(sa => {
                    if (!sa.permissions) {
                        sa.permissions = {};
                        appData.menuOrder.forEach(key => sa.permissions[key] = true);
                    } else {
                        Object.keys(sa.permissions).forEach(key => { if (!validMenus.has(key)) delete sa.permissions[key]; });
                    }
                });
            } catch (error) {
                console.error('Failed to load state:', error);
                alert('ไม่สามารถโหลดข้อมูลร้านค้าได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองรีเฟรชหน้าเว็บ');
            }
        };

        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const views = {
            customer: document.getElementById('customer-view'),
            adminLogin: document.getElementById('admin-login-view'),
            adminPanel: document.getElementById('admin-panel-view'),
        };
        const shopNameDisplay = document.getElementById('shop-name-display');
        const shopLogoDisplay = document.getElementById('shop-logo-display');
        const headerTitleContainer = document.getElementById('header-title-container');
        const sloganElement = document.getElementById('slogan');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const productTableBody = document.getElementById('product-table-body');
        const currentCategoryName = document.getElementById('current-category-name');
        const orderValidationMsg = document.getElementById('order-validation-message');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const viewOrderBtn = document.getElementById('view-order-btn');
        const orderModal = document.getElementById('order-modal');
        const cartModal = document.getElementById('cart-modal');
        const orderDetails = document.getElementById('order-details');
        const cartDetails = document.getElementById('cart-details');
        const searchBox = document.getElementById('search-box');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const adminGearIcon = document.getElementById('admin-gear-icon');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const langToggleBtn = document.getElementById('lang-toggle-btn');
        const adminMenuContainer = document.querySelector('.admin-menu');
        const copyrightFooter = document.getElementById('copyright-footer');
        
        let activeAdminMenu = 'admin';
        let activeAdminSubMenus = { admin: 'shop-info', stock: 'categories', 'order-number': 'active-orders' };
        let activeCategoryId = null;
        let adminActiveCategoryId = null;
        let editingProductId = null;
        let editingCategoryId = null;
        let editingSubAdminId = null;
        let catIconFile = null;
        let prodIconFile = null;
        let logoFile = null;
        let bgFile = null;
        let loadingBgFile = null;
        let isAdminLoggedIn = false;
        let loggedInUser = null; 
        
        let dailyTrafficChart, productSalesChart, categorySalesChart;
        const datePicker = document.getElementById('date-picker');
        let orderDatePicker, fp;
        let selectedDate = new Date().toISOString().slice(0, 10);

        const setLanguage = (lang) => {
            appData.shopSettings.language = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = translations[lang][key];
                if (translation) {
                    if (el.placeholder !== undefined) el.placeholder = translation;
                    else el.textContent = translation;
                }
            });
            langToggleBtn.textContent = '🌎';
        };

        langToggleBtn.addEventListener('click', async () => {
            const newLang = appData.shopSettings.language === 'th' ? 'en' : 'th';
            setLanguage(newLang);
            await saveState();
        });

        const applyBackground = () => {
            const bgOverlay = document.getElementById('background-overlay');
            if (appData.shopSettings.backgroundImage) {
                bgOverlay.style.backgroundImage = `url(${appData.shopSettings.backgroundImage})`;
                bgOverlay.style.opacity = appData.shopSettings.backgroundOpacity;
                bgOverlay.style.filter = `blur(${appData.shopSettings.backgroundBlur}px)`;
            } else {
                bgOverlay.style.backgroundImage = 'none';
                bgOverlay.style.opacity = 1;
                bgOverlay.style.filter = 'none';
            }
        };

        const applyLoadingBackground = () => {
            const loaderBg = document.getElementById('loader-background');
            const loaderOverlay = document.getElementById('loader-overlay');
            if (appData.shopSettings.loadingBackgroundImage) {
                loaderBg.style.backgroundImage = `url(${appData.shopSettings.loadingBackgroundImage})`;
                loaderOverlay.style.backgroundColor = `rgba(0, 0, 0, ${appData.shopSettings.loadingBackgroundOpacity})`;
            } else {
                loaderBg.style.backgroundImage = 'none';
                loaderOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            }
        };

        const applyTheme = () => {
            document.documentElement.style.setProperty('--primary-color', appData.shopSettings.themeColor);
            document.documentElement.style.setProperty('--global-font', appData.shopSettings.globalFontFamily);
            shopNameDisplay.style.fontFamily = appData.shopSettings.fontFamily;
            shopNameDisplay.textContent = appData.shopSettings.shopName;
            sloganElement.textContent = appData.shopSettings.slogan;
            const effect = appData.shopSettings.shopNameEffect;
            shopNameDisplay.style.textShadow = effect.enabled ? `${effect.offsetX}px ${effect.offsetY}px ${effect.blur}px ${effect.color}` : '1px 1px 2px rgba(0,0,0,0.1)';
            
            if (appData.shopSettings.useLogo && appData.shopSettings.logo) {
                shopLogoDisplay.src = appData.shopSettings.logo;
                shopLogoDisplay.style.display = 'block';
                shopNameDisplay.style.display = 'none';
                headerTitleContainer.style.flexDirection = 'row';
                sloganElement.style.marginTop = '0';
            } else {
                shopLogoDisplay.style.display = 'none';
                shopNameDisplay.style.display = 'block';
                headerTitleContainer.style.flexDirection = 'column';
                sloganElement.style.marginTop = '-15px';
            }

            if (appData.shopSettings.darkMode) {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleBtn.textContent = '🌙';
            }

            copyrightFooter.textContent = appData.shopSettings.copyrightText;
            copyrightFooter.style.opacity = appData.shopSettings.copyrightOpacity;

            applyBackground();
            applyLoadingBackground();
            setLanguage(appData.shopSettings.language);
        };
        
        themeToggleBtn.addEventListener('click', async () => {
            appData.shopSettings.darkMode = !appData.shopSettings.darkMode;
            applyTheme();
            await saveState();
        });

        const renderCustomerView = () => {
            applyTheme();
            renderCategoryTabs();
            renderProducts();
            checkOrderValidation();
            adminGearIcon.style.display = isAdminLoggedIn ? 'none' : 'flex';
            backToAdminBtn.style.display = isAdminLoggedIn ? 'flex' : 'none';
            themeToggleBtn.style.display = 'flex';
            langToggleBtn.style.display = 'flex';
        };

        const renderCategoryTabs = () => {
            categoryTabsContainer.innerHTML = '';
            appData.categories.forEach(cat => {
                const tab = document.createElement('div');
                tab.className = `tab ${cat.id === activeCategoryId ? 'active' : ''}`;
                tab.dataset.id = cat.id;
                tab.innerHTML = `${cat.icon ? `<img src="${cat.icon}" alt="${cat.name}">` : ''}<span>${cat.name}</span>`;
                tab.addEventListener('click', () => {
                    activeCategoryId = cat.id;
                    searchBox.value = '';
                    renderCustomerView();
                });
                categoryTabsContainer.appendChild(tab);
            });
        };

        const renderProducts = (searchTerm = '') => {
            productTableBody.innerHTML = '';
            let productsToDisplay = [];
            
            if (searchTerm) {
                productsToDisplay = appData.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                currentCategoryName.textContent = `ผลการค้นหาสำหรับ: "${searchTerm}"`;
            } else {
                const activeCategory = appData.categories.find(c => c.id === activeCategoryId);
                if (!activeCategory) {
                    productTableBody.innerHTML = '<tr><td colspan="4">กรุณาเลือกหมวดหมู่</td></tr>';
                    currentCategoryName.textContent = '';
                    return;
                }
                currentCategoryName.textContent = `${activeCategory.name}`;
                productsToDisplay = appData.products.filter(p => p.categoryId === activeCategoryId);
            }
            
            if (productsToDisplay.length === 0) {
                 productTableBody.innerHTML = '<tr><td colspan="4">ไม่พบสินค้าที่ตรงกับเงื่อนไข</td></tr>';
            } else {
                productsToDisplay.forEach(prod => {
                    const quantity = appData.cart[prod.id] || 0;
                    const isPhysicallyOutOfStock = prod.stock !== -1 && prod.stock <= 0;
                    const isUnavailableByAdmin = !prod.isAvailable;
                    const row = document.createElement('tr');
                    if (isUnavailableByAdmin || isPhysicallyOutOfStock) row.classList.add('product-unavailable');
                    let quantityAndManageCells = isUnavailableByAdmin ? `<td colspan="2" class="status-cell">สินค้าหมดชั่วคราว</td>` : `
                        <td><span class="quantity-display">${quantity}</span></td>
                        <td>
                            <div class="quantity-controls">
                                <button class="btn btn-primary btn-small" data-id="${prod.id}" data-op="10" ${isPhysicallyOutOfStock ? 'disabled' : ''}>+10</button>
                                <button class="btn btn-danger btn-small" data-id="${prod.id}" data-op="-10" ${isPhysicallyOutOfStock ? 'disabled' : ''}>-10</button>
                            </div>
                        </td>`;
                    row.innerHTML = `
                        <td>${prod.icon ? `<img src="${prod.icon}" alt="${prod.name}">` : ''}${prod.name}</td>
                        <td>${prod.level}</td>
                        ${quantityAndManageCells}`;
                    productTableBody.appendChild(row);
                });
            }
        };

        searchBox.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            renderProducts(searchTerm);
            if (searchTerm) categoryTabsContainer.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            else renderCategoryTabs();
        });

        const calculatePrice = (categoryId, quantity) => {
            const category = appData.categories.find(c => c.id === categoryId);
            if (!category) return { price: 0, type: 'ไม่มีราคา' };
            let totalPrice = 0, priceType = '';
            if (category.bulkPrices && category.bulkPrices.length > 0) {
                const sortedBulkPrices = category.bulkPrices.sort((a, b) => b.min - a.min);
                for (const range of sortedBulkPrices) {
                    if (quantity >= range.min && quantity <= range.max) {
                        return { price: range.price, type: `ราคาเหมา: ${range.min}-${range.max} ชิ้น` };
                    }
                }
            }
            if (category.perPiecePrices && category.perPiecePrices.length > 0) {
                const sortedPerPiecePrices = category.perPiecePrices.sort((a, b) => b.quantity - a.quantity);
                let remainingQuantity = quantity;
                for (const priceItem of sortedPerPiecePrices) {
                    if (remainingQuantity >= priceItem.quantity && priceItem.price > 0) {
                        const numBlocks = Math.floor(remainingQuantity / priceItem.quantity);
                        totalPrice += numBlocks * priceItem.price;
                        priceType += `${numBlocks} x ${priceItem.quantity} ชิ้น`;
                        remainingQuantity %= priceItem.quantity;
                        if (remainingQuantity > 0 && remainingQuantity < sortedPerPiecePrices[0].quantity) {
                             priceType += ` (เหลือ ${remainingQuantity} ชิ้น)`;
                             break;
                        } else if (remainingQuantity > 0) priceType += ' + ';
                    }
                }
                if (totalPrice > 0) return { price: totalPrice, type: priceType.replace(/\s\+\s$/, '') };
            }
            return { price: 0, type: 'ไม่ได้ตั้งราคา' };
        };

        const checkOrderValidation = () => {
            let minOrderMessages = [], totalOrderPrice = 0;
            const itemsByCategory = {};
            for (const productId in appData.cart) {
                const quantity = appData.cart[productId];
                if (quantity > 0) {
                    const product = appData.products.find(p => p.id == productId);
                    if (product) {
                        if (!itemsByCategory[product.categoryId]) itemsByCategory[product.categoryId] = { total: 0, items: [] };
                        itemsByCategory[product.categoryId].total += quantity;
                    }
                }
            }
            for (const categoryId in itemsByCategory) {
                const total = itemsByCategory[categoryId].total;
                const category = appData.categories.find(c => c.id == categoryId);
                if (!category) continue;
                if (total > 0 && total < category.minOrderQuantity) {
                    minOrderMessages.push(`<div class="validation-link" data-cat-id="${categoryId}">➡️ หมวด "${category.name}" ขั้นต่ำ ${category.minOrderQuantity} ชิ้น (ขาด ${category.minOrderQuantity - total} ชิ้น)</div>`);
                }
                const priceResult = calculatePrice(parseInt(categoryId), total);
                totalOrderPrice += priceResult.price;
            }
            if (minOrderMessages.length > 0) {
                orderValidationMsg.innerHTML = minOrderMessages.join('');
                confirmOrderBtn.disabled = true;
                viewOrderBtn.disabled = true;
            } else {
                if (totalOrderPrice > 0) {
                    orderValidationMsg.innerHTML = `<span style="color: var(--text-color); font-weight: bold;">${translations[appData.shopSettings.language].totalAmount}: ${totalOrderPrice} บาท</span>`;
                    confirmOrderBtn.disabled = false;
                    viewOrderBtn.disabled = false;
                } else {
                    orderValidationMsg.textContent = '';
                    confirmOrderBtn.disabled = true;
                    viewOrderBtn.disabled = false;
                }
            }
        };

        orderValidationMsg.addEventListener('click', (e) => {
            const link = e.target.closest('.validation-link');
            if (link) {
                activeCategoryId = parseInt(link.dataset.catId);
                renderCustomerView();
                const tab = document.querySelector(`.tab[data-id="${activeCategoryId}"]`);
                if (tab) tab.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        productTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-op]');
            if (button) {
                const productId = button.dataset.id;
                const operation = parseInt(button.dataset.op);
                let currentQuantity = appData.cart[productId] || 0;
                currentQuantity = Math.max(0, currentQuantity + operation);
                appData.cart[productId] = currentQuantity;
                const quantityDisplay = button.closest('tr').querySelector('.quantity-display');
                if (quantityDisplay) quantityDisplay.textContent = currentQuantity;
                checkOrderValidation();
            }
        });

        const createOrderSummaryText = (orderNumber = null) => {
            let summaryText = `${appData.shopSettings.shopName}\n`;
            if (orderNumber) summaryText += `เลขที่ออเดอร์: ${orderNumber}\n\n`;
            const itemsByCategory = {};
            let totalOrderPrice = 0;
            appData.categories.forEach(cat => { itemsByCategory[cat.id] = { name: cat.name, items: [], totalQuantity: 0 }; });
            for (const productId in appData.cart) {
                const quantity = appData.cart[productId];
                if (quantity > 0) {
                    const product = appData.products.find(p => p.id == productId);
                    if (product && itemsByCategory[product.categoryId]) {
                        itemsByCategory[product.categoryId].items.push(`LV${product.level} ${product.name} x ${quantity}`);
                        itemsByCategory[product.categoryId].totalQuantity += quantity;
                    }
                }
            }
            for (const categoryId in itemsByCategory) {
                const categoryData = itemsByCategory[categoryId];
                if (categoryData.items.length > 0) {
                    summaryText += `--- หมวดหมู่: ${categoryData.name} ---\n${categoryData.items.join('\n')}\n`;
                    const priceResult = calculatePrice(parseInt(categoryId), categoryData.totalQuantity);
                    if (priceResult.price > 0) {
                        summaryText += `ราคาหมวดหมู่: ${priceResult.price} บาท\n`;
                        totalOrderPrice += priceResult.price;
                    }
                    summaryText += '\n';
                }
            }
            summaryText += `ยอดรวมทั้งหมด: ${totalOrderPrice} บาท`;
            return (totalOrderPrice === 0 && Object.values(appData.cart).every(q => q === 0)) ? 'ไม่มีสินค้าในรายการสั่งซื้อ' : summaryText;
        };
        
        const handleOrderAction = (isConfirm) => {
            if (isConfirm) {
                checkOrderValidation(); 
                if (orderValidationMsg.innerHTML.includes('ต้องสั่งขั้นต่ำ') || confirmOrderBtn.disabled) return;
            }
            if (isConfirm) {
                document.getElementById('order-modal-title').textContent = 'สรุปออเดอร์';
                document.getElementById('order-modal-prompt').style.display = 'block';
                document.getElementById('copy-order-btn').style.display = 'inline-block';
                const orderNumber = generateOrderNumber();
                orderDetails.textContent = createOrderSummaryText(orderNumber);
                orderDetails.dataset.orderNumber = orderNumber;
                orderModal.style.display = 'flex';
            } else {
                cartDetails.textContent = createOrderSummaryText();
                cartModal.style.display = 'flex';
            }
        };

        confirmOrderBtn.addEventListener('click', () => handleOrderAction(true));
        viewOrderBtn.addEventListener('click', () => handleOrderAction(false));

        document.getElementById('copy-order-btn').addEventListener('click', async () => {
            orderModal.style.display = 'none';
            const orderText = orderDetails.textContent;
            try {
                await navigator.clipboard.writeText(orderText);
                const totalOrderPriceText = orderText.match(/ยอดรวมทั้งหมด: ([\d,]+) บาท/);
                const totalOrderPrice = totalOrderPriceText ? parseFloat(totalOrderPriceText[1].replace(/,/g, '')) : 0;
                if (!isNaN(totalOrderPrice) && totalOrderPrice > 0) {
                    const newOrder = { id: orderDetails.dataset.orderNumber, timestamp: new Date().toISOString(), total: totalOrderPrice, items: { ...appData.cart }, status: 'active' };
                    appData.analytics.orders.push(newOrder);
                    for (const prodId in appData.cart) {
                        if (appData.cart[prodId] > 0) {
                            const product = appData.products.find(p => p.id == prodId);
                            if (product) {
                                if (!appData.analytics.productSales[product.name]) appData.analytics.productSales[product.name] = 0;
                                appData.analytics.productSales[product.name] += appData.cart[prodId];
                                if (product.stock !== -1) product.stock = Math.max(0, product.stock - appData.cart[prodId]);
                            }
                        }
                    }
                }
                appData.cart = {};
                await saveState();
                const successModal = document.getElementById('copy-success-modal');
                successModal.style.display = 'flex';
                setTimeout(() => {
                    successModal.style.display = 'none';
                    renderCustomerView();
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('ไม่สามารถคัดลอกได้ กรุณาลองใหม่');
            }
        });
        
        document.getElementById('close-order-modal-btn').addEventListener('click', () => orderModal.style.display = 'none');
        document.getElementById('close-cart-modal-btn').addEventListener('click', () => cartModal.style.display = 'none');
        document.getElementById('reset-cart-btn').addEventListener('click', () => {
             if (confirm('คุณต้องการรีเซ็ทรายการสั่งซื้อทั้งหมดหรือไม่?')) {
                appData.cart = {};
                renderCustomerView();
                alert('รีเซ็ทรายการสั่งซื้อเรียบร้อยแล้ว!');
            }
        });

        const switchView = (viewName) => {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[viewName].classList.add('active');
        };

        adminGearIcon.addEventListener('click', () => {
            if (!isAdminLoggedIn) {
                switchView('adminLogin');
                themeToggleBtn.style.display = 'none';
                langToggleBtn.style.display = 'none';
            }
        });

        document.getElementById('back-to-customer-view-btn').addEventListener('click', () => {
            switchView('customer');
            renderCustomerView();
        });
        
        document.getElementById('login-btn').addEventListener('click', async () => {
            const pinInput = document.getElementById('pin-input');
            const loginError = document.getElementById('login-error');
            const pin = pinInput.value;
            let loggedIn = false;
            if (pin === appData.adminPin) {
                isAdminLoggedIn = true;
                loggedInUser = { name: 'Super Admin', isSuper: true };
                loggedIn = true;
            } else {
                const subAdmin = appData.subAdmins.find(sa => sa.pin === pin);
                if (subAdmin) {
                    isAdminLoggedIn = true;
                    loggedInUser = subAdmin;
                    loggedIn = true;
                }
            }
            if (loggedIn) {
                switchView('adminPanel');
                renderAdminPanel();
                pinInput.value = '';
                loginError.textContent = '';
                adminGearIcon.style.display = 'none';
                backToAdminBtn.style.display = 'flex';
                themeToggleBtn.style.display = 'none';
                langToggleBtn.style.display = 'none';
                const today = new Date().getDay();
                appData.analytics.dailyTraffic[today] = (appData.analytics.dailyTraffic[today] || 0) + 1;
                await saveState();
            } else {
                loginError.textContent = translations[appData.shopSettings.language].invalidPinError;
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            isAdminLoggedIn = false;
            loggedInUser = null;
            switchView('customer');
            renderCustomerView();
        });
        
        document.getElementById('view-shop-btn').addEventListener('click', () => {
            switchView('customer');
            renderCustomerView();
        });

        backToAdminBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) {
                switchView('adminPanel');
                renderAdminPanel();
            }
        });

        const renderAdminMenu = () => {
            adminMenuContainer.innerHTML = '';
            const isSuperAdmin = loggedInUser && loggedInUser.isSuper;
            const lang = appData.shopSettings.language;
            appData.menuOrder.forEach(menuKey => {
                let showMenuItem = isSuperAdmin || (loggedInUser && loggedInUser.permissions && loggedInUser.permissions[menuKey]);
                if (showMenuItem && MENU_NAMES[menuKey]) {
                    const translationKey = MENU_NAMES[menuKey];
                    const btn = document.createElement('button');
                    btn.className = `btn menu-btn ${menuKey === activeAdminMenu ? 'active' : ''}`;
                    btn.dataset.menu = menuKey;
                    btn.textContent = translations[lang][translationKey];
                    adminMenuContainer.appendChild(btn);
                }
            });
            if (isSuperAdmin) {
                const reorderBtn = document.createElement('button');
                reorderBtn.className = 'btn btn-small';
                reorderBtn.id = 'reorder-menu-btn';
                reorderBtn.textContent = translations[lang].editMenuOrderBtn;
                adminMenuContainer.appendChild(reorderBtn);
                reorderBtn.addEventListener('click', renderReorderMenuModal);
            }
            document.querySelectorAll('.admin-menu .menu-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    activeAdminMenu = e.currentTarget.dataset.menu;
                    renderAdminPanel();
                });
            });
        };
        
        const renderSubMenu = (menuKey, containerId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const subMenuConfig = SUB_MENUS[menuKey];
            if (!subMenuConfig) return;

            const lang = appData.shopSettings.language;
            for (const subKey in subMenuConfig) {
                const tab = document.createElement('div');
                tab.className = `tab ${subKey === activeAdminSubMenus[menuKey] ? 'active' : ''}`;
                tab.dataset.sub = subKey;
                tab.textContent = translations[lang][subMenuConfig[subKey]];
                tab.addEventListener('click', () => {
                    activeAdminSubMenus[menuKey] = subKey;
                    renderAdminPanel();
                });
                container.appendChild(tab);
            }
        };

        const renderAdminPanel = () => {
            document.querySelectorAll('.admin-menu-content').forEach(el => el.style.display = 'none');
            const isSuperAdmin = loggedInUser && loggedInUser.isSuper;
            renderAdminMenu();
            document.querySelectorAll('.admin-menu .menu-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.admin-menu .menu-btn[data-menu="${activeAdminMenu}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            const permissions = (loggedInUser && loggedInUser.permissions) || {};
            const canAccess = (menu) => isSuperAdmin || permissions[menu];

            if (activeAdminMenu === 'admin' && canAccess('admin')) {
                const container = document.getElementById('admin-menu-admin');
                container.style.display = 'block';
                renderSubMenu('admin', 'admin-settings-tabs');
                container.querySelectorAll('.admin-sub-content').forEach(el => el.classList.remove('active'));
                
                const activeSub = activeAdminSubMenus.admin;
                document.getElementById(`admin-sub-${activeSub}`).classList.add('active');
                
                if (activeSub === 'shop-info') {
                    document.getElementById('shop-name').value = appData.shopSettings.shopName;
                    document.getElementById('shop-slogan').value = appData.shopSettings.slogan;
                    document.getElementById('manager-name').value = appData.shopSettings.managerName;
                    document.getElementById('shareholder-name').value = appData.shopSettings.shareholderName;
                    document.getElementById('order-format-select').value = appData.shopSettings.orderNumberFormat;
                } else if (activeSub === 'system-fonts') {
                    document.getElementById('shop-global-font').value = appData.shopSettings.globalFontFamily;
                    document.getElementById('shop-font').value = appData.shopSettings.fontFamily;
                    document.getElementById('font-preview').style.fontFamily = appData.shopSettings.fontFamily;
                    document.getElementById('global-font-preview').style.fontFamily = appData.shopSettings.globalFontFamily;
                    document.getElementById('logo-toggle').checked = appData.shopSettings.useLogo;
                    document.getElementById('logo-preview').style.display = appData.shopSettings.logo ? 'block' : 'none';
                    if(appData.shopSettings.logo) document.getElementById('logo-preview').src = appData.shopSettings.logo;
                    const effect = appData.shopSettings.shopNameEffect;
                    document.getElementById('effect-toggle').checked = effect.enabled;
                    document.getElementById('effect-offset-x').value = effect.offsetX;
                    document.getElementById('effect-offset-y').value = effect.offsetY;
                    document.getElementById('effect-blur').value = effect.blur;
                    document.getElementById('effect-color').value = effect.color;
                    document.getElementById('effect-controls-container').style.display = effect.enabled ? 'grid' : 'none';
                    document.getElementById('copyright-text').value = appData.shopSettings.copyrightText;
                    document.getElementById('copyright-opacity').value = appData.shopSettings.copyrightOpacity;
                    updateFontPreviewEffect();
                } else if (activeSub === 'background') {
                    document.getElementById('bg-opacity').value = appData.shopSettings.backgroundOpacity;
                    document.getElementById('bg-blur').value = appData.shopSettings.backgroundBlur;
                    const bgPreview = document.getElementById('bg-preview');
                    bgPreview.style.display = appData.shopSettings.backgroundImage ? 'block' : 'none';
                    if(appData.shopSettings.backgroundImage) bgPreview.style.backgroundImage = `url(${appData.shopSettings.backgroundImage})`;
                } else if (activeSub === 'loading-bg') {
                    document.getElementById('loading-bg-opacity').value = appData.shopSettings.loadingBackgroundOpacity;
                    const loadingBgPreview = document.getElementById('loading-bg-preview');
                    loadingBgPreview.style.display = appData.shopSettings.loadingBackgroundImage ? 'block' : 'none';
                    if(appData.shopSettings.loadingBackgroundImage) loadingBgPreview.style.backgroundImage = `url(${appData.shopSettings.loadingBackgroundImage})`;
                }
            } else if (activeAdminMenu === 'stock' && canAccess('stock')) {
                const container = document.getElementById('admin-menu-stock');
                container.style.display = 'block';
                renderSubMenu('stock', 'admin-stock-tabs');
                container.querySelectorAll('.admin-sub-content').forEach(el => el.classList.remove('active'));
                const activeSub = activeAdminSubMenus.stock;
                document.getElementById(`admin-sub-${activeSub}`).classList.add('active');
                if (activeSub === 'categories') {
                    renderAdminCategories();
                } else if (activeSub === 'products') {
                    renderAdminProductTabs();
                    renderAdminProducts();
                    populateCategoryDropdown();
                }
            } else if (activeAdminMenu === 'order-number' && canAccess('order-number')) {
                const container = document.getElementById('admin-menu-order-number');
                container.style.display = 'block';
                renderSubMenu('order-number', 'admin-order-tabs');
                container.querySelectorAll('.admin-sub-content').forEach(el => el.classList.remove('active'));
                document.getElementById(`admin-sub-${activeAdminSubMenus['order-number']}`).classList.add('active');
                if (!orderDatePicker) {
                    orderDatePicker = flatpickr("#order-date-picker", { mode: "range", dateFormat: "Y-m-d", onClose: (selectedDates) => renderOrderNumberView(selectedDates) });
                }
                renderOrderNumberView(orderDatePicker.selectedDates);
            } else if (activeAdminMenu === 'dashboard' && canAccess('dashboard')) {
                document.getElementById('admin-menu-dashboard').style.display = 'block';
                document.getElementById('low-stock-threshold').value = appData.shopSettings.lowStockThreshold;
                if (!fp) fp = flatpickr(datePicker, { defaultDate: selectedDate, dateFormat: "Y-m-d", onChange: (selectedDates, dateStr) => { selectedDate = dateStr; renderDashboard(); } });
                renderDashboard();
            } else if (activeAdminMenu === 'manage-account' && canAccess('manage-account')) {
                document.getElementById('admin-menu-manage-account').style.display = 'block';
                renderSubAdmins();
            } else {
                if (!isSuperAdmin) {
                    const firstPermittedMenu = appData.menuOrder.find(key => permissions[key]);
                    if (firstPermittedMenu) {
                        activeAdminMenu = firstPermittedMenu;
                        renderAdminPanel();
                    }
                }
            }
        };

        const renderDashboard = () => {
            const today = new Date(), currentMonth = today.getMonth(), currentYear = today.getFullYear();
            const ordersToday = appData.analytics.orders.filter(o => o.timestamp.startsWith(selectedDate));
            const ordersInMonth = appData.analytics.orders.filter(o => new Date(o.timestamp).getFullYear() === currentYear && new Date(o.timestamp).getMonth() === currentMonth);
            const ordersInYear = appData.analytics.orders.filter(o => new Date(o.timestamp).getFullYear() === currentYear);
            const monthlyProfit = ordersInMonth.reduce((sum, order) => sum + order.total, 0);
            const yearlySales = ordersInYear.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('monthly-profit').textContent = `${monthlyProfit.toLocaleString()} บาท`;
            document.getElementById('daily-orders').textContent = ordersToday.length;
            document.getElementById('monthly-orders').textContent = ordersInMonth.length;
            document.getElementById('yearly-sales').textContent = `${yearlySales.toLocaleString()} บาท`;
            const days = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัส', 'ศุกร์', 'เสาร์'];
            const maxTraffic = Math.max(...appData.analytics.dailyTraffic);
            document.getElementById('most-active-day').textContent = `วันที่มีคนเข้าชมมากที่สุด: ${days[appData.analytics.dailyTraffic.indexOf(maxTraffic)]} (${maxTraffic} ครั้ง)`;
            const maxHourTraffic = Math.max(...appData.analytics.hourlyTraffic);
            const mostActiveHourIndex = appData.analytics.hourlyTraffic.indexOf(maxHourTraffic);
            document.getElementById('most-active-time').textContent = `ช่วงเวลาที่มีคนเข้าชมมากที่สุด: ${mostActiveHourIndex}:00 - ${mostActiveHourIndex + 1}:00 น. (${maxHourTraffic} ครั้ง)`;
            renderTrafficChart(days);
            renderProductSalesChart();
            renderCategorySalesChart(ordersInYear);
            renderLowStockList();
            renderTopItems('month');
            document.querySelectorAll('#top-items-controls .btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#top-items-controls .btn[data-period="month"]').classList.add('active');
        };

        const renderTrafficChart = (days) => {
            if (dailyTrafficChart) dailyTrafficChart.destroy();
            dailyTrafficChart = new Chart(document.getElementById('dailyTrafficChart'), { type: 'bar', data: { labels: days, datasets: [{ label: 'จำนวนผู้เข้าชม', data: appData.analytics.dailyTraffic, backgroundColor: 'rgba(40, 167, 69, 0.5)', borderColor: 'rgba(40, 167, 69, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        };
        const renderProductSalesChart = () => {
            const productNames = Object.keys(appData.analytics.productSales);
            const productQuantities = Object.values(appData.analytics.productSales);
            document.getElementById('best-selling-product').textContent = `สินค้าที่สั่งเยอะสุด (ทั้งหมด): ${productNames.length > 0 ? productNames[productQuantities.indexOf(Math.max(...productQuantities))] : 'ไม่มีข้อมูล'}`;
            document.getElementById('least-selling-product').textContent = `สินค้าที่สั่งน้อยสุด (ทั้งหมด): ${productNames.length > 0 ? productNames[productQuantities.indexOf(Math.min(...productQuantities))] : 'ไม่มีข้อมูล'}`;
            if (productSalesChart) productSalesChart.destroy();
            productSalesChart = new Chart(document.getElementById('productSalesChart'), { type: 'doughnut', data: { labels: productNames, datasets: [{ label: 'ยอดสั่งสินค้า', data: productQuantities, backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        };
        const renderCategorySalesChart = (orders) => {
            const salesByCategory = {};
            orders.forEach(order => {
                const itemsByCategoryInOrder = {};
                for (const prodId in order.items) {
                    const product = appData.products.find(p => p.id == prodId);
                    if (product && product.categoryId) {
                        if (!itemsByCategoryInOrder[product.categoryId]) itemsByCategoryInOrder[product.categoryId] = 0;
                        itemsByCategoryInOrder[product.categoryId] += order.items[prodId];
                    }
                }
                 for (const catId in itemsByCategoryInOrder) {
                    const cat = appData.categories.find(c => c.id == catId);
                    if (cat) {
                        const priceResult = calculatePrice(parseInt(catId), itemsByCategoryInOrder[catId]);
                        if (!salesByCategory[cat.name]) salesByCategory[cat.name] = 0;
                        salesByCategory[cat.name] += priceResult.price;
                    }
                }
            });
            if (categorySalesChart) categorySalesChart.destroy();
            categorySalesChart = new Chart(document.getElementById('categorySalesChart'), { type: 'pie', data: { labels: Object.keys(salesByCategory), datasets: [{ label: 'ยอดขาย', data: Object.values(salesByCategory), backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#dc3545', '#6610f2', '#fd7e14', '#e83e8c', '#6c757d'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        };

        const renderLowStockList = () => {
            const listEl = document.getElementById('low-stock-list');
            listEl.innerHTML = '';
            const threshold = appData.shopSettings.lowStockThreshold || 50;
            const lowStockItems = appData.products.filter(p => p.stock !== -1 && p.stock < threshold).sort((a, b) => a.stock - b.stock).slice(0, 10);
            if (lowStockItems.length === 0) {
                listEl.innerHTML = `<li>${translations[appData.shopSettings.language].noLowStockItems}</li>`;
                return;
            }
            lowStockItems.forEach((item) => {
                const li = document.createElement('li');
                if (item.stock < 20) li.className = 'blinking-warning';
                li.innerHTML = `<span>${item.name}</span><strong>${item.stock} ชิ้น</strong>`;
                listEl.appendChild(li);
            });
        };

        document.getElementById('low-stock-threshold').addEventListener('change', async (e) => {
            const newThreshold = parseInt(e.target.value);
            if (!isNaN(newThreshold) && newThreshold >= 0) {
                appData.shopSettings.lowStockThreshold = newThreshold;
                await saveState();
                renderLowStockList();
            }
        });

        const renderTopItems = (period) => {
            const listEl = document.getElementById('top-items-list');
            listEl.innerHTML = '';
            const today = new Date();
            let ordersToAnalyze = [];
            if(period === 'day') ordersToAnalyze = appData.analytics.orders.filter(o => o.timestamp.startsWith(today.toISOString().slice(0, 10)));
            else if (period === 'month') ordersToAnalyze = appData.analytics.orders.filter(o => new Date(o.timestamp).getMonth() === today.getMonth() && new Date(o.timestamp).getFullYear() === today.getFullYear());
            else ordersToAnalyze = appData.analytics.orders.filter(o => new Date(o.timestamp).getFullYear() === today.getFullYear());
            const itemCounts = {};
            ordersToAnalyze.forEach(order => {
                for(const prodId in order.items) {
                    const product = appData.products.find(p => p.id == prodId);
                    if(product){
                        if(!itemCounts[product.name]) itemCounts[product.name] = 0;
                        itemCounts[product.name] += order.items[prodId];
                    }
                }
            });
            const sortedItems = Object.entries(itemCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
            if (sortedItems.length === 0) {
                listEl.innerHTML = '<li>ยังไม่มีข้อมูลการขาย</li>';
                return;
            }
            sortedItems.forEach(([name, quantity]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${name}</span><strong>${quantity.toLocaleString()} ชิ้น</strong>`;
                listEl.appendChild(li);
            });
        };

        document.getElementById('top-items-controls').addEventListener('click', (e) => {
            if(e.target.matches('.btn')) {
                document.querySelectorAll('#top-items-controls .btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderTopItems(e.target.dataset.period);
            }
        });


        const renderAdminProductTabs = () => {
            const tabsContainer = document.getElementById('admin-product-tabs');
            tabsContainer.innerHTML = '';
            appData.categories.forEach(cat => {
                const tab = document.createElement('div');
                tab.className = `tab ${cat.id === adminActiveCategoryId ? 'active' : ''}`;
                tab.dataset.id = cat.id;
                tab.textContent = cat.name;
                tab.addEventListener('click', () => {
                    adminActiveCategoryId = cat.id;
                    renderAdminProducts();
                    renderAdminProductTabs();
                });
                tabsContainer.appendChild(tab);
            });
        };

        const renderAdminCategories = () => {
            const list = document.getElementById('admin-cat-list');
            list.innerHTML = '';
            appData.categories.forEach(cat => {
                const priceText = [];
                if (cat.perPiecePrices && cat.perPiecePrices.length > 0) priceText.push(`ราคาต่อชิ้น:`, ...cat.perPiecePrices.sort((a,b) => a.quantity - b.quantity).map(p => `- ${p.quantity} ชิ้น = ${p.price} บาท`));
                if (cat.bulkPrices && cat.bulkPrices.length > 0) priceText.push(`ราคาเหมา:`, ...cat.bulkPrices.sort((a,b) => a.min - b.min).map(p => `- ${p.min}-${p.max} ชิ้น = ${p.price} บาท`));
                const row = document.createElement('tr');
                row.innerHTML = `<td>${cat.icon ? `<img src="${cat.icon}" alt="icon" style="width:24px; height:24px;">` : 'ไม่มี'}</td><td>${cat.name}</td><td>${cat.minOrderQuantity}</td><td><ul class="price-list">${priceText.length > 0 ? `<li>${priceText.join('</li><li>')}</li>` : '<li>ไม่ได้ตั้งราคา</li>'}</ul></td><td><button class="btn btn-secondary btn-small btn-cat-edit" data-id="${cat.id}">แก้ไข</button><button class="btn btn-danger btn-small btn-cat-delete" data-id="${cat.id}">ลบ</button></td>`;
                list.appendChild(row);
            });
        };
        
        const renderAdminProducts = () => {
            const list = document.getElementById('admin-prod-list');
            list.innerHTML = '';
            const lang = appData.shopSettings.language;
            const productsInCategory = appData.products.filter(p => p.categoryId === adminActiveCategoryId);
            const activeCategory = appData.categories.find(c => c.id === adminActiveCategoryId);
            document.getElementById('admin-current-category-name').textContent = activeCategory ? `${activeCategory.name}` : 'กรุณาเลือกหมวดหมู่';
            if (productsInCategory.length === 0) list.innerHTML = '<tr><td colspan="6">ยังไม่มีสินค้าในหมวดนี้</td></tr>';
            else {
                productsInCategory.forEach(prod => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${prod.icon ? `<img src="${prod.icon}" alt="${prod.name}">` : 'ไม่มี'}</td><td>${prod.name}</td><td>${prod.level}</td><td>${prod.stock === -1 ? '∞' : prod.stock}</td><td>${prod.isAvailable ? translations[lang].statusAvailable : translations[lang].statusUnavailable}</td><td><button class="btn btn-secondary btn-small btn-edit" data-id="${prod.id}">แก้ไข</button><button class="btn btn-danger btn-small btn-delete" data-id="${prod.id}">ลบ</button></td>`;
                    list.appendChild(row);
                });
            }
        };
        
        const populateCategoryDropdown = () => {
            const select = document.getElementById('prod-category');
            select.innerHTML = '';
            appData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        };

        const fontSelect = document.getElementById('shop-font');
        const globalFontSelect = document.getElementById('shop-global-font');
        const fontPreview = document.getElementById('font-preview');
        const globalFontPreview = document.getElementById('global-font-preview');

        const populateFontSelectors = () => {
            FONT_OPTIONS.forEach(font => {
                const option = document.createElement('option');
                option.value = font.value;
                option.textContent = font.name;
                fontSelect.appendChild(option.cloneNode(true));
                globalFontSelect.appendChild(option.cloneNode(true));
            });
        };
        populateFontSelectors();

        fontSelect.addEventListener('change', (e) => fontPreview.style.fontFamily = e.target.value);
        globalFontSelect.addEventListener('change', (e) => globalFontPreview.style.fontFamily = e.target.value);

        document.querySelectorAll('.color-btn').forEach(btn => btn.addEventListener('click', (e) => {
            appData.shopSettings.themeColor = e.target.dataset.color;
            applyTheme();
        }));

        document.getElementById('logo-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                logoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('logo-preview').src = e.target.result;
                    document.getElementById('logo-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else logoFile = null;
        });

        document.getElementById('bg-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                bgFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('bg-preview').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('bg-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else bgFile = null;
        });
        
        document.getElementById('loading-bg-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadingBgFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('loading-bg-preview').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('loading-bg-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else loadingBgFile = null;
        });

        document.getElementById('remove-bg-btn').addEventListener('click', () => {
            bgFile = null;
            appData.shopSettings.backgroundImage = null;
            document.getElementById('bg-preview').style.display = 'none';
            document.getElementById('bg-upload').value = '';
            applyBackground();
        });
        
        document.getElementById('remove-loading-bg-btn').addEventListener('click', () => {
            loadingBgFile = null;
            appData.shopSettings.loadingBackgroundImage = null;
            document.getElementById('loading-bg-preview').style.display = 'none';
            document.getElementById('loading-bg-upload').value = '';
            applyLoadingBackground();
        });

        document.getElementById('preview-bg-btn').addEventListener('click', async () => {
            if (bgFile) appData.shopSettings.backgroundImage = await readFileAsBase64(bgFile);
            appData.shopSettings.backgroundOpacity = document.getElementById('bg-opacity').value;
            appData.shopSettings.backgroundBlur = document.getElementById('bg-blur').value;
            switchView('customer');
            renderCustomerView();
        });

        const updateFontPreviewEffect = () => {
            const effect = {
                enabled: document.getElementById('effect-toggle').checked,
                offsetX: document.getElementById('effect-offset-x').value,
                offsetY: document.getElementById('effect-offset-y').value,
                blur: document.getElementById('effect-blur').value,
                color: document.getElementById('effect-color').value
            };
            fontPreview.style.textShadow = effect.enabled ? `${effect.offsetX}px ${effect.offsetY}px ${effect.blur}px ${effect.color}` : 'none';
        };

        document.getElementById('effect-controls-container').addEventListener('input', updateFontPreviewEffect);
        document.getElementById('effect-toggle').addEventListener('change', (e) => {
            document.getElementById('effect-controls-container').style.display = e.target.checked ? 'grid' : 'none';
            updateFontPreviewEffect();
        });

        document.getElementById('save-shop-info-btn').addEventListener('click', async () => {
            appData.shopSettings.shopName = document.getElementById('shop-name').value;
            appData.shopSettings.slogan = document.getElementById('shop-slogan').value;
            appData.shopSettings.managerName = document.getElementById('manager-name').value;
            appData.shopSettings.shareholderName = document.getElementById('shareholder-name').value;
            appData.shopSettings.orderNumberFormat = document.getElementById('order-format-select').value;
            await saveState();
            applyTheme();
            alert('บันทึกข้อมูลร้านแล้ว!');
        });

        document.getElementById('save-system-fonts-btn').addEventListener('click', async () => {
            appData.shopSettings.fontFamily = document.getElementById('shop-font').value;
            appData.shopSettings.globalFontFamily = document.getElementById('shop-global-font').value;
            appData.shopSettings.useLogo = document.getElementById('logo-toggle').checked;
            appData.shopSettings.shopNameEffect = {
                enabled: document.getElementById('effect-toggle').checked,
                offsetX: document.getElementById('effect-offset-x').value,
                offsetY: document.getElementById('effect-offset-y').value,
                blur: document.getElementById('effect-blur').value,
                color: document.getElementById('effect-color').value
            };
            if (logoFile) appData.shopSettings.logo = await readFileAsBase64(logoFile);
            appData.shopSettings.copyrightText = document.getElementById('copyright-text').value;
            appData.shopSettings.copyrightOpacity = document.getElementById('copyright-opacity').value;

            await saveState();
            applyTheme();
            alert('บันทึกการตั้งค่าฟอนต์และโลโก้แล้ว!');
        });
        
        document.getElementById('save-background-settings-btn').addEventListener('click', async () => {
            appData.shopSettings.backgroundOpacity = document.getElementById('bg-opacity').value;
            appData.shopSettings.backgroundBlur = document.getElementById('bg-blur').value;
            if (bgFile) appData.shopSettings.backgroundImage = await readFileAsBase64(bgFile);
            await saveState();
            applyTheme();
            alert('บันทึกพื้นหลังแล้ว!');
        });
        
        document.getElementById('save-loading-bg-settings-btn').addEventListener('click', async () => {
            appData.shopSettings.loadingBackgroundOpacity = document.getElementById('loading-bg-opacity').value;
            if (loadingBgFile) appData.shopSettings.loadingBackgroundImage = await readFileAsBase64(loadingBgFile);
            await saveState();
            applyTheme();
            alert('บันทึกพื้นหลัง Loading แล้ว!');
        });

        document.getElementById('change-pin-btn').addEventListener('click', async () => {
            const newPin = document.getElementById('new-pin').value;
            if (newPin && newPin.length >= 4) {
                if (confirm(`คุณต้องการเปลี่ยน PIN เป็น "${newPin}" ใช่หรือไม่?`)) {
                    appData.adminPin = newPin;
                    await saveState();
                    alert('เปลี่ยน PIN สำเร็จ!');
                    document.getElementById('new-pin').value = '';
                }
            } else alert('PIN ต้องมีอย่างน้อย 4 ตัวอักษร');
        });
        
        document.getElementById('cat-icon-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                catIconFile = file;
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('cat-icon-preview').style.backgroundImage = `url(${e.target.result})`;
                reader.readAsDataURL(file);
            } else catIconFile = null;
        });

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('cat-name').value.trim();
            const minOrder = parseInt(document.getElementById('cat-min-order').value) || 0;
            if (!name) { alert('กรุณากรอกชื่อหมวดหมู่'); return; }
            let iconData = null;
            if (catIconFile) iconData = await readFileAsBase64(catIconFile);
            if (editingCategoryId) {
                const index = appData.categories.findIndex(c => c.id === editingCategoryId);
                if (index !== -1) {
                    appData.categories[index].name = name;
                    appData.categories[index].minOrderQuantity = minOrder;
                    if (iconData) appData.categories[index].icon = iconData;
                }
            } else appData.categories.push({ id: generateId(), name, icon: iconData, perPiecePrices: [], bulkPrices: [], minOrderQuantity: minOrder });
            await saveState();
            resetCategoryForm();
            renderAdminPanel();
        });
        
        const deleteCategory = async (id) => {
            if (confirm('การลบหมวดหมู่จะลบสินค้าทั้งหมดในหมวดหมู่นั้นด้วย ยืนยันหรือไม่?')) {
                appData.categories = appData.categories.filter(c => c.id !== id);
                appData.products = appData.products.filter(p => p.categoryId !== id);
                if (appData.categories.length > 0) {
                    if (!appData.categories.find(c => c.id === activeCategoryId)) activeCategoryId = appData.categories[0].id;
                    if (!appData.categories.find(c => c.id === adminActiveCategoryId)) adminActiveCategoryId = appData.categories[0].id;
                } else { activeCategoryId = null; adminActiveCategoryId = null; }
                await saveState();
                renderAdminPanel();
            }
        };

        const resetCategoryForm = () => {
            editingCategoryId = null;
            document.getElementById('category-form').reset();
            document.getElementById('cat-min-order').value = 30;
            document.getElementById('submit-cat-btn').textContent = translations[appData.shopSettings.language].saveCategoryBtn;
            document.getElementById('cancel-cat-edit-btn').style.display = 'none';
            document.getElementById('cat-icon-preview').style.backgroundImage = 'none';
            catIconFile = null;
        }

        document.getElementById('cancel-cat-edit-btn').addEventListener('click', resetCategoryForm);
        
        document.getElementById('admin-cat-list').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-cat-edit');
            const deleteBtn = e.target.closest('.btn-cat-delete');
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const category = appData.categories.find(c => c.id === id);
                if (category) {
                    editingCategoryId = id;
                    document.getElementById('cat-name').value = category.name;
                    document.getElementById('cat-min-order').value = category.minOrderQuantity;
                    document.getElementById('cat-icon-preview').style.backgroundImage = category.icon ? `url(${category.icon})` : 'none';
                    document.getElementById('submit-cat-btn').textContent = translations[appData.shopSettings.language].saveBtn;
                    document.getElementById('cancel-cat-edit-btn').style.display = 'inline-block';
                    document.getElementById('category-form').scrollIntoView();
                }
            }
            if (deleteBtn) deleteCategory(parseInt(deleteBtn.dataset.id));
        });
        
        document.getElementById('prod-icon-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                prodIconFile = file;
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('prod-icon-preview').style.backgroundImage = `url(${e.target.result})`;
                reader.readAsDataURL(file);
            } else prodIconFile = null;
        });

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const product = { id: editingProductId || generateId(), name: document.getElementById('prod-name').value, level: parseInt(document.getElementById('prod-level').value), categoryId: parseInt(document.getElementById('prod-category').value), stock: parseInt(document.getElementById('prod-stock').value), isAvailable: document.getElementById('prod-available').checked, icon: null };
            if (prodIconFile) product.icon = await readFileAsBase64(prodIconFile);
            if (editingProductId) {
                const index = appData.products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    const existingIcon = appData.products[index].icon;
                    appData.products[index] = { ...appData.products[index], ...product, icon: product.icon || existingIcon };
                }
            } else appData.products.push(product);
            await saveState();
            resetProductForm();
            renderAdminProducts();
        });
        
        document.getElementById('cancel-edit-btn').addEventListener('click', resetProductForm);

        document.getElementById('admin-prod-list').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.btn-edit');
            const deleteBtn = e.target.closest('.btn-delete');
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const product = appData.products.find(p => p.id === id);
                if (product) {
                    editingProductId = id;
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('prod-name').value = product.name;
                    document.getElementById('prod-level').value = product.level;
                    document.getElementById('prod-stock').value = product.stock;
                    document.getElementById('prod-available').checked = product.isAvailable;
                    document.getElementById('prod-category').value = product.categoryId;
                    document.getElementById('prod-icon-preview').style.backgroundImage = product.icon ? `url(${product.icon})` : 'none';
                    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
                    document.getElementById('product-form').scrollIntoView();
                }
            }
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                if (confirm('คุณต้องการลบสินค้านี้ใช่หรือไม่?')) {
                    appData.products = appData.products.filter(p => p.id !== id);
                    await saveState();
                    renderAdminProducts();
                }
            }
        });

        function resetProductForm() {
            editingProductId = null;
            document.getElementById('product-form').reset();
            document.getElementById('prod-stock').value = -1;
            document.getElementById('prod-available').checked = true;
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('prod-icon-preview').style.backgroundImage = 'none';
            prodIconFile = null;
        }

        const resetConfirmModal = document.getElementById('reset-confirm-modal');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        let currentResetContext = null;

        const openResetModal = (context) => {
            currentResetContext = context;
            resetConfirmModal.style.display = 'flex';
        };

        document.getElementById('reset-analytics-btn').addEventListener('click', () => openResetModal('analytics'));
        document.getElementById('reset-orders-btn').addEventListener('click', () => openResetModal('orders'));
        cancelResetBtn.addEventListener('click', () => resetConfirmModal.style.display = 'none');

        confirmResetBtn.addEventListener('click', async () => {
            const period = document.getElementById('reset-period-select').value;
            const now = new Date();
            const today = now.toISOString().slice(0, 10);
            const weekStart = new Date(now);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().slice(0, 10);
            const monthStartStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการรีเซ็ตข้อมูล (${period})? การกระทำนี้ไม่สามารถย้อนกลับได้`)) {
                if (currentResetContext === 'analytics') {
                    if (period === 'all') appData.analytics = { dailyTraffic: Array(7).fill(0), hourlyTraffic: Array(24).fill(0), productSales: {}, orders: [], totalSales: 0, monthlyProfit: 0 };
                    else {
                        alert('การรีเซ็ตสถิติตามช่วงเวลาจะรีเซ็ตเฉพาะกราฟและตัวเลขสรุป แต่ข้อมูลออเดอร์จะยังคงอยู่');
                        appData.analytics.dailyTraffic = Array(7).fill(0);
                        appData.analytics.hourlyTraffic = Array(24).fill(0);
                        appData.analytics.productSales = {};
                    }
                    renderDashboard();
                } else if (currentResetContext === 'orders') {
                    if (period === 'all') appData.analytics.orders = [];
                    else {
                        appData.analytics.orders = appData.analytics.orders.filter(order => {
                            const orderDate = order.timestamp.slice(0, 10);
                            if (period === 'day') return orderDate !== today;
                            if (period === 'week') return orderDate < weekStartStr;
                            if (period === 'month') return orderDate < monthStartStr;
                            return true;
                        });
                    }
                    renderOrderNumberView();
                }
                await saveState();
                alert('ข้อมูลถูกรีเซ็ตเรียบร้อยแล้ว');
            }
            resetConfirmModal.style.display = 'none';
        });

        const perPiecePriceModal = document.getElementById('per-piece-price-modal');
        const perPiecePriceForm = document.getElementById('per-piece-price-form');
        document.getElementById('set-per-piece-price-btn').addEventListener('click', () => {
            if (!editingCategoryId) { alert('กรุณาเลือกหมวดหมู่ที่ต้องการแก้ไขก่อน'); return; }
            perPiecePriceForm.innerHTML = '';
            const category = appData.categories.find(c => c.id === editingCategoryId);
            const prices = category.perPiecePrices || [];
            for (let i = 10; i <= 1000; i += 10) {
                const priceItem = prices.find(p => p.quantity === i);
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${i} ชิ้น: <input type="number" data-quantity="${i}" value="${priceItem ? priceItem.price : ''}" placeholder="ราคา (บาท)"></label>`;
                perPiecePriceForm.appendChild(div);
            }
            perPiecePriceModal.style.display = 'flex';
        });
        document.getElementById('close-per-piece-price-modal-btn').addEventListener('click', () => perPiecePriceModal.style.display = 'none');
        document.getElementById('save-per-piece-price-btn').addEventListener('click', async () => {
            const category = appData.categories.find(c => c.id === editingCategoryId);
            const newPrices = [];
            perPiecePriceForm.querySelectorAll('input').forEach(input => {
                const quantity = parseInt(input.dataset.quantity);
                const price = parseInt(input.value);
                if (price > 0) newPrices.push({ quantity, price });
            });
            category.perPiecePrices = newPrices;
            await saveState();
            renderAdminCategories();
            perPiecePriceModal.style.display = 'none';
            alert('บันทึกราคาต่อชิ้นเรียบร้อยแล้ว');
        });

        const renderSubAdmins = () => {
            const list = document.getElementById('sub-admin-list');
            list.innerHTML = '';
            if (appData.subAdmins.length === 0) list.innerHTML = '<tr><td colspan="3">ยังไม่มีผู้ใช้ย่อย</td></tr>';
            else {
                appData.subAdmins.forEach(sa => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${sa.name}</td><td>${sa.pin}</td><td><button class="btn btn-secondary btn-small btn-sub-admin-edit" data-id="${sa.id}">แก้ไข</button><button class="btn btn-danger btn-small btn-sub-admin-delete" data-id="${sa.id}">ลบ</button></td>`;
                    list.appendChild(row);
                });
            }
        };

        const subAdminForm = document.getElementById('sub-admin-form');
        subAdminForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('sub-admin-name').value.trim();
            const pin = document.getElementById('sub-admin-pin').value;
            if (pin.length < 4) { alert('PIN ต้องมีอย่างน้อย 4 ตัวอักษร'); return; }
            if (editingSubAdminId) {
                const subAdmin = appData.subAdmins.find(sa => sa.id === editingSubAdminId);
                if (subAdmin) {
                     if (appData.subAdmins.find(sa => sa.pin === pin && sa.id !== editingSubAdminId)) { alert('PIN นี้มีผู้ใช้งานอื่นแล้ว'); return; }
                    subAdmin.name = name;
                    subAdmin.pin = pin;
                }
            } else {
                if (appData.subAdmins.length >= 20) { alert('ไม่สามารถเพิ่มผู้ใช้ย่อยได้เกิน 20 คน'); return; }
                if (appData.subAdmins.find(sa => sa.pin === pin)) { alert('PIN นี้มีผู้ใช้งานแล้ว'); return; }
                const newSubAdmin = { id: generateId(), name, pin, permissions: {'admin': true, 'stock': true, 'order-number': true, 'dashboard': true, 'manage-account': true} };
                appData.subAdmins.push(newSubAdmin);
            }
            await saveState();
            resetSubAdminForm();
            renderSubAdmins();
            alert('บันทึกข้อมูลผู้ใช้ย่อยเรียบร้อยแล้ว');
        });

        const resetSubAdminForm = () => {
            editingSubAdminId = null;
            subAdminForm.reset();
            document.getElementById('add-sub-admin-btn').textContent = translations[appData.shopSettings.language].addUserBtn;
            document.getElementById('cancel-sub-admin-edit').style.display = 'none';
        };

        document.getElementById('cancel-sub-admin-edit').addEventListener('click', resetSubAdminForm);

        document.getElementById('sub-admin-list').addEventListener('click', async (e) => {
            const id = parseInt(e.target.dataset.id);
            if (e.target.classList.contains('btn-sub-admin-edit')) {
                const subAdmin = appData.subAdmins.find(sa => sa.id === id);
                if (subAdmin) {
                    editingSubAdminId = id;
                    document.getElementById('sub-admin-name').value = subAdmin.name;
                    document.getElementById('sub-admin-pin').value = subAdmin.pin;
                    document.getElementById('add-sub-admin-btn').textContent = translations[appData.shopSettings.language].saveBtn;
                    document.getElementById('cancel-sub-admin-edit').style.display = 'inline-block';
                }
            }
            if (e.target.classList.contains('btn-sub-admin-delete')) {
                if (confirm('ยืนยันการลบผู้ใช้ย่อยนี้หรือไม่?')) {
                    appData.subAdmins = appData.subAdmins.filter(sa => sa.id !== id);
                    await saveState();
                    renderSubAdmins();
                }
            }
        });

        const permissionModal = document.getElementById('permission-modal');
        document.getElementById('view-permissions-btn').addEventListener('click', () => {
            if (appData.subAdmins.length === 0) { alert('ยังไม่มีผู้ใช้ย่อย'); return; }
            const permissionList = document.getElementById('permission-list');
            permissionList.innerHTML = '';
            const subAdmin = appData.subAdmins[0];
            if (!subAdmin) return;
            currentSubAdminPermissionsId = subAdmin.id;
            document.getElementById('permission-user-name').textContent = `ตั้งค่าสิทธิ์สำหรับ: ${subAdmin.name}`;
            const lang = appData.shopSettings.language;
            appData.menuOrder.forEach(key => {
                const translationKey = MENU_NAMES[key];
                const li = document.createElement('li');
                li.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;';
                li.innerHTML = `<span>${translations[lang][translationKey]}</span><label class="toggle-switch"><input type="checkbox" data-menu-key="${key}" ${subAdmin.permissions[key] ? 'checked' : ''}><span class="slider"></span></label>`;
                permissionList.appendChild(li);
            });
            permissionModal.style.display = 'flex';
        });
        
        document.getElementById('save-permissions-btn').addEventListener('click', async () => {
            const subAdmin = appData.subAdmins.find(sa => sa.id === currentSubAdminPermissionsId);
            if (subAdmin) {
                const newPermissions = {};
                document.getElementById('permission-list').querySelectorAll('input[type="checkbox"]').forEach(input => {
                    newPermissions[input.dataset.menuKey] = input.checked;
                });
                subAdmin.permissions = newPermissions;
                await saveState();
                permissionModal.style.display = 'none';
                alert('บันทึกสิทธิ์เรียบร้อยแล้ว');
                if (loggedInUser && loggedInUser.id === currentSubAdminPermissionsId) renderAdminPanel();
            }
        });

        document.getElementById('close-permission-modal-btn').addEventListener('click', () => permissionModal.style.display = 'none');

        const reorderMenuModal = document.getElementById('reorder-menu-modal');
        const renderReorderMenuModal = () => {
            const reorderMenuList = document.getElementById('reorder-menu-list');
            reorderMenuList.innerHTML = '';
            const lang = appData.shopSettings.language;
            appData.menuOrder.forEach(key => {
                const translationKey = MENU_NAMES[key];
                const li = document.createElement('li');
                li.textContent = translations[lang][translationKey];
                li.dataset.menu = key;
                li.draggable = true;
                li.classList.add('sortable');
                reorderMenuList.appendChild(li);
            });
            reorderMenuModal.style.display = 'flex';
            addDragDropListeners();
        };

        const addDragDropListeners = () => {
            const container = document.getElementById('reorder-menu-list');
            let draggedItem = null;
            container.querySelectorAll('.sortable').forEach(item => {
                item.addEventListener('dragstart', () => { draggedItem = item; setTimeout(() => item.classList.add('dragging'), 0); });
                item.addEventListener('dragend', () => { if(draggedItem) draggedItem.classList.remove('dragging'); draggedItem = null; });
            });
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = [...container.querySelectorAll('.sortable:not(.dragging)')].reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
                if (afterElement == null) container.appendChild(draggedItem);
                else container.insertBefore(draggedItem, afterElement);
            });
        };

        document.getElementById('save-menu-order-btn').addEventListener('click', async () => {
            appData.menuOrder = [...document.getElementById('reorder-menu-list').children].map(li => li.dataset.menu);
            await saveState();
            reorderMenuModal.style.display = 'none';
            renderAdminPanel();
            alert('บันทึกการจัดเรียงเมนูเรียบร้อยแล้ว');
        });

        document.getElementById('close-reorder-menu-modal-btn').addEventListener('click', () => reorderMenuModal.style.display = 'none');

        const generateOrderNumber = () => {
            const format = appData.shopSettings.orderNumberFormat;
            const counters = appData.shopSettings.orderNumberCounters;
            const now = new Date();
            let num = counters[format] || 1;
            counters[format] = num + 1;
            const pad = (n, width) => n.toString().padStart(width, '0');
            switch(format) {
                case 'format1': return `WHD${(now.getFullYear() + 543).toString().slice(-2)}/${pad(now.getMonth() + 1, 2)}/${pad(num, 4)}`;
                case 'format2': return `WHD-${now.getFullYear()}${pad(now.getMonth() + 1, 2)}${pad(now.getDate(), 2)}-${pad(num, 4)}`;
                default: return `WHD-${Math.floor(Math.random() * 90000) + 10000}`;
            }
        };

        const renderOrderNumberView = (dateRange = []) => {
            const activeList = document.getElementById('active-orders-list');
            const cancelledList = document.getElementById('cancelled-orders-list');
            activeList.innerHTML = '';
            cancelledList.innerHTML = '';
            const lang = appData.shopSettings.language;
            let orders = [...appData.analytics.orders];
            if (dateRange.length > 0) {
                const start = dateRange[0].setHours(0,0,0,0);
                const end = dateRange.length === 2 ? dateRange[1].setHours(23,59,59,999) : new Date(start).setHours(23,59,59,999);
                orders = orders.filter(o => { const orderDate = new Date(o.timestamp).getTime(); return orderDate >= start && orderDate <= end; });
            }
            orders.reverse().forEach(order => {
                const date = new Date(order.timestamp);
                const formattedDate = `${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH')}`;
                const row = document.createElement('tr');
                if (order.status === 'active') {
                    row.innerHTML = `<td>${order.id}</td><td>${formattedDate}</td><td>${order.total.toLocaleString()} บาท</td><td><button class="btn btn-info btn-small view-order-details" data-id="${order.id}">${translations[lang].viewDetailsBtn}</button><button class="btn btn-danger btn-small cancel-order" data-id="${order.id}">${translations[lang].cancelOrderBtn}</button></td>`;
                    activeList.appendChild(row);
                } else {
                    row.innerHTML = `<td>${order.id}</td><td>${formattedDate}</td><td>${order.total.toLocaleString()} บาท</td><td><button class="btn btn-info btn-small view-order-details" data-id="${order.id}">${translations[lang].viewDetailsBtn}</button></td>`;
                    cancelledList.appendChild(row);
                }
            });
            document.querySelectorAll('.view-order-details').forEach(btn => btn.addEventListener('click', (e) => viewOrderDetails(e.target.dataset.id)));
            document.querySelectorAll('.cancel-order').forEach(btn => btn.addEventListener('click', (e) => cancelOrder(e.target.dataset.id)));
        };

        const viewOrderDetails = (orderId) => {
            const order = appData.analytics.orders.find(o => o.id === orderId);
            if (!order) return;
            const originalCart = { ...appData.cart };
            appData.cart = order.items;
            orderDetails.textContent = createOrderSummaryText(order.id);
            appData.cart = originalCart;
            document.getElementById('order-modal-title').textContent = 'รายละเอียดออเดอร์';
            document.getElementById('order-modal-prompt').style.display = 'none';
            document.getElementById('copy-order-btn').style.display = 'none';
            orderModal.style.display = 'flex';
        };

        const cancelOrder = async (orderId) => {
            if (confirm(`คุณต้องการยกเลิกออเดอร์เลขที่ ${orderId} ใช่หรือไม่?`)) {
                const order = appData.analytics.orders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'cancelled';
                    await saveState();
                    renderOrderNumberView(orderDatePicker.selectedDates);
                }
            }
        };
        
        const init = async () => {
            await loadState();
            applyLoadingBackground();
            if (appData.categories.length > 0) {
                if (!appData.categories.find(c => c.id === activeCategoryId)) activeCategoryId = appData.categories[0].id;
                adminActiveCategoryId = activeCategoryId;
            } else { activeCategoryId = null; adminActiveCategoryId = null; }
            renderCustomerView();
            document.getElementById('loader-overlay').style.display = 'none';
        };

        init();
    });
    </script>
</body>
</html>
